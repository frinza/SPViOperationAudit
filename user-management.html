<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - SPVi Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration Manager -->
    <script src="config.js"></script>
    
    <!-- Session Manager -->
    <script src="session-manager.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="firebase-auth.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="styles/spvi-main.css">
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- Authentication Check Loading -->
    <div id="auth-loading" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 sm:px-6 py-4">
            <!-- Main Header Row -->
            <div class="flex justify-between items-center">
                <!-- Title Section -->
                <div class="flex-1 min-w-0">
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-900 truncate">üë®‚Äçüíº User Management</h1>
                    <p class="text-xs sm:text-sm text-slate-600 mt-1 hidden sm:block">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö SPVi Operations Audit Toolkit</p>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden lg:flex items-center gap-3">
                    <button 
                        onclick="refreshUsers()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                    <a 
                        href="admin-permission-manager.html" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                    </a>
                    <a 
                        href="dashboard.html" 
                        class="bg-slate-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-700 transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <div class="lg:hidden">
                    <button 
                        id="mobile-menu-btn"
                        onclick="toggleMobileMenu()"
                        class="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg transition-colors"
                    >
                        <svg id="menu-icon" class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        <svg id="close-icon" class="w-6 h-6 text-slate-700 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobile-menu" class="lg:hidden mt-4 border-t pt-4 hidden">
                <div class="space-y-3">
                    <button 
                        onclick="refreshUsers(); closeMobileMenu();" 
                        class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                    <a 
                        href="admin-permission-manager.html" 
                        class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                    </a>
                    <a 
                        href="dashboard.html" 
                        class="w-full bg-slate-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-slate-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </a>
                </div>
                <!-- Mobile Description -->
                <p class="text-xs text-slate-600 mt-4 px-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö SPVi Operations Audit Toolkit</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p class="text-2xl font-bold text-slate-900" id="total-users">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-600">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pending-users">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p class="text-2xl font-bold text-green-600" id="approved-users">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-600">Admin</p>
                        <p class="text-2xl font-bold text-red-600" id="admin-users">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Settings -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.350 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
            </h3>
            <div class="flex flex-wrap gap-4">
                <button 
                    onclick="showChangeAdminPasswordModal()" 
                    class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin
                </button>
                <button 
                    onclick="showPermissionManager()" 
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Manage Permissions
                </button>
                <button 
                    onclick="showAccountRestrictions()" 
                    class="bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700 transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    Account Restrictions
                </button>
                <button 
                    onclick="showSessionAnalytics()" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Session Analytics
                </button>
                <div class="text-sm text-slate-600 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                </div>
            </div>
        </div>

        <!-- Online Users Monitoring -->
        <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6 mb-8">
            <!-- Header Section - Mobile Optimized -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                <div class="flex-1 min-w-0">
                    <h3 class="text-lg sm:text-xl font-semibold text-slate-900 flex items-center gap-2 flex-wrap">
                        <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <span class="truncate">Online Users Monitor</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800" id="online-count-badge">
                            1 online
                        </span>
                    </h3>
                    <p class="text-xs sm:text-sm text-slate-600 mt-1">Real-time monitoring of active user sessions</p>
                </div>
                
                <!-- Desktop Controls -->
                <div class="hidden sm:flex gap-2">
                    <button 
                        onclick="refreshOnlineUsers()" 
                        class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors flex items-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span class="hidden md:inline">Refresh</span>
                    </button>
                    <button 
                        onclick="forceLogoutAllUsers()" 
                        class="bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors flex items-center gap-2"
                        title="Force logout all non-admin users"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span class="hidden md:inline">Force Logout All</span>
                    </button>
                </div>

                <!-- Mobile Controls -->
                <div class="flex sm:hidden gap-2">
                    <button 
                        onclick="refreshOnlineUsers()" 
                        class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh
                    </button>
                    <button 
                        onclick="forceLogoutAllUsers()" 
                        class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                        title="Force logout all non-admin users"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Force Logout All
                    </button>
                </div>
            </div>
            
            <!-- Content Grid - Mobile Responsive -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Online Users List -->
                <div class="lg:col-span-2 order-2 lg:order-1">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4 mb-4">
                        <h4 class="font-medium text-slate-900">Currently Online</h4>
                        <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-500">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="hidden sm:inline">Auto-refresh: 10s</span>
                            <span class="sm:hidden">Auto: 10s</span>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg border max-h-64 sm:max-h-80 overflow-y-auto" id="online-users-list">
                        <div class="flex items-center justify-center py-12">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p class="text-slate-500">Loading online users...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats - Mobile First -->
                <div class="space-y-3 sm:space-y-4 order-1 lg:order-2">
                    <h4 class="font-medium text-slate-900">Session Statistics</h4>
                    <!-- Mobile: 2x2 Grid, Desktop: Vertical Stack -->
                    <div class="grid grid-cols-2 gap-3 sm:grid-cols-1 sm:space-y-3 sm:gap-0">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <div class="text-xs text-blue-600 font-medium">Active Sessions</div>
                            <div class="text-lg font-bold text-blue-900" id="active-sessions-stat">0</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="text-xs text-green-600 font-medium">Users Online</div>
                            <div class="text-lg font-bold text-green-900" id="users-online-stat">0</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-3">
                            <div class="text-xs text-yellow-600 font-medium truncate">Avg Session</div>
                            <div class="text-lg font-bold text-yellow-900" id="avg-session-time-stat">0m</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3">
                            <div class="text-xs text-red-600 font-medium truncate">Long Sessions</div>
                            <div class="text-lg font-bold text-red-900" id="long-sessions-stat">0</div>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-slate-200">
                        <button 
                            onclick="exportSessionReport()" 
                            class="w-full bg-slate-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Management Section -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Session Management
                    </h3>
                    <p class="text-sm text-slate-600">Monitor and configure user session settings</p>
                </div>
                <button 
                    onclick="refreshSessionInfo()" 
                    class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"
                >
                    Refresh
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Current Session Info -->
                <div class="space-y-4">
                    <h4 class="font-medium text-slate-900">Current Session Information</h4>
                    <div class="bg-slate-50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Session ID:</span>
                            <span class="text-sm font-mono text-slate-900" id="current-session-id">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Session Age:</span>
                            <span class="text-sm text-slate-900" id="session-age">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Time Since Activity:</span>
                            <span class="text-sm text-slate-900" id="time-since-activity">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Remaining Time:</span>
                            <span class="text-sm font-medium text-green-600" id="remaining-time">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Warning Status:</span>
                            <span class="text-sm" id="warning-status">
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Active</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Session Configuration -->
                <div class="space-y-4">
                    <h4 class="font-medium text-slate-900">Session Configuration</h4>
                    <div class="bg-slate-50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Inactivity Timeout:</span>
                            <span class="text-sm text-slate-900" id="config-inactivity">30 minutes</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Maximum Duration:</span>
                            <span class="text-sm text-slate-900" id="config-max-duration">8 hours</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Warning Time:</span>
                            <span class="text-sm text-slate-900" id="config-warning-time">5 minutes</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-slate-600">Check Interval:</span>
                            <span class="text-sm text-slate-900" id="config-check-interval">30 seconds</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button 
                            onclick="testSessionTimeout()" 
                            class="flex-1 bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors"
                        >
                            Test Timeout
                        </button>
                        <button 
                            onclick="extendAllSessions()" 
                            class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors"
                        >
                            Extend Session
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Admin Control Panel -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Advanced Admin Controls
                    </h3>
                    <p class="text-sm text-slate-600">Manage online sessions, permissions, and security settings</p>
                </div>
                <button 
                    onclick="refreshOnlineUsers()" 
                    class="bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors"
                >
                    Refresh Online Users
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Online Users -->
                <div class="space-y-4">
                    <h4 class="font-medium text-slate-900">Online Users</h4>
                    <div class="bg-slate-50 rounded-lg p-4 max-h-64 overflow-y-auto" id="admin-online-users-list">
                        <div class="text-center text-slate-500 py-4">
                            <svg class="w-8 h-8 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Click refresh to load online users
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="space-y-4">
                    <h4 class="font-medium text-slate-900">Quick Actions</h4>
                    <div class="space-y-3">
                        <button 
                            onclick="showPermissionManager()" 
                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            Manage Tool Permissions
                        </button>
                        <button 
                            onclick="showAccountRestrictions()" 
                            class="w-full bg-yellow-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-yellow-700 transition-colors flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            Account Restrictions
                        </button>
                        <button 
                            onclick="showSessionAnalytics()" 
                            class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Session Analytics
                        </button>
                        <button 
                            onclick="forceLogoutAllUsers()" 
                            class="w-full bg-red-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            Force Logout All Users
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duplicate Users Utilities -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8" id="duplicate-users-utilities">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Duplicate Users
                </h3>
                <div class="flex gap-2">
                    <button onclick="scanDuplicates()" class="bg-amber-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">Scan</button>
                    <button onclick="dedupeDuplicates()" class="bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors" title="Remove duplicates keeping oldest record">Dedupe</button>
                </div>
            </div>
            <div id="duplicates-result" class="text-sm text-slate-600">
                <p class="text-slate-500">Use Scan to find users with the same email. Use Dedupe to keep oldest and remove the rest.</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="status-filter" class="border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                    </select>
                </div>
                <div>
                    <label for="role-filter" class="block text-sm font-medium text-slate-700 mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="role-filter" class="border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label for="search-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•, ‡πÅ‡∏ú‡∏ô‡∏Å..."
                        class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-64"
                    >
                </div>
                <div class="flex items-end">
                    <button 
                        onclick="applyFilters()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors"
                    >
                        ‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                </div>
            </div>
        </div>

        <!-- Users List -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-6 border-b">
                <h2 class="text-lg font-semibold text-slate-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            </div>
            <div id="users-container" class="p-6">
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-slate-900">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                    <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="edit-user-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label for="edit-name" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="edit-name" required class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="edit-email" class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="edit-email" required class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="edit-department" class="block text-sm font-medium text-slate-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ù‡πà‡∏≤‡∏¢</label>
                    <input type="text" id="edit-department" required class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="edit-position" class="block text-sm font-medium text-slate-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                    <input type="text" id="edit-position" required class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="edit-status" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="edit-status" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                        <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                    </select>
                </div>
                <div>
                    <label for="edit-role" class="block text-sm font-medium text-slate-700 mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="edit-role" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors"
                    >
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                    <button 
                        type="button" 
                        onclick="closeEditModal()" 
                        class="flex-1 bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="modal">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-slate-900">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                    <button onclick="closePasswordModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="password-form" class="p-6 space-y-4">
                <input type="hidden" id="password-user-id">
                <div>
                    <p class="text-sm text-slate-600 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <span id="password-user-name" class="font-medium"></span></p>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="new-password" required minlength="6" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-slate-700 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="confirm-password" required minlength="6" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                </div>
                <div class="flex gap-3 pt-4">
                    <button 
                        type="submit" 
                        class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors"
                    >
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                    </button>
                    <button 
                        type="button" 
                        onclick="closePasswordModal()" 
                        class="flex-1 bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Admin Password Modal -->
    <div id="admin-password-modal" class="modal">
        <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-slate-900">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin</h3>
                <button onclick="closeAdminPasswordModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form onsubmit="changeAdminPassword(event)" class="space-y-4">
                <div>
                    <label for="current-admin-password" class="block text-sm font-medium text-slate-700 mb-1">
                        ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </label>
                    <input 
                        type="password" 
                        id="current-admin-password" 
                        required 
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none"
                        placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
                    >
                </div>
                <div>
                    <label for="new-admin-password" class="block text-sm font-medium text-slate-700 mb-1">
                        ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </label>
                    <input 
                        type="password" 
                        id="new-admin-password" 
                        required 
                        minlength="6"
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none"
                        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"
                    >
                </div>
                <div>
                    <label for="confirm-admin-password" class="block text-sm font-medium text-slate-700 mb-1">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </label>
                    <input 
                        type="password" 
                        id="confirm-admin-password" 
                        required 
                        minlength="6"
                        class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none"
                        placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"
                    >
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-400 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-yellow-800">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                            <p class="text-sm text-yellow-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button 
                        type="submit" 
                        class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors"
                    >
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                    </button>
                    <button 
                        type="button"
                        onclick="closeAdminPasswordModal()"
                        class="flex-1 bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Permission Manager Modal -->
    <div id="permission-modal" class="modal">
        <div class="bg-white p-6 rounded-xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-slate-900">Manage Tool Permissions</h3>
                <button onclick="closePermissionModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label for="permission-user-select" class="block text-sm font-medium text-slate-700 mb-2">Select User</label>
                <select id="permission-user-select" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                    <option value="">Choose a user...</option>
                </select>
            </div>
            
            <div id="permission-controls" class="hidden">
                <h4 class="font-medium text-slate-900 mb-4">Tool Access Permissions</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-stockCount" class="rounded mr-3">
                            <span class="text-sm">Stock Count</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-cashControl" class="rounded mr-3">
                            <span class="text-sm">Cash Control</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-checklist" class="rounded mr-3">
                            <span class="text-sm">Checklist</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-riskAnalyzer" class="rounded mr-3">
                            <span class="text-sm">Risk Analyzer</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-smcoCheck" class="rounded mr-3">
                            <span class="text-sm">SMCO Check</span>
                        </label>
                        <!-- Added CN Fraud Checker permission -->
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-cnCheck" class="rounded mr-3">
                            <span class="text-sm">CN Fraud Checker</span>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-auditCalendar" class="rounded mr-3">
                            <span class="text-sm">Audit Calendar</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-reportComparison" class="rounded mr-3">
                            <span class="text-sm">Report Comparison</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-issueTracker" class="rounded mr-3">
                            <span class="text-sm">Issue Tracker</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm-userManagement" class="rounded mr-3" disabled>
                            <span class="text-sm text-slate-500">User Management (Admin Only)</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="savePermissions()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Save Permissions
                    </button>
                    <button onclick="closePermissionModal()" class="flex-1 bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Restrictions Modal -->
    <div id="restrictions-modal" class="modal">
        <div class="bg-white p-6 rounded-xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-slate-900">Account Restrictions</h3>
                <button onclick="closeRestrictionsModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label for="restriction-user-select" class="block text-sm font-medium text-slate-700 mb-2">Select User</label>
                <select id="restriction-user-select" class="w-full border border-slate-300 rounded-lg px-3 py-2">
                    <option value="">Choose a user...</option>
                </select>
            </div>
            
            <div id="restriction-controls" class="hidden space-y-6">
                <div>
                    <h4 class="font-medium text-slate-900 mb-3">Account Status</h4>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="account-locked" class="rounded mr-3">
                            <span class="text-sm">Lock Account</span>
                        </label>
                        <div class="ml-6 hidden" id="lock-reason-container">
                            <input type="text" id="lock-reason" placeholder="Reason for locking account" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-slate-900 mb-3">IP Address Restrictions</h4>
                    <div class="space-y-3">
                        <textarea id="allowed-ips" placeholder="Enter allowed IP addresses (one per line, leave empty for no restrictions)" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" rows="4"></textarea>
                        <p class="text-xs text-slate-500">Example: 192.168.1.100</p>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-slate-900 mb-3">Session Management</h4>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between">
                            <span class="text-sm">Max Concurrent Sessions</span>
                            <input type="number" id="max-sessions" min="1" max="5" value="1" class="border border-slate-300 rounded px-2 py-1 text-sm w-20">
                        </label>
                        <button onclick="disconnectUserSessions()" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">
                            Disconnect All User Sessions
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveRestrictions()" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-yellow-700 transition-colors">
                        Save Restrictions
                    </button>
                    <button onclick="closeRestrictionsModal()" class="flex-1 bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Analytics Modal -->
    <div id="analytics-modal" class="modal">
        <div class="bg-white p-6 rounded-xl max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-slate-900">Session Analytics</h3>
                <button onclick="closeAnalyticsModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900">Active Sessions</h4>
                    <p class="text-2xl font-bold text-blue-600" id="active-sessions-count">0</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-medium text-green-900">Avg Session Duration</h4>
                    <p class="text-2xl font-bold text-green-600" id="avg-session-duration">0m</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <h4 class="font-medium text-yellow-900">Today's Logins</h4>
                    <p class="text-2xl font-bold text-yellow-600" id="today-logins">0</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-medium text-red-900">Force Logouts</h4>
                    <p class="text-2xl font-bold text-red-600" id="force-logouts">0</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <h4 class="font-medium text-slate-900">Recent Activity</h4>
                <div class="bg-slate-50 rounded-lg p-4 max-h-64 overflow-y-auto" id="recent-activity">
                    <div class="text-center text-slate-500 py-8">
                        <svg class="w-8 h-8 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Loading activity data...
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeAnalyticsModal()" class="bg-slate-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-slate-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let filteredUsers = [];

        // Toast notification - Updated to match login page template
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            
            // Remove any existing toasts
            const existingToasts = toastContainer.querySelectorAll('.spvi-toast');
            existingToasts.forEach(existingToast => {
                existingToast.classList.remove('show');
                setTimeout(() => {
                    if (existingToast.parentNode) {
                        existingToast.remove();
                    }
                }, 300);
            });
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `spvi-toast ${type}`;
            
            // Add icon based on type
            const icon = getToastIcon(type);
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 mr-3">
                        ${icon}
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                </div>
            `;
            
            // Add new toast after a small delay to ensure previous ones are removed
            setTimeout(() => {
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
            }, 350);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 4350);
        }

        function getToastIcon(type) {
            const icons = {
                'success': `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>`,
                'error': `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>`,
                'warning': `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>`,
                'info': `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>`
            };
            return icons[type] || icons['info'];
        }

        // Check admin access - async version to properly wait for session restoration
        async function checkAdminAccess() {
            try {
                // Wait for authentication system to restore session if needed
                const isAuthenticated = await SPViAuth.checkAuthentication();
                if (!isAuthenticated) {
                    document.getElementById('auth-loading').style.display = 'none';
                    showToast('Access denied. Please log in first.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return false;
                }

                const currentUser = SPViAuth.getCurrentUser();
                if (!currentUser || currentUser.role !== 'admin' || currentUser.status !== 'approved') {
                    document.getElementById('auth-loading').style.display = 'none';
                    showToast('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return false;
                }
                
                // Hide loading screen on success
                document.getElementById('auth-loading').style.display = 'none';
                return true;
            } catch (error) {
                console.error('Error checking admin access:', error);
                document.getElementById('auth-loading').style.display = 'none';
                showToast('Authentication error. Please try logging in again.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return false;
            }
        }

        // Load all users
        async function loadUsers() {
            try {
                allUsers = await SPViAuth.getAllUsers();
                filteredUsers = [...allUsers];
                updateStats();
                renderUsers();
            } catch (error) {
                // Error loading users handled silently for production
                showToast('Error loading users: ' + error.message, 'error');
            }
        }

        // Update statistics
        function updateStats() {
            const total = allUsers.length;
            const pending = allUsers.filter(u => u.status === 'pending').length;
            const approved = allUsers.filter(u => u.status === 'approved').length;
            const admins = allUsers.filter(u => u.role === 'admin').length;

            document.getElementById('total-users').textContent = total;
            document.getElementById('pending-users').textContent = pending;
            document.getElementById('approved-users').textContent = approved;
            document.getElementById('admin-users').textContent = admins;
        }

        // Render users list
        function renderUsers() {
            const container = document.getElementById('users-container');
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-12 h-12 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <p class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                    </div>
                `;
                return;
            }

            const usersHTML = filteredUsers.map(user => `
                <div class="user-card bg-slate-50 rounded-lg p-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="font-semibold text-slate-900">${user.name}</h3>
                                <span class="role-badge role-${user.role}">${user.role.toUpperCase()}</span>
                            </div>
                            <p class="text-sm text-slate-600">${user.email}</p>
                            <p class="text-sm text-slate-500">${user.department} - ${user.position}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-slate-500">
                                <span>‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date(user.createdAt).toLocaleDateString('th-TH')}</span>
                                ${user.lastLogin ? `<span>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(user.lastLogin).toLocaleDateString('th-TH')}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="status-badge status-${user.status}">
                                ${user.status === 'pending' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 
                                  user.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-3 border-t">
                        ${user.status === 'pending' ? `
                            <button 
                                onclick="updateUserStatus('${user.id}', 'approved')" 
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors"
                            >
                                ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                            </button>
                            <button 
                                onclick="updateUserStatus('${user.id}', 'rejected')" 
                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors"
                            >
                                ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                            </button>
                        ` : ''}
                        
                        <button 
                            onclick="editUser('${user.id}')" 
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors"
                        >
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        
                        <button 
                            onclick="changePassword('${user.id}')" 
                            class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors"
                        >
                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™
                        </button>
                        
                        ${user.role !== 'admin' || allUsers.filter(u => u.role === 'admin').length > 1 ? `
                            <button 
                                onclick="deleteUser('${user.id}')" 
                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors"
                            >
                                ‡∏•‡∏ö
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="grid gap-4">${usersHTML}</div>`;
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const roleFilter = document.getElementById('role-filter').value;
            const searchQuery = document.getElementById('search-input').value.toLowerCase();

            filteredUsers = allUsers.filter(user => {
                const matchesStatus = !statusFilter || user.status === statusFilter;
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesSearch = !searchQuery || 
                    user.name.toLowerCase().includes(searchQuery) ||
                    user.email.toLowerCase().includes(searchQuery) ||
                    user.department.toLowerCase().includes(searchQuery) ||
                    user.position.toLowerCase().includes(searchQuery);

                return matchesStatus && matchesRole && matchesSearch;
            });

            renderUsers();
        }

        // Update user status
        async function updateUserStatus(userId, status) {
            try {
                const updatedUser = await SPViAuth.updateUser(userId, { status });
                showToast(`User status updated to ${status}`, 'success');
                await refreshUsers();
                
                // Refresh navigation bar if current user was updated
                const currentUser = SPViAuth.getCurrentUser();
                if (currentUser && currentUser.id === userId) {
                    await SPViAuth.updateCurrentUserData(userId);
                }
            } catch (error) {
                // Error updating user status handled silently for production
                showToast('Error updating user status: ' + error.message, 'error');
            }
        }

        // Edit user
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-department').value = user.department;
            document.getElementById('edit-position').value = user.position;
            document.getElementById('edit-status').value = user.status;
            document.getElementById('edit-role').value = user.role;

            document.getElementById('edit-user-modal').classList.add('show');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-user-modal').classList.remove('show');
        }

        // Handle edit form submission
        document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const updates = {
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                department: document.getElementById('edit-department').value,
                position: document.getElementById('edit-position').value,
                status: document.getElementById('edit-status').value,
                role: document.getElementById('edit-role').value
            };

            try {
                const updatedUser = await SPViAuth.updateUser(userId, updates);
                if (updates.role !== allUsers.find(u => u.id === userId).role) {
                    await SPViAuth.updateUserRole(userId, updates.role);
                }
                showToast('User updated successfully', 'success');
                closeEditModal();
                await refreshUsers();
                
                // Refresh navigation bar if current user was updated
                const currentUser = SPViAuth.getCurrentUser();
                if (currentUser && currentUser.id === userId) {
                    await SPViAuth.updateCurrentUserData(userId);
                }
            } catch (error) {
                // Error updating user handled silently for production
                showToast('Error updating user: ' + error.message, 'error');
            }
        });

        // Change password
        function changePassword(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('password-user-id').value = user.id;
            document.getElementById('password-user-name').textContent = user.name;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';

            document.getElementById('password-modal').classList.add('show');
        }

        // Close password modal
        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('show');
        }

        // Handle password form submission
        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('password-user-id').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            try {
                await SPViAuth.updateUserPassword(userId, newPassword);
                showToast('Password updated successfully', 'success');
                closePasswordModal();
            } catch (error) {
                // Error updating password handled silently for production
                showToast('Error updating password: ' + error.message, 'error');
            }
        });

        // Show admin password change modal
        function showChangeAdminPasswordModal() {
            document.getElementById('current-admin-password').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('confirm-admin-password').value = '';
            document.getElementById('admin-password-modal').classList.add('show');
        }

        // Close admin password modal
        function closeAdminPasswordModal() {
            document.getElementById('admin-password-modal').classList.remove('show');
        }

        // Handle admin password change
        async function changeAdminPassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('current-admin-password').value;
            const newPassword = document.getElementById('new-admin-password').value;
            const confirmPassword = document.getElementById('confirm-admin-password').value;

            if (newPassword !== confirmPassword) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                return;
            }

            try {
                await SPViAuth.changeAdminPassword(currentPassword, newPassword);
                showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                closeAdminPasswordModal();
            } catch (error) {
                // Error changing admin password handled silently for production
                if (error.message.includes('Current password is incorrect')) {
                    showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                } else {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ' + error.message, 'error');
                }
            }
        }

        // Delete user
        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Are you sure you want to delete user: ${user.name}?`)) {
                return;
            }

            try {
                await SPViAuth.deleteUser(userId);
                showToast('User deleted successfully', 'success');
                await refreshUsers();
            } catch (error) {
                // Error deleting user handled silently for production
                showToast('Error deleting user: ' + error.message, 'error');
            }
        }

        // Refresh users
        async function refreshUsers() {
            await loadUsers();
            applyFilters();
        }

        // Session Management Functions
        function refreshSessionInfo() {
            if (!window.SPViSessionManager) {
                showToast('Session manager not available', 'error');
                return;
            }

            const sessionInfo = window.SPViSessionManager.getSessionInfo();
            const config = window.SPViSessionManager.getConfig();

            if (sessionInfo) {
                // Update session information display
                document.getElementById('current-session-id').textContent = sessionInfo.sessionId.substring(0, 16) + '...';
                document.getElementById('session-age').textContent = formatDuration(sessionInfo.sessionAge);
                document.getElementById('time-since-activity').textContent = formatDuration(sessionInfo.timeSinceActivity);
                document.getElementById('remaining-time').textContent = formatDuration(Math.max(0, sessionInfo.remainingTime));
                
                // Update warning status
                const warningElement = document.getElementById('warning-status');
                if (sessionInfo.warningShown) {
                    warningElement.innerHTML = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">Warning Active</span>';
                } else {
                    warningElement.innerHTML = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Active</span>';
                }
            } else {
                // No session data available
                document.getElementById('current-session-id').textContent = 'No active session';
                document.getElementById('session-age').textContent = '-';
                document.getElementById('time-since-activity').textContent = '-';
                document.getElementById('remaining-time').textContent = '-';
                document.getElementById('warning-status').innerHTML = '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">Inactive</span>';
            }

            // Update configuration display
            document.getElementById('config-inactivity').textContent = Math.floor(config.INACTIVITY_TIMEOUT / 60000) + ' minutes';
            document.getElementById('config-max-duration').textContent = Math.floor(config.MAX_SESSION_DURATION / 3600000) + ' hours';
            document.getElementById('config-warning-time').textContent = Math.floor(config.WARNING_TIME / 60000) + ' minutes';
            document.getElementById('config-check-interval').textContent = Math.floor(config.CHECK_INTERVAL / 1000) + ' seconds';
        }

        function formatDuration(milliseconds) {
            if (milliseconds < 0) return '0s';
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function testSessionTimeout() {
            if (!window.SPViSessionManager) {
                showToast('Session manager not available', 'error');
                return;
            }

            if (confirm('This will simulate a session timeout warning. Continue?')) {
                // Force show session warning for testing
                if (window.SPViSessionManager.showSessionWarning) {
                    window.SPViSessionManager.showSessionWarning();
                    showToast('Session timeout warning triggered', 'info');
                } else {
                    showToast('Session warning function not available', 'warning');
                }
            }
        }

        function extendAllSessions() {
            if (!window.SPViSessionManager) {
                showToast('Session manager not available', 'error');
                return;
            }

            try {
                window.SPViSessionManager.extendSession();
                showToast('Session extended successfully', 'success');
                refreshSessionInfo();
            } catch (error) {
                showToast('Failed to extend session: ' + error.message, 'error');
            }
        }

        // Auto-refresh session info every 10 seconds
        let sessionInfoInterval;
        function startSessionInfoAutoRefresh() {
            sessionInfoInterval = setInterval(refreshSessionInfo, 10000);
        }

        function stopSessionInfoAutoRefresh() {
            if (sessionInfoInterval) {
                clearInterval(sessionInfoInterval);
                sessionInfoInterval = null;
            }
        }

        // Add event listeners for filters
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('role-filter').addEventListener('change', applyFilters);
        document.getElementById('search-input').addEventListener('input', applyFilters);

        // Advanced Admin Functions

        // Online Users Management        
        async function refreshOnlineUsers() {
            try {
                const onlineUsers = await SPViAuth.getOnlineUsers();
                const container = document.getElementById('online-users-list');
                const adminContainer = document.getElementById('admin-online-users-list');
                
                // Update online count badge
                document.getElementById('online-count-badge').textContent = `${onlineUsers.length} online`;
                document.getElementById('users-online-stat').textContent = onlineUsers.length;
                document.getElementById('active-sessions-stat').textContent = onlineUsers.length;
                
                if (onlineUsers.length === 0) {
                    const emptyContent = `
                        <div class="text-center text-slate-500 py-8">
                            <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <p class="text-slate-500 font-medium">No users currently online</p>
                            <p class="text-xs text-slate-400 mt-1">Users will appear here when they log in</p>
                        </div>
                    `;
                    const adminEmptyContent = `
                        <div class="text-center text-slate-500 py-4">
                            <p class="text-sm font-medium">No users online</p>
                        </div>
                    `;
                    container.innerHTML = emptyContent;
                    if (adminContainer) adminContainer.innerHTML = adminEmptyContent;
                    updateSessionStats(onlineUsers);
                    return;
                }

                // Calculate session statistics
                updateSessionStats(onlineUsers);

                // Generate detailed HTML for main monitoring section
                const onlineHTML = onlineUsers.map(user => {
                    const sessionInfo = user.sessionInfo || {};
                    const loginTime = sessionInfo.loginTime ? new Date(sessionInfo.loginTime) : null;
                    const lastActivity = sessionInfo.lastActivity ? new Date(sessionInfo.lastActivity) : null;
                    const sessionDuration = loginTime ? Date.now() - loginTime.getTime() : 0;
                    const timeSinceActivity = lastActivity ? Date.now() - lastActivity.getTime() : 0;
                    
                    // Determine session status
                    let statusColor = 'green';
                    let statusText = 'Active';
                    if (timeSinceActivity > 30 * 60 * 1000) { // 30 minutes
                        statusColor = 'yellow';
                        statusText = 'Idle';
                    }
                    if (sessionDuration > 4 * 60 * 60 * 1000) { // 4 hours
                        statusColor = 'red';
                        statusText = 'Long Session';
                    }

                    return `
                        <div class="flex items-center justify-between p-4 border-b border-slate-200 last:border-b-0 hover:bg-white transition-colors">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                            ${user.name.charAt(0).toUpperCase()}
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <div class="flex items-center gap-2">
                                            <p class="font-medium text-slate-900 truncate">${user.name}</p>
                                            ${user.role === 'admin' ? 
                                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Admin</span>' : 
                                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">User</span>'
                                            }
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                                <div class="w-2 h-2 bg-${statusColor}-500 rounded-full mr-1"></div>
                                                ${statusText}
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-500 truncate">${user.email}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-xs text-slate-600 ml-11">
                                    <div>
                                        <span class="font-medium">Session:</span>
                                        <span>${formatDuration(sessionDuration)}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Last Activity:</span>
                                        <span>${lastActivity ? formatTimeAgo(lastActivity) : 'Unknown'}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">IP:</span>
                                        <span class="font-mono">${sessionInfo.ipAddress || 'Unknown'}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Session ID:</span>
                                        <span class="font-mono">${sessionInfo.sessionId ? sessionInfo.sessionId.substring(0, 8) + '...' : 'Unknown'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <button 
                                    onclick="disconnectUser('${user.id}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors flex items-center gap-1"
                                    title="Disconnect user session"
                                >
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    Disconnect
                                </button>
                                <button 
                                    onclick="viewUserDetails('${user.id}')" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors flex items-center gap-1"
                                    title="View user details"
                                >
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Generate simple HTML for admin controls section - just name and status dot
                const adminHTML = onlineUsers.map(user => {
                    const sessionInfo = user.sessionInfo || {};
                    const lastActivity = sessionInfo.lastActivity ? new Date(sessionInfo.lastActivity) : null;
                    const timeSinceActivity = lastActivity ? Date.now() - lastActivity.getTime() : 0;
                    
                    // Determine status color for dot
                    let statusColor = 'green';
                    if (timeSinceActivity > 30 * 60 * 1000) statusColor = 'yellow';
                    if (timeSinceActivity > 60 * 60 * 1000) statusColor = 'red';

                    return `
                        <div class="flex items-center justify-between py-2 px-3 hover:bg-slate-100 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 bg-${statusColor}-500 rounded-full"></div>
                                <span class="text-sm font-medium text-slate-900">${user.name}</span>
                                ${user.role === 'admin' ? 
                                    '<span class="text-xs text-red-600 font-semibold">ADMIN</span>' : ''
                                }
                            </div>
                        </div>
                    `;
                }).join('');

                // Update both containers with different layouts
                container.innerHTML = onlineHTML;
                if (adminContainer) adminContainer.innerHTML = adminHTML;
            } catch (error) {
                console.error('Error refreshing online users:', error);
                showToast('Error loading online users: ' + error.message, 'error');
                const errorContent = `
                    <div class="text-center text-red-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="font-medium">Error loading online users</p>
                        <p class="text-sm text-red-400 mt-1">Please check your connection and try again</p>
                    </div>
                `;
                const adminErrorContent = `
                    <div class="text-center text-red-500 py-4">
                        <p class="text-sm font-medium">Error loading users</p>
                    </div>
                `;
                document.getElementById('online-users-list').innerHTML = errorContent;
                const adminContainer = document.getElementById('admin-online-users-list');
                if (adminContainer) adminContainer.innerHTML = adminErrorContent;
            }
        }

        function updateSessionStats(onlineUsers) {
            const now = Date.now();
            let totalSessionTime = 0;
            let longSessions = 0;

            onlineUsers.forEach(user => {
                const sessionInfo = user.sessionInfo || {};
                const loginTime = sessionInfo.loginTime ? new Date(sessionInfo.loginTime).getTime() : now;
                const sessionDuration = now - loginTime;
                
                totalSessionTime += sessionDuration;
                
                if (sessionDuration > 4 * 60 * 60 * 1000) { // 4 hours
                    longSessions++;
                }
            });

            const avgSessionTime = onlineUsers.length > 0 ? totalSessionTime / onlineUsers.length : 0;
            
            document.getElementById('avg-session-time-stat').textContent = formatDuration(avgSessionTime);
            document.getElementById('long-sessions-stat').textContent = longSessions;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        async function disconnectUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Disconnect ${user.name} from their session?\n\nThis will immediately log them out.`)) {
                return;
            }

            try {
                await SPViAuth.disconnectUserSession(userId);
                showToast(`${user.name} has been disconnected`, 'success');
                setTimeout(refreshOnlineUsers, 1000); // Refresh after a short delay
            } catch (error) {
                console.error('Error disconnecting user:', error);
                showToast('Error disconnecting user: ' + error.message, 'error');
            }
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            // Find the user in the main users list and trigger edit
            editUser(userId);
        }

        async function forceLogoutAllUsers() {
            if (!confirm('This will force logout ALL users except admins. Are you sure?\n\nThis action cannot be undone and will immediately disconnect all non-admin users.')) {
                return;
            }

            try {
                const users = allUsers.filter(u => u.role !== 'admin' && u.status === 'approved');
                let disconnected = 0;
                let failed = 0;

                // Show progress
                const progressToast = showToast('Disconnecting users...', 'info');

                for (const user of users) {
                    try {
                        await SPViAuth.disconnectUserSession(user.id);
                        disconnected++;
                    } catch (error) {
                        console.warn('Failed to disconnect user:', user.name, error);
                        failed++;
                    }
                }

                if (failed === 0) {
                    showToast(`Successfully disconnected ${disconnected} users`, 'success');
                } else {
                    showToast(`Disconnected ${disconnected} users, ${failed} failed`, 'warning');
                }
                
                setTimeout(refreshOnlineUsers, 2000); // Refresh after delay
            } catch (error) {
                console.error('Error during mass logout:', error);
                showToast('Error during mass logout: ' + error.message, 'error');
            }
        }

        async function exportSessionReport() {
            try {
                const onlineUsers = await SPViAuth.getOnlineUsers();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                
                // Prepare CSV data
                const csvData = [
                    ['Name', 'Email', 'Role', 'Session Duration', 'Last Activity', 'IP Address', 'Session ID', 'Status'].join(',')
                ];

                onlineUsers.forEach(user => {
                    const sessionInfo = user.sessionInfo || {};
                    const loginTime = sessionInfo.loginTime ? new Date(sessionInfo.loginTime) : null;
                    const lastActivity = sessionInfo.lastActivity ? new Date(sessionInfo.lastActivity) : null;
                    const sessionDuration = loginTime ? Date.now() - loginTime.getTime() : 0;
                    const timeSinceActivity = lastActivity ? Date.now() - lastActivity.getTime() : 0;
                    
                    let status = 'Active';
                    if (timeSinceActivity > 30 * 60 * 1000) status = 'Idle';
                    if (sessionDuration > 4 * 60 * 60 * 1000) status = 'Long Session';

                    const row = [
                        `"${user.name}"`,
                        `"${user.email}"`,
                        user.role,
                        `"${formatDuration(sessionDuration)}"`,
                        lastActivity ? lastActivity.toLocaleString() : 'Unknown',
                        sessionInfo.ipAddress || 'Unknown',
                        sessionInfo.sessionId || 'Unknown',
                        status
                    ].join(',');
                    
                    csvData.push(row);
                });

                // Create and download CSV
                const csvContent = csvData.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `online-users-report-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Session report exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting session report:', error);
                showToast('Error exporting report: ' + error.message, 'error');
            }
        }

        // Auto-refresh online users
        let onlineUsersInterval;
        function startOnlineUsersAutoRefresh() {
            refreshOnlineUsers(); // Initial load
            onlineUsersInterval = setInterval(refreshOnlineUsers, 10000); // Refresh every 10 seconds
        }

        function stopOnlineUsersAutoRefresh() {
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
                onlineUsersInterval = null;
            }
        }

        // Permission Management
        function showPermissionManager() {
            const modal = document.getElementById('permission-modal');
            const userSelect = document.getElementById('permission-user-select');
            
            // Populate user dropdown
            userSelect.innerHTML = '<option value="">Choose a user...</option>';
            allUsers.filter(u => u.role !== 'admin').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email})`;
                userSelect.appendChild(option);
            });

            modal.classList.add('show');
        }

        function closePermissionModal() {
            document.getElementById('permission-modal').classList.remove('show');
            document.getElementById('permission-controls').classList.add('hidden');
        }

        // Handle user selection for permissions
        document.addEventListener('DOMContentLoaded', function() {
            const userSelect = document.getElementById('permission-user-select');
            const controls = document.getElementById('permission-controls');
            
            userSelect.addEventListener('change', function() {
                if (this.value) {
                    const user = allUsers.find(u => u.id === this.value);
                    if (user) {
                        loadUserPermissions(user);
                        controls.classList.remove('hidden');
                    }
                } else {
                    controls.classList.add('hidden');
                }
            });

            // Account lock checkbox handler
            const lockCheckbox = document.getElementById('account-locked');
            const reasonContainer = document.getElementById('lock-reason-container');
            
            lockCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    reasonContainer.classList.remove('hidden');
                } else {
                    reasonContainer.classList.add('hidden');
                }
            });
        });

        function loadUserPermissions(user) {
            const permissions = user.permissions || {};
            
            document.getElementById('perm-stockCount').checked = permissions.stockCount || false;
            document.getElementById('perm-cashControl').checked = permissions.cashControl || false;
            document.getElementById('perm-checklist').checked = permissions.checklist || false;
            document.getElementById('perm-riskAnalyzer').checked = permissions.riskAnalyzer || false;
            document.getElementById('perm-smcoCheck').checked = permissions.smcoCheck || false;
            // CN Fraud Checker
            const cnCheckBox = document.getElementById('perm-cnCheck');
            if (cnCheckBox) cnCheckBox.checked = permissions.cnCheck || false;
            document.getElementById('perm-auditCalendar').checked = permissions.auditCalendar || false;
            document.getElementById('perm-reportComparison').checked = permissions.reportComparison || false;
            document.getElementById('perm-issueTracker').checked = permissions.issueTracker || false;
        }

        async function savePermissions() {
            const userId = document.getElementById('permission-user-select').value;
            if (!userId) return;

            const permissions = {
                stockCount: document.getElementById('perm-stockCount').checked,
                cashControl: document.getElementById('perm-cashControl').checked,
                checklist: document.getElementById('perm-checklist').checked,
                riskAnalyzer: document.getElementById('perm-riskAnalyzer').checked,
                smcoCheck: document.getElementById('perm-smcoCheck').checked,
                // Include CN Fraud Checker
                cnCheck: document.getElementById('perm-cnCheck') ? document.getElementById('perm-cnCheck').checked : false,
                auditCalendar: document.getElementById('perm-auditCalendar').checked,
                reportComparison: document.getElementById('perm-reportComparison').checked,
                issueTracker: document.getElementById('perm-issueTracker').checked,
                userManagement: false // Always false for non-admins
            };

            try {
                await SPViAuth.updateUserPermissions(userId, permissions);
                showToast('Permissions updated successfully', 'success');
                closePermissionModal();
                await refreshUsers();
            } catch (error) {
                showToast('Error updating permissions: ' + error.message, 'error');
            }
        }

        // Account Restrictions
        function showAccountRestrictions() {
            const modal = document.getElementById('restrictions-modal');
            const userSelect = document.getElementById('restriction-user-select');
            
            // Populate user dropdown
            userSelect.innerHTML = '<option value="">Choose a user...</option>';
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email})`;
                userSelect.appendChild(option);
            });

            modal.classList.add('show');
        }

        function closeRestrictionsModal() {
            document.getElementById('restrictions-modal').classList.remove('show');
            document.getElementById('restriction-controls').classList.add('hidden');
        }

        // Handle user selection for restrictions
        document.addEventListener('DOMContentLoaded', function() {
            const userSelect = document.getElementById('restriction-user-select');
            const controls = document.getElementById('restriction-controls');
            
            userSelect.addEventListener('change', function() {
                if (this.value) {
                    const user = allUsers.find(u => u.id === this.value);
                    if (user) {
                        loadUserRestrictions(user);
                        controls.classList.remove('hidden');
                    }
                } else {
                    controls.classList.add('hidden');
                }
            });
        });

        function loadUserRestrictions(user) {
            const restrictions = user.restrictions || {};
            
            document.getElementById('account-locked').checked = restrictions.accountLocked || false;
            document.getElementById('lock-reason').value = restrictions.lockReason || '';
            document.getElementById('allowed-ips').value = (restrictions.allowedIPs || []).join('\n');
            document.getElementById('max-sessions').value = restrictions.maxConcurrentSessions || 1;
            
            // Show/hide lock reason container
            const reasonContainer = document.getElementById('lock-reason-container');
            if (restrictions.accountLocked) {
                reasonContainer.classList.remove('hidden');
            } else {
                reasonContainer.classList.add('hidden');
            }
        }

        async function saveRestrictions() {
            const userId = document.getElementById('restriction-user-select').value;
            if (!userId) return;

            const isLocked = document.getElementById('account-locked').checked;
            const lockReason = document.getElementById('lock-reason').value;
            const allowedIPsText = document.getElementById('allowed-ips').value;
            const maxSessions = parseInt(document.getElementById('max-sessions').value);

            const allowedIPs = allowedIPsText
                .split('\n')
                .map(ip => ip.trim())
                .filter(ip => ip.length > 0);

            try {
                // Update restrictions
                const restrictions = {
                    accountLocked: isLocked,
                    lockReason: isLocked ? lockReason : null,
                    allowedIPs: allowedIPs,
                    maxConcurrentSessions: maxSessions,
                    forceLogout: false
                };

                await SPViAuth.updateUser(userId, { restrictions });

                // If locking account, also disconnect sessions
                if (isLocked) {
                    await SPViAuth.lockUserAccount(userId, lockReason);
                } else {
                    await SPViAuth.unlockUserAccount(userId);
                }

                showToast('Account restrictions updated successfully', 'success');
                closeRestrictionsModal();
                await refreshUsers();
                await refreshOnlineUsers();
            } catch (error) {
                showToast('Error updating restrictions: ' + error.message, 'error');
            }
        }

        async function disconnectUserSessions() {
            const userId = document.getElementById('restriction-user-select').value;
            if (!userId) return;

            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Disconnect all sessions for ${user.name}?`)) {
                return;
            }

            try {
                await SPViAuth.disconnectUserSession(userId);
                showToast(`All sessions disconnected for ${user.name}`, 'success');
                await refreshOnlineUsers();
            } catch (error) {
                showToast('Error disconnecting sessions: ' + error.message, 'error');
            }
        }

        // Session Analytics
        function showSessionAnalytics() {
            const modal = document.getElementById('analytics-modal');
            modal.classList.add('show');
            loadSessionAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analytics-modal').classList.remove('show');
        }

        async function loadSessionAnalytics() {
            try {
                const onlineUsers = await SPViAuth.getOnlineUsers();
                
                // Update stats
                document.getElementById('active-sessions-count').textContent = onlineUsers.length;
                
                // Calculate average session duration (mock for now)
                const avgDuration = onlineUsers.length > 0 ? 45 : 0;
                document.getElementById('avg-session-duration').textContent = avgDuration + 'm';
                
                // Today's logins (mock)
                const todayLogins = allUsers.filter(u => {
                    if (!u.lastLogin) return false;
                    const loginDate = new Date(u.lastLogin);
                    const today = new Date();
                    return loginDate.toDateString() === today.toDateString();
                }).length;
                document.getElementById('today-logins').textContent = todayLogins;
                
                // Force logouts (mock)
                document.getElementById('force-logouts').textContent = '0';
                
                // Recent activity
                const recentActivity = document.getElementById('recent-activity');
                const activityHTML = onlineUsers.map(user => `
                    <div class="flex items-center justify-between py-2 border-b border-slate-200 last:border-b-0">
                        <div>
                            <span class="font-medium text-sm">${user.name}</span>
                            <span class="text-xs text-slate-500 ml-2">Active session</span>
                        </div>
                        <div class="text-xs text-slate-400">
                            ${user.sessionInfo?.lastActivity ? new Date(user.sessionInfo.lastActivity).toLocaleString() : 'Unknown'}
                        </div>
                    </div>
                `).join('');
                
                if (activityHTML) {
                    recentActivity.innerHTML = activityHTML;
                } else {
                    recentActivity.innerHTML = `
                        <div class="text-center text-slate-500 py-8">
                            No recent activity
                        </div>
                    `;
                }
            } catch (error) {
                showToast('Error loading analytics: ' + error.message, 'error');
            }
        }

        // Duplicate Users Utilities
        async function scanDuplicates() {
            try {
                const results = await SPViAuth.findDuplicateUsers();
                const container = document.getElementById('duplicates-result');
                if (!results || results.length === 0) {
                    container.innerHTML = '<div class="text-green-600">No duplicate users found.</div>';
                    return;
                }
                container.innerHTML = `
                    <div class="space-y-3">
                        ${results.map(r => `
                            <div class="border rounded p-3">
                                <div class="font-medium text-slate-900">${r.email}</div>
                                <ul class="list-disc ml-6 mt-1">
                                    ${r.users.map(u => `<li>ID: <code>${u.id}</code> ‚Ä¢ Name: ${u.name} ‚Ä¢ Created: ${u.createdAt || 'N/A'}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                showToast('Error scanning duplicates: ' + e.message, 'error');
            }
        }

        async function dedupeDuplicates() {
            if (!confirm('Proceed to remove duplicate user records by email? Oldest will be kept. This cannot be undone.')) return;
            try {
                const res = await SPViAuth.deduplicateUsers('keepOldest');
                showToast('Deduplication complete: ' + res.length + ' email groups processed', 'success');
                await refreshUsers();
                await scanDuplicates();
            } catch (e) {
                showToast('Error during deduplication: ' + e.message, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for admin access check to complete
            const hasAdminAccess = await checkAdminAccess();
            if (!hasAdminAccess) return;

            try {
                await SPViAuth.initializeFirebase();
                await loadUsers();
                
                // Initialize session management display
                setTimeout(() => {
                    refreshSessionInfo();
                    startSessionInfoAutoRefresh();
                    
                    // Initialize online users monitoring
                    startOnlineUsersAutoRefresh();
                }, 1000);
            } catch (error) {
                // Initialization error handled silently for production
                showToast('Failed to initialize. Please check Firebase configuration.', 'error');
            }
        });

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                menuIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
            } else {
                mobileMenu.classList.add('hidden');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');
            
            mobileMenu.classList.add('hidden');
            menuIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            
            if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                closeMobileMenu();
            }
        });

        // Close mobile menu on window resize if it becomes desktop size
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) { // lg breakpoint
                closeMobileMenu();
            }
        });

        // Cleanup intervals when page unloads
        window.addEventListener('beforeunload', function() {
            stopSessionInfoAutoRefresh();
            stopOnlineUsersAutoRefresh();
        });
    </script>

</body>
</html>
