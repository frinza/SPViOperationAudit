<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ปฏิทินแผนการตรวจสอบ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .calendar-iframe {
            border: 1px solid #e2e8f0;
        }
        .event-item {
            border-left: 4px solid #3b82f6;
        }
        .event-tracker-item {
            transition: all 0.3s ease;
        }
        .event-tracker-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn:hover {
            transform: translateY(-1px);
        }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Firebase will be initialized by the main firebase-auth.js
        let db;

        async function initFirebaseIfNeeded() {
            if (db) return db;
            try {
                // Use the Firebase instance from SPViAuth
                await SPViAuth.initializeFirebase();
                
                // Get Firebase instance from window.firebase (already initialized)
                if (window.firebase && window.firebase.apps.length > 0) {
                    db = window.firebase.firestore();
                    return db;
                } else {
                    throw new Error('Firebase not initialized by SPViAuth');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
                const errorHtml = `<div class="text-center p-4 max-w-2xl mx-auto bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                    <p class="font-bold">Firebase Connection Error</p>
                    <p>${error.message}</p>
                    <p class="text-sm mt-2">Please check your internet connection and Firebase permissions.</p>
                </div>`;
                const errorDisplay = document.getElementById('error-display-tracker') || document.getElementById('error-display-event');
                if (errorDisplay) {
                    errorDisplay.innerHTML = errorHtml;
                }
                throw error;
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">ปฏิทินแผนการตรวจสอบ</h1>
            <p class="mt-2 text-slate-500">ฝ่าย Operation Audit</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendar View Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <iframe 
                        src="https://calendar.google.com/calendar/embed?src=operation.audit.spvi%40gmail.com&ctz=Asia%2FBangkok" 
                        class="w-full h-[75vh] rounded-lg calendar-iframe"
                        frameborder="0"
                        scrolling="no">
                    </iframe>
                </div>
            </div>

            <!-- Event List Section -->
            <div class="lg:col-span-1">
                 <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">รายการในวันนี้</h2>
                    <div id="event-list-container" class="w-full min-h-[75vh] max-h-[75vh] overflow-y-auto">
                        <!-- JS will populate this -->
                    </div>
                </div>
            </div>
        </div>

        <!-- =================== NEW EVENT TRACKER =================== -->
        <div class="w-full mb-8 mt-12">
            <div id="error-display-tracker" class="mb-6"></div>
            
            <!-- Current Quarter View -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-900 mb-2"><span id="current-quarter-display"></span></h2>
                    <p class="text-slate-500">กิจกรรมในไตรมาสปัจจุบัน (จนถึงวันนี้)</p>
                </div>
                <div id="quarter-events-container" class="space-y-4">
                    <!-- Quarter's events will be populated here -->
                </div>
            </div>

            <!-- Summary Dashboard -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 relative">
                <button id="toggle-upload-section" class="absolute top-4 right-4 p-2 text-gray-500 hover:bg-gray-200 rounded-full transition-colors" title="เปิด/ปิดส่วนอัพโหลด">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                
                <h2 class="text-2xl font-bold text-center mb-6">สรุปสถานะการตรวจสอบ</h2>
                
                <!-- Upload Section -->
                <div id="upload-section" class="hidden mb-6 p-4 bg-slate-50 rounded-lg border">
                    <h3 class="font-bold text-lg mb-3">อัพโหลดข้อมูลใหม่</h3>
                    <div class="space-y-3 sm:space-y-0 sm:flex sm:items-center sm:gap-3">
                        <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <button id="upload-csv-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">อัพโหลด</button>
                    </div>
                    <p id="upload-status" class="text-center text-sm mt-3"></p>
                </div>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <p class="text-lg font-semibold text-blue-800">event ที่ผ่านมา</p>
                        <p id="today-count" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <p class="text-lg font-semibold text-green-800">Email ส่งแล้ว</p>
                        <p id="found-count" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center">
                        <p class="text-lg font-semibold text-yellow-800">รอส่ง Email</p>
                        <p id="waiting-count" class="text-3xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-slate-200 p-4 rounded-lg text-center">
                        <p class="text-lg font-semibold text-slate-800">ทั้งหมด</p>
                        <p id="total-events-count" class="text-3xl font-bold text-slate-600">0</p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-green-700">ความคืบหน้า (Email ที่ส่งแล้ว)</span>
                        <span id="progress-percentage" class="text-sm font-medium text-green-700">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-green-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Event Table -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-900">รายการกิจกรรมทั้งหมด</h2>
                    <div class="flex gap-2">
                        <button id="filter-all" class="filter-btn px-4 py-2 bg-slate-600 text-white rounded-lg text-sm">ทั้งหมด</button>
                        <button id="filter-today" class="filter-btn px-4 py-2 bg-slate-400 text-white rounded-lg text-sm">วันนี้</button>
                        <button id="filter-waiting" class="filter-btn px-4 py-2 bg-slate-400 text-white rounded-lg text-sm">รอส่ง Email</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ชื่อกิจกรรม</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">สถานะ Email</th>
                            </tr>
                        </thead>
                        <tbody id="events-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-events-message" class="text-center text-slate-500 py-8 hidden">ไม่มีข้อมูลกิจกรรม</div>
            </div>
        </div>
        <!-- ================= END NEW EVENT TRACKER ================= -->
    </div>

    <script>
        const EVENT_LIST_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYgcMoR1ZVtRwSKWCwN6XvzRwyhzQY7MWLAoeMCtxwqNUTrWs8Mm3jF-Vbx0vDNWS8MQ/exec';

        async function fetchAndDisplayEvents() {
            const eventContainer = document.getElementById('event-list-container');
            showLoading(eventContainer);

            try {
                // NOTE: Password parameter is removed. Ensure the Apps Script is configured for public access.
                const response = await fetch(EVENT_LIST_SCRIPT_URL);
                const data = await response.json();

                if (data.error) {
                    displayError(data.error, eventContainer);
                } else if (data.events && data.events.length > 0) {
                    displayEvents(data.events, eventContainer);
                } else {
                    eventContainer.innerHTML = '<p class="text-gray-500 text-center mt-8">ไม่มีกิจกรรมสำหรับวันนี้</p>';
                }
            } catch (error) {
                displayError('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ปฏิทินได้ กรุณาลองใหม่อีกครั้ง', eventContainer);
                console.error('Fetch Error:', error);
            }
        }

        function showLoading(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full pt-16">
                    <div class="loader"></div>
                    <p class="text-gray-600 mt-2">กำลังโหลดรายการ...</p>
                </div>
            `;
        }

        function displayError(message, container) {
            container.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                    <p class="font-bold">เกิดข้อผิดพลาด</p>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function displayEvents(events, container) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            function getLocalYMD(dateOrString) {
                if (typeof dateOrString === 'string') {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateOrString)) {
                        const [y, m, d] = dateOrString.split('-').map(Number);
                        return { y, m, d };
                    }
                    const d = new Date(dateOrString);
                    return { y: d.getFullYear(), m: d.getMonth() + 1, d: d.getDate() };
                } else if (dateOrString instanceof Date) {
                    return { y: dateOrString.getFullYear(), m: dateOrString.getMonth() + 1, d: dateOrString.getDate() };
                }
                return null;
            }

            function isTodayInEvent(event) {
                let start = event.start;
                let end = event.end;
                let isAllDay = event.isAllDay;
                let tz = 'Asia/Bangkok';
                let startDate, endDate;
                if (isAllDay) {
                    // All-day: start and end are YYYY-MM-DD, end is exclusive
                    startDate = new Date(start + 'T00:00:00');
                    if (end) {
                        endDate = new Date(end + 'T00:00:00');
                        endDate.setDate(endDate.getDate() - 1); // Make end inclusive
                    } else {
                        endDate = startDate;
                    }
                } else {
                    startDate = new Date(start);
                    if (end) {
                        endDate = new Date(end);
                    } else {
                        endDate = startDate;
                    }
                }
                // Set all to local midnight for comparison
                startDate.setHours(0,0,0,0);
                endDate.setHours(0,0,0,0);
                return today >= startDate && today <= endDate;
            }

            const todaysEvents = events.filter(isTodayInEvent);

            if (todaysEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center mt-8">ไม่มีกิจกรรมสำหรับวันนี้</p>';
                return;
            }

            let eventsHtml = '<div class="space-y-4">';
            todaysEvents.forEach(event => {
                const startDate = new Date(event.start).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
                let startTime = 'ตลอดวัน';
                if (!event.isAllDay && !/^\d{4}-\d{2}-\d{2}$/.test(event.start)) {
                    startTime = new Date(event.start).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                }
                eventsHtml += `
                    <div class="p-4 bg-slate-50 rounded-lg shadow-sm event-item">
                        <h3 class="font-bold text-lg text-slate-900">${event.title}</h3>
                        <p class="text-sm text-slate-600">${startDate} - ${startTime}</p>
                        ${event.description ? `<p class="mt-2 text-slate-700 whitespace-pre-line">${event.description}</p>` : ''}
                    </div>
                `;
            });
            eventsHtml += '</div>';
            container.innerHTML = eventsHtml;
        }

        // =================== NEW EVENT TRACKER LOGIC ===================
        let allEvents = [];
        let currentFilter = 'all';

        // Parse CSV data with the new format
        function parseEventReportCSV(text) {
            const lines = text.trim().replace(/^\uFEFF/, '').split(/\r?\n/);
            if (lines.length < 2) throw new Error("ไฟล์ไม่มีข้อมูล");
            
            // Handle CSV with quoted fields
            const csvRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            const headers = lines[0].split(csvRegex).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            
            // Find column indices
            const titleIdx = headers.findIndex(h => h.includes('event title') || h.includes('title'));
            const dateIdx = headers.findIndex(h => h.includes('event date') || h.includes('date'));
            const branchIdx = headers.findIndex(h => h.includes('branch id') || h.includes('branch'));
            const statusIdx = headers.findIndex(h => h.includes('email status') || h.includes('status'));
            
            if (titleIdx === -1 || dateIdx === -1 || branchIdx === -1 || statusIdx === -1) {
                throw new Error("ไม่พบคอลัมน์ที่จำเป็น: Event Title, Event Date, Branch ID, Email Status");
            }
            
            const events = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const row = lines[i].split(csvRegex);
                if (row.length >= Math.max(titleIdx, dateIdx, branchIdx, statusIdx) + 1) {
                    const event = {
                        title: row[titleIdx]?.replace(/"/g, '').trim() || '',
                        date: row[dateIdx]?.replace(/"/g, '').trim() || '',
                        branchId: row[branchIdx]?.replace(/"/g, '').trim() || '',
                        emailStatus: row[statusIdx]?.replace(/"/g, '').trim().toLowerCase() || ''
                    };
                    
                    if (event.title && event.date) {
                        events.push(event);
                    }
                }
            }
            return events;
        }

        // Save events to Firestore
        async function saveEventsToFirestore(events) {
            try {
                const db = await initFirebaseIfNeeded();
                const collectionRef = db.collection('eventReports');
                
                // For now, let's just add new events without clearing (to avoid permission issues)
                // We can batch write them efficiently
                const batch = db.batch();
                
                // Add timestamp for tracking
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                events.forEach((event, index) => {
                    const docRef = collectionRef.doc(`event_${Date.now()}_${index}`);
                    batch.set(docRef, {
                        ...event,
                        uploadedAt: timestamp,
                        id: `event_${Date.now()}_${index}`
                    });
                });
                
                await batch.commit();
                console.log('Events saved to Firestore successfully');
            } catch (error) {
                console.error('Firestore Save Error Details:', error);
                
                // Provide more specific error messages
                let errorMessage = error.message;
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firestore security rules.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firebase service unavailable. Please check your internet connection.';
                }
                
                throw new Error(errorMessage);
            }
        }

        // Load events from Firestore
        async function loadEventsFromFirestore() {
            try {
                const db = await initFirebaseIfNeeded();
                const snapshot = await db.collection('eventReports')
                    .orderBy('uploadedAt', 'desc')
                    .get();
                
                const events = snapshot.docs.map(doc => doc.data());
                console.log(`Loaded ${events.length} events from Firestore`);
                return events;
            } catch (error) {
                console.error('Firestore Load Error:', error);
                
                // For development purposes, return sample data if Firestore fails
                console.log('Using sample data due to Firestore error');
                return getSampleEvents();
            }
        }

        // Provide sample events for testing when Firestore is not available
        function getSampleEvents() {
            return [
                {
                    title: "ตรวจสอบสาขาทดสอบ 1",
                    date: "2024-07-15",
                    branchId: "001",
                    emailStatus: "found"
                },
                {
                    title: "ตรวจสอบสาขาทดสอบ 2", 
                    date: "2024-07-10",
                    branchId: "002",
                    emailStatus: "waiting"
                },
                {
                    title: "ตรวจสอบสาขาทดสอบ 3",
                    date: "2024-07-20",
                    branchId: "003", 
                    emailStatus: "found"
                }
            ];
        }

        // Get current date in Thai timezone
        function getCurrentDateThai() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Bangkok' 
            };
            return now.toLocaleDateString('th-TH', options);
        }

        // Get current quarter date range
        function getCurrentQuarterRange() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-based
            
            let quarterStart;
            
            // Determine quarter start month
            if (month >= 0 && month <= 2) { // Q1: Jan-Mar
                quarterStart = new Date(year, 0, 1);
            } else if (month >= 3 && month <= 5) { // Q2: Apr-Jun  
                quarterStart = new Date(year, 3, 1);
            } else if (month >= 6 && month <= 8) { // Q3: Jul-Sep
                quarterStart = new Date(year, 6, 1);
            } else { // Q4: Oct-Dec
                quarterStart = new Date(year, 9, 1);
            }
            
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Bangkok' 
            };
            
            const startStr = quarterStart.toLocaleDateString('th-TH', options);
            const todayStr = now.toLocaleDateString('th-TH', options);
            
            return `${startStr} - ${todayStr}`;
        }

        // Check if event is today
        function isEventToday(eventDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const eventDateObj = new Date(eventDate);
            eventDateObj.setHours(0, 0, 0, 0);
            
            return eventDateObj.getTime() === today.getTime();
        }

        // Check if event is in the past (before today)
        function isEventPast(eventDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const eventDateObj = new Date(eventDate);
            eventDateObj.setHours(0, 0, 0, 0);
            
            return eventDateObj.getTime() < today.getTime();
        }

        // Check if event is within current quarter up to today
        function isEventInCurrentQuarter(eventDate) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            let quarterStart;
            if (month >= 0 && month <= 2) { // Q1
                quarterStart = new Date(year, 0, 1);
            } else if (month >= 3 && month <= 5) { // Q2
                quarterStart = new Date(year, 3, 1);
            } else if (month >= 6 && month <= 8) { // Q3
                quarterStart = new Date(year, 6, 1);
            } else { // Q4
                quarterStart = new Date(year, 9, 1);
            }
            
            quarterStart.setHours(0, 0, 0, 0);
            now.setHours(23, 59, 59, 999); // End of today
            
            const eventDateObj = new Date(eventDate);
            eventDateObj.setHours(0, 0, 0, 0);
            
            return eventDateObj >= quarterStart && eventDateObj <= now;
        }

        // Update statistics
        function updateStatistics(events) {
            const foundCount = events.filter(e => e.emailStatus === 'found').length;
            const waitingCount = events.filter(e => e.emailStatus === 'waiting').length;
            const quarterEvents = events.filter(e => isEventInCurrentQuarter(e.date));
            const quarterCount = quarterEvents.length;
            const totalCount = events.length;
            
            document.getElementById('found-count').textContent = foundCount.toLocaleString();
            document.getElementById('waiting-count').textContent = waitingCount.toLocaleString();
            document.getElementById('today-count').textContent = quarterCount.toLocaleString(); // event ที่ผ่านมา
            document.getElementById('total-events-count').textContent = totalCount.toLocaleString();
            
            // Update progress bar
            const percentage = totalCount > 0 ? (foundCount / totalCount) * 100 : 0;
            document.getElementById('progress-bar').style.width = percentage.toFixed(1) + '%';
            document.getElementById('progress-percentage').textContent = percentage.toFixed(0) + '%';
        }

        // Display quarter's events (including past events with special highlighting)
        function displayQuarterEvents(events) {
            const container = document.getElementById('quarter-events-container');
            const quarterEvents = events.filter(e => isEventInCurrentQuarter(e.date));
            
            if (quarterEvents.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-8">ไม่มีกิจกรรมในไตรมาสนี้</p>';
                return;
            }
            
            // Sort by date (ascending)
            quarterEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '';
            quarterEvents.forEach(event => {
                const isPast = isEventPast(event.date);
                const isToday = isEventToday(event.date);
                const isFound = event.emailStatus === 'found';
                
                let statusText, borderColor, bgColor, textColor, badgeClass;
                
                if (isPast) {
                    // Past events
                    if (isFound) {
                        statusText = 'สำเร็จ';
                        borderColor = 'border-emerald-500';
                        bgColor = 'bg-emerald-50';
                        textColor = 'text-emerald-800';
                        badgeClass = 'bg-emerald-100 text-emerald-800';
                    } else {
                        statusText = 'คงค้าง';
                        borderColor = 'border-red-500';
                        bgColor = 'bg-red-50';
                        textColor = 'text-red-800';
                        badgeClass = 'bg-red-100 text-red-800';
                    }
                } else if (isToday) {
                    // Today's events
                    if (isFound) {
                        statusText = 'ส่ง Email แล้ว';
                        borderColor = 'border-green-500';
                        bgColor = 'bg-green-50';
                        textColor = 'text-green-800';
                        badgeClass = 'bg-green-100 text-green-800';
                    } else {
                        statusText = 'รอส่ง Email';
                        borderColor = 'border-yellow-500';
                        bgColor = 'bg-yellow-50';
                        textColor = 'text-yellow-800';
                        badgeClass = 'bg-yellow-100 text-yellow-800';
                    }
                } else {
                    // Future events
                    if (isFound) {
                        statusText = 'ส่ง Email แล้ว';
                        borderColor = 'border-green-500';
                        bgColor = 'bg-green-50';
                        textColor = 'text-green-800';
                        badgeClass = 'bg-green-100 text-green-800';
                    } else {
                        statusText = 'รอส่ง Email';
                        borderColor = 'border-blue-500';
                        bgColor = 'bg-blue-50';
                        textColor = 'text-blue-800';
                        badgeClass = 'bg-blue-100 text-blue-800';
                    }
                }
                
                // Add special indicators
                let indicators = '';
                if (isPast && !isFound) {
                    indicators += '<span class="ml-2 px-2 py-1 bg-red-200 text-red-800 text-xs rounded-full font-bold">เกินกำหนด</span>';
                } else if (isToday) {
                    indicators += '<span class="ml-2 px-2 py-1 bg-blue-200 text-blue-800 text-xs rounded-full font-bold">วันนี้</span>';
                } else if (isPast && isFound) {
                    indicators += '<span class="ml-2 px-2 py-1 bg-emerald-200 text-emerald-800 text-xs rounded-full">เสร็จแล้ว</span>';
                }
                
                const dateFormatted = new Date(event.date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const timeFormatted = new Date(event.date).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="event-tracker-item p-4 ${bgColor} rounded-lg border-l-4 ${borderColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-slate-900 mb-2">
                                    ${event.title}
                                    ${indicators}
                                </h3>
                                <p class="text-sm text-slate-600 mb-1">Branch: ${event.branchId}</p>
                                <p class="text-sm text-slate-600">${dateFormatted} เวลา ${timeFormatted}</p>
                            </div>
                            <span class="status-badge ${badgeClass} font-medium">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Display events table
        function displayEventsTable(events, filter = 'all') {
            const tbody = document.getElementById('events-table-body');
            const noEventsMsg = document.getElementById('no-events-message');
            
            let filteredEvents = [...events];
            
            switch (filter) {
                case 'today':
                    filteredEvents = events.filter(e => isEventToday(e.date));
                    break;
                case 'waiting':
                    filteredEvents = events.filter(e => e.emailStatus === 'waiting');
                    break;
                case 'all':
                default:
                    // No additional filtering
                    break;
            }
            
            if (filteredEvents.length === 0) {
                tbody.innerHTML = '';
                noEventsMsg.classList.remove('hidden');
                return;
            }
            
            noEventsMsg.classList.add('hidden');
            
            // Sort by date
            filteredEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '';
            filteredEvents.forEach(event => {
                const isToday = isEventToday(event.date);
                const isPast = isEventPast(event.date);
                const isFound = event.emailStatus === 'found';
                
                let statusColor, statusText, rowClass, badges = '';
                
                if (isPast) {
                    if (isFound) {
                        statusColor = 'text-emerald-600';
                        statusText = 'สำเร็จ';
                        rowClass = 'bg-emerald-50 border-l-4 border-emerald-500';
                        badges = '<span class="ml-2 px-2 py-1 bg-emerald-100 text-emerald-800 text-xs rounded-full">เสร็จแล้ว</span>';
                    } else {
                        statusColor = 'text-red-600';
                        statusText = 'คงค้าง';
                        rowClass = 'bg-red-50 border-l-4 border-red-500';
                        badges = '<span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-bold">เกินกำหนด</span>';
                    }
                } else if (isToday) {
                    if (isFound) {
                        statusColor = 'text-green-600';
                        statusText = 'ส่งแล้ว';
                        rowClass = 'bg-blue-50 border-l-4 border-blue-500';
                        badges = '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-bold">วันนี้</span>';
                    } else {
                        statusColor = 'text-yellow-600';
                        statusText = 'รอส่ง';
                        rowClass = 'bg-blue-50 border-l-4 border-blue-500';
                        badges = '<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-bold">วันนี้</span>';
                    }
                } else {
                    // Future events
                    statusColor = event.emailStatus === 'found' ? 'text-green-600' : 'text-blue-600';
                    statusText = event.emailStatus === 'found' ? 'ส่งแล้ว' : 'รอส่ง';
                    rowClass = '';
                }
                
                const dateFormatted = new Date(event.date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) + ' ' + new Date(event.date).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 text-sm font-medium text-slate-900">
                            ${event.title}
                            ${badges}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">${dateFormatted}</td>
                        <td class="px-6 py-4 text-sm text-slate-500">${event.branchId}</td>
                        <td class="px-6 py-4 text-sm font-medium ${statusColor}">${statusText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Handle CSV upload
        async function handleCSVUpload() {
            const fileInput = document.getElementById('csv-file-input');
            const statusEl = document.getElementById('upload-status');
            
            const file = fileInput.files[0];
            
            if (!file) {
                statusEl.textContent = "กรุณาเลือกไฟล์ CSV";
                statusEl.className = "text-center text-sm mt-3 text-yellow-500";
                return;
            }
            
            statusEl.textContent = "กำลังประมวลผล...";
            statusEl.className = "text-center text-sm mt-3 text-blue-500";
            
            try {
                const text = await file.text();
                const events = parseEventReportCSV(text);
                
                if (events.length === 0) {
                    throw new Error("ไม่พบข้อมูลกิจกรรมในไฟล์");
                }
                
                statusEl.textContent = "กำลังบันทึกข้อมูล...";
                await saveEventsToFirestore(events);
                
                // Update global events
                allEvents = events;
                
                // Refresh display
                refreshEventDisplay();
                
                statusEl.textContent = `อัพโหลดสำเร็จ! (${events.length} รายการ)`;
                statusEl.className = "text-center text-sm mt-3 text-green-500";
                
                // Clear form
                fileInput.value = '';
                
                // Hide upload section after success
                setTimeout(() => {
                    document.getElementById('upload-section').classList.add('hidden');
                    statusEl.textContent = '';
                }, 3000);
                
            } catch (error) {
                console.error('Upload Error:', error);
                statusEl.textContent = `ผิดพลาด: ${error.message}`;
                statusEl.className = "text-center text-sm mt-3 text-red-500";
            }
        }

        // Refresh all event displays
        function refreshEventDisplay() {
            updateStatistics(allEvents);
            displayQuarterEvents(allEvents);
            displayEventsTable(allEvents, currentFilter);
            updateFilterButtons();
        }

        // Update filter button states
        function updateFilterButtons() {
            const buttons = [
                { id: 'filter-all', filter: 'all', color: 'slate' },
                { id: 'filter-today', filter: 'today', color: 'blue' },
                { id: 'filter-waiting', filter: 'waiting', color: 'yellow' }
            ];
            
            buttons.forEach(({ id, filter, color }) => {
                const btn = document.getElementById(id);
                if (btn) {
                    // Reset all buttons to inactive state
                    btn.className = `filter-btn px-4 py-2 bg-slate-400 text-white rounded-lg text-sm`;
                    
                    // Set active button
                    if (currentFilter === filter) {
                        btn.className = `filter-btn px-4 py-2 bg-${color}-600 text-white rounded-lg text-sm`;
                    }
                }
            });
        }

        // Initialize event listeners
        function setupEventListeners() {
            // Upload functionality
            document.getElementById('upload-csv-btn').addEventListener('click', handleCSVUpload);
            document.getElementById('toggle-upload-section').addEventListener('click', () => {
                document.getElementById('upload-section').classList.toggle('hidden');
            });
            
            // Filter buttons
            document.getElementById('filter-all').addEventListener('click', () => {
                currentFilter = 'all';
                displayEventsTable(allEvents, currentFilter);
                updateFilterButtons();
            });
            
            document.getElementById('filter-today').addEventListener('click', () => {
                currentFilter = 'today';
                displayEventsTable(allEvents, currentFilter);
                updateFilterButtons();
            });
            
            document.getElementById('filter-waiting').addEventListener('click', () => {
                currentFilter = 'waiting';
                displayEventsTable(allEvents, currentFilter);
                updateFilterButtons();
            });
        }

        // Initialize the new event tracker
        async function initEventTracker() {
            // Set current quarter date range display
            document.getElementById('current-quarter-display').textContent = getCurrentQuarterRange();
            
            // Load events from Firestore
            try {
                allEvents = await loadEventsFromFirestore();
                refreshEventDisplay();
            } catch (error) {
                console.error('Failed to load events:', error);
                // Show empty state
                refreshEventDisplay();
            }
            
            // Setup event listeners
            setupEventListeners();
        }

        // Custom toast for shortcut blocking
        function showDevtoolsToast(message) {
            let toast = document.getElementById('devtools-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'devtools-toast';
                toast.style.position = 'fixed';
                toast.style.bottom = '2rem';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.background = '#222';
                toast.style.color = '#fff';
                toast.style.padding = '1rem 2rem';
                toast.style.borderRadius = '8px';
                toast.style.fontSize = '1rem';
                toast.style.zIndex = '9999';
                toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                toast.style.fontFamily = "'Sarabun', 'Noto Sans Thai', sans-serif";
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.display = 'block';
            clearTimeout(toast._timeout);
            toast._timeout = setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        // Disable right-click
        document.addEventListener("contextmenu", function(event) {
            event.preventDefault();
            showDevtoolsToast("Right-click is disabled.");
        });

        // Disable specific keyboard shortcuts
        document.addEventListener("keydown", function(event) {
            // F12
            if (event.key === "F12" || event.keyCode === 123) {
                event.preventDefault();
                showDevtoolsToast("Inspect Element is disabled.");
            }
            // Ctrl+Shift+I (Inspect), Ctrl+Shift+J (Console), Ctrl+U (View Source)
            if (
                (event.ctrlKey && event.shiftKey && (event.key.toUpperCase() === "I" || event.key.toUpperCase() === "J" || event.keyCode === 73 || event.keyCode === 74)) ||
                (event.ctrlKey && (event.key.toUpperCase() === "U" || event.keyCode === 85))
            ) {
                event.preventDefault();
                showDevtoolsToast("Developer tools access is disabled.");
            }
        });

        // Navigation functions
        function handleNavLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = '../index.html';
            }
        }

        function updateUserDisplay() {
            const currentUser = localStorage.getItem('currentUser');
            const userRole = localStorage.getItem('userRole');
            const userNameElement = document.getElementById('user-name');
            
            if (userNameElement && currentUser) {
                const displayName = currentUser.includes('@') ? currentUser.split('@')[0] : currentUser;
                const roleText = userRole === 'admin' ? ' (Admin)' : '';
                userNameElement.textContent = `${displayName}${roleText}`;
            }
        }

        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateUserDisplay();
        });

        // Place initialization at the end, after all DOM elements are loaded
        document.addEventListener('DOMContentLoaded', () => {
            initEventTracker(); // Initialize new event tracker
            fetchAndDisplayEvents(); // Keep the original calendar events
        });
    </script>
</body>
</html>
