<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบสรุปผลการตรวจสอบ - Operations Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration Manager -->
    <script src="../config.js"></script>
    
    <!-- Session Manager -->
    <script src="../session-manager.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <link rel="stylesheet" href="../styles/print-legal.css">
    <!-- Global Print Header -->
    <link rel="stylesheet" href="../styles/print-header.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .status-pass { border-left: 4px solid #22c55e; }
        .status-fail { border-left: 4px solid #ef4444; }
        .status-na   { border-left: 4px solid #6b7280; }
        .print-only { display: none; }

        /* Searchable dropdown styling */
        .searchable-dropdown {
            position: relative;
        }
        
        .dropdown-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: transform 0.2s;
        }
        
        .searchable-dropdown.open .dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-top: none;
            background: white;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        
        .dropdown-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dropdown-option:hover {
            background-color: #f3f4f6;
        }
        
        .dropdown-option.highlighted {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dropdown-option:last-child {
            border-bottom: none;
        }
        
        .no-results {
            padding: 8px 12px;
            color: #6b7280;
            font-style: italic;
            text-align: center;
        }

        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: background-color 0.3s;
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        @media print {
            html, body {
                background: #fff !important;
                color: #222 !important;
                font-family: 'TH SarabunPSK', 'TH Sarabun New', 'Sarabun', 'Times New Roman', Times, serif !important;
                font-size: 11pt !important;
                line-height: 1.6 !important;
            }
            .no-print { display: none !important; }
            .print-container {
                box-shadow: none !important;
                border: 1.5px solid #222 !important;
                border-radius: 0.5rem !important;
                page-break-inside: avoid-page !important;
                background: #fff !important;
                padding: 1.2rem 1.5rem !important;
            }
            .page-break {
                page-break-before: always !important;
            }
            .audit-item {
                page-break-inside: avoid;
                border-color: #bbb !important;
            }
            .notes-input { border: 1px solid #d1d5db !important; }
            .print-only { display: block !important; }
            /* Print styling for searchable dropdown */
            .dropdown-list, .dropdown-arrow {
                display: none !important;
            }
            .searchable-dropdown input {
                padding: 1px 4px !important;
                font-size: 11pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            .auditor-name-dropdown input {
                padding: 1px 4px !important;
                font-size: 11pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            .signature-section {
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
                border-top: 2px dashed #222 !important;
                margin-top: 2.5rem !important;
                padding-top: 2rem !important;
                font-size: 11pt !important;
            }
            .certification {
                border: 1.5px solid #222 !important;
                border-radius: 0.5rem !important;
                background: #f7f7f7 !important;
                color: #222 !important;
                font-size: 11pt !important;
                margin: 2rem 0 1.5rem 0 !important;
                padding: 1.2rem 1rem !important;
                text-align: center;
            }
            header, footer {
                border-bottom: 2px solid #222 !important;
                margin-bottom: 1.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }

        /* Enhanced collision fix is now in global print-legal.css */
    </style>
</head>
<body class="bg-slate-50 logged-in">
    <!-- Global Print Header Section -->
    <div class="print-header-section"></div>
    
    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-slate-800">ใบสรุปผลการตรวจสอบสาขา</h1>
            <p class="text-lg text-slate-500 mt-1">รายงานสรุปผลการดำเนินงานของสาขา</p>
        </header>

        <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8 print-container" id="audit-details-container">
            <h2 class="text-2xl font-bold text-slate-700 border-b pb-3 mb-4">รายละเอียดการตรวจสอบ</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="branch-name" class="block text-sm font-medium text-gray-700">ชื่อสาขา</label>
                    <div class="relative">
                        <div class="searchable-dropdown">
                            <input type="text" id="branch-search" placeholder="ค้นหาหรือเลือกสาขา..." 
                                   class="mt-1 w-full p-2 pr-8 border border-gray-300 rounded-md shadow-sm bg-white"
                                   autocomplete="off">
                            <div class="dropdown-arrow">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <div id="branch-dropdown-list" class="dropdown-list hidden">
                                <div class="dropdown-option" data-value="">-- เลือกสาขา --</div>
                            </div>
                        </div>
                        <input type="hidden" id="branch-name" name="branch-name">
                    </div>
                </div>
                <div class="md:col-span-2">
                     <label for="audit-date" class="block text-sm font-medium text-gray-700">วันที่ตรวจสอบ</label>
                    <input type="date" id="audit-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                 <div>
                    <label for="auditee-name" class="block text-sm font-medium text-gray-700">ชื่อผู้รับการตรวจสอบ</label>
                    <input type="text" id="auditee-name" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="md:col-span-2">
                    <label for="auditee-position" class="block text-sm font-medium text-gray-700">ตำแหน่ง (ผู้รับการตรวจสอบ)</label>
                    <input type="text" id="auditee-position" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>

            <div class="border-t pt-4">
                 <h3 class="text-lg font-semibold text-slate-600 mb-2">รายชื่อผู้ตรวจสอบ</h3>
                <div id="auditor-list-container" class="space-y-3">
                    </div>
                <button id="add-auditor-btn" class="no-print mt-3 text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md">
                    + เพิ่มผู้ตรวจสอบ
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t">
                <h3 class="text-lg font-semibold text-slate-600 mb-3">สรุปผลการตรวจสอบ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <div id="audit-summary" class="flex gap-x-6 gap-y-2 flex-wrap text-md mb-3">
                            <span class="font-semibold">สถานะ:</span>
                            <span id="summary-pass" class="text-green-600 font-medium">ผ่าน: 0</span>
                            <span id="summary-fail" class="text-red-600 font-medium">ไม่ผ่าน: 0</span>
                            <span id="summary-na" class="text-gray-600 font-medium">ไม่เกี่ยวข้อง: 0</span>
                        </div>
                         <div class="flex items-center gap-4">
                            <span id="audit-score-grade" class="text-5xl font-bold text-slate-700">-</span>
                            <div>
                                <p id="audit-score-text" class="text-lg font-semibold text-slate-600">คะแนน: 0 / 0</p>
                                <p id="audit-score-percentage" class="text-md text-slate-500">0%</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ผลการประเมินโดยรวม</label>
                        <div class="w-full h-8 progress-bar">
                            <div id="audit-progress-bar" class="progress-bar-inner h-8 flex items-center justify-center">
                                <span id="audit-progress-text"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main id="checklist-sections" class="max-w-5xl mx-auto space-y-8">
            </main>
        
        <footer class="max-w-5xl mx-auto mt-8 flex flex-col sm:flex-row gap-4 justify-center no-print">
            <button id="export-pdf-button" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                Export เป็น PDF
            </button>
             <button id="export-json-button" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                Export to JSON
            </button>
            <button id="reset-button" class="w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-colors shadow-sm">
                เริ่มการตรวจสอบใหม่
            </button>
        </footer>

        <!-- Legal Declaration and Signature Section (print only) -->
        <div class="print-legal-section">
            <div class="legal-certification">
                ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ
                <div class="english-text">
                    (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature-container">
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <div class="signature-name">ลงชื่อ .................................................</div>
                        <div class="signature-title">(ผู้ตรวจสอบ / Auditor)</div>
                        <div class="signature-date">
                            วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                        </div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <div class="signature-name">ลงชื่อ .................................................</div>
                        <div class="signature-title">(ผู้รับการตรวจสอบ / Auditee)</div>
                        <div class="signature-date">
                            วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Branch list data
            const branches = [
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) Iphone',
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) SVOA',
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) อุปกรณ์เสริม',
                'B002 IBeat – IT Mall ไอที มอลล์ ฟอร์จูน (B-IT)',
                'B004 IBeat Esplanade เอสพลานาด ซีนีเพล็กซ์ รัชดาภิเษก(B-ES)',
                'B006 Ustore TU Rungsit มหาวิทยาลัยธรรมศาสตร์ รังสิต (TUR)',
                'B007 Ustore ABAC Bangna มหาวิทยาลัยอัสสัมชัญ สุวรรณภูมิ (ABB)',
                'B008 Ustore TU Thaprajan มหาวิทยาลัยธรรมศาสตร์ ท่าพระจันทร์ (TUT)',
                'B009 iStudio Central Chaengwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (S-CW)',
                'B010 iStudio Seacon Square ซีคอนสแควร์ ศรีนครินทร์ (S-SQ)',
                'B012 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ บางเขน (KU)',
                'B013 Ustore Mahidol University มหาวิทยาลัยมหิดล ศาลายา(MU)',
                'B016 Ustore Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (BUR)',
                'B017 Ustore Dhurakij Pundit University มหาวิทยาลัยธุรกิจบัณฑิตย์(DPU)',
                'B018 iStudio Central Rama 9 เซ็นทรัลพลาซา แกรนด์ พระราม 9 (S-CR)',
                'B019 Ustore Burapha University มหาวิทยาลัยบูรพา (BUU)',
                'B020 iCenter Central Changwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (C-CCW)',
                'B021 IBeat Gateway Ekamai เกตเวย์ เอกมัย (B-GE)',
                'B024 IBeat – Central Chiang Rai เซ็นทรัล เชียงราย (B-CCR)',
                'B031 iStudio Central Rayong เซ็นทรัลพลาซา ระยอง (S-CRY)',
                'B032 iCenter Central Chiang Rai เซ็นทรัลเชียงราย (C-CCR)',
                'B034 AIS Lotus Rayong โลตัสระยอง (A-LR)',
                'B035 AIS Big C Aranyaprathet บิ๊กซี อรัญประเทศ(A-BA)',
                'B036 iCenter Laemtong Rayong แหลมทอง ระยอง (C-LRY)',
                'B037 Mobi Phayao พะเยา (M-PY)',
                'B038 Mobi Lumphun ลำพูน (M-LP)',
                'B039 iCenter Homepro Nakhonpatom ศูนย์การค้าโฮมโปรนครปฐม (I-HNT)',
                'B040 AIS Robinson Lifestyle Chanthaburiโรบินสัน ไลฟ์สไตล์ จันทบุรี (A-RJ)',
                'B044 AIS Telewiz Lotus Rojana โลตัส โรจนะ (A-LRJ)',
                'B046 AIS Lotus Ban Chang โลตัส บ้านฉาง (A-LC)',
                'B047 AIS Telewiz Lotus lom sak โลตัส หล่มสัก(A-LL)',
                'B048 I Beat Robinson kampaeng phet โรบินสัน กำแพงเพชร (B-RK)',
                'B049 Mobi phichit พิจิตร (M-PJ)',
                'B050 AIS Telewiz Big C Wichian Buri บิ๊กซี วิเชียรบุรี(A-BW)',
                'B051 AIS Robinson Kamphaeng Phet โรบินสันกำแพงเพชร(A-RK)',
                'B052 AIS Buddy phayao ศูนย์การค้า ท็อปส์ พลาซ่า พะเยา (A-PY)',
                'B053 AIS Lotus Phetchaboon โลตัส เพชรบูรณ์ (A-LP)',
                'B054 AIS shop Big C sattahip ศูนย์การค้าบิ๊กซีซุปเปอร์เซนเตอร์สาขาสัตหีบ (A-BS)',
                'B055 iCenter G Tower อาคารจี ทาวเวอร์ แกรนด์ พระราม 9 (C-GR)',
                'B056 AIS robinson chonburi โรบินสันชลบุรี2 (อมตะนคร) (A-RC)',
                'B058 AIS Telewiz U-Tapao โลตัส สาขาอู่ตะเภา (A-UT)',
                'B059 AIS Central Rayong เซ็นทรัล พลาซา สาขา ระยอง (A-CR)',
                'B061 Ustore Mae Fah Luang University มหาวิทยาลัยแม่ฟ้าหลวง(MFU)',
                'B062 Ustore KMUTNB พระจอมเกล้าพระนครเหนือ (KMU)',
                'B063 Ustore Naresuan University มหาวิทยาลัยนเรศวร(NU)',
                'B064 AIS Telewiz Si-Thap ศรีเทพ(A-ST)',
                'B065 Ustore Mahasarakham University มหาวิทยาลัยมหาสารคาม',
                'B066 Ustore Rambhai Barni Rajabhat University มรภ.รำไพพรรณี (RBRU)',
                'B067 Ustore Chiang Mai Rajabhat University มรภ.เชียงใหม่ (CMRU)',
                'B068 A-Store มหาวิทยาลัยศรีนครินทรวิโรฒ ประสานมิตร (A-SWU)',
                'B069 Ustore Prince of Songkla University มหาวิทยาลัยสงขลานครินทร์ (PSU)',
                'B070 A-Store มหาวิทยาลัยสงขลานครินทร์ (A-PSU)',
                'B071 Ustore University of Phayao มหาวิทยาลัยพะเยา (UP)',
                'B072 Ustore SUT มหาวิทยาลัยเทคโนโลยีสุรนารี (SUT)',
                'B073 Ustore Maejo University มหาวิทยาลัยแม่โจ้ (MJU)',
                'B074 Ustore RMUTT มหาวิทยาลัยเทคโนโลยีราชมงคลธัญบุรี(RMUTT)',
                'B075 AIS Telewiz Lotus Chonburi โลตัส สาขา ชลบุรี (A-LCB)',
                'B076 A-Store มหาวิทยาลัยมหิดล ศาลายา (A-MU)',
                'B077 iCenter Phuke ศูนย์การค้าเซ็นทรัล ภูเก็ต (I-PNPT)',
                'B078 AIS Robinson Mae Sot โรบินสัน แม่สอด (A-RM)',
                'B079 A-Store มหาวิทยาลัยเทคโนโลยีสุรนารี (A-SUT)',
                'B080 Icenter Robinson Chanthaburi โรบินสันไลฟ์สไตล์ จันทบุรี (I-RJ)',
                'B081 AIS Telewiz Laemtong Chonburi แหลมทองชลบุรี(A-LCH)',
                'B083 A-Store Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (A-BU)',
                'B084 Mobi Suvarnabhumi มาร์เก็ตวิลเลจ สุวรรณภูมิ(M-MS)',
                'B085 Ustore Nakhon Pathom Rajabhat University มรภ.นครปฐม (NPRU)',
                'B087 AIS Robinson Ban Chang โรบินสัน บ้านฉาง(A-RB)',
                'B089 A-Store มหาวิทยาลัยแม่ฟ้าหลวง (A-MFU)',
                'B090 U Store Pibulsongkram Rajabhat University มรภ.พิบูลสงคราม(PSRU)',
                'B091 A-Store มหาวิทยาลัยราชภัฏเชียงใหม่ (A-CMRU)',
                'B092 AIS Shop Robinson Lifestyle Thalang โรบินสัน ไลฟ์สไตล์ ถลาง(A-RT)',
                'B093 Ustore TU Rungsit-MED ม.ธรรมศาสตร์รังสิต คณะแพทย์ฯ (TUMED)',
                'B094 U Store SIAMSCAPE สยามสเคป',
                'B095 A-Store มหาวิทยาลัยมหาสารคาม (A-MSU)',
                'B096 A-Store มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (A-KUSRC)',
                'B097 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (U-KUSRC)',
                'B098 Mobi Lotus Bo Win โลตัส บ่อวิน(M-LBV)',
                'B099 AIS Mini Shop Lotus Pak Kret โลตัสปากเกร็ด (M-LPK)',
                'B100 AIS Telewiz Lotus Sattahip โลตัสสัตหีบ(A-LS)',
                'B101 AIS Buddy Krua Sahapat เครือสหพัฒน์ จ.ชลบุรี (A-KS)',
                'B102 A-Store Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ (KU)',
                'B103 Ustore RMUTK มหาวิทยาลัยเทคโนโลยีราชมงคลกรุงเทพ(RMUTK)',
                'B104 Ustore Phranakhon Rajabhat Universityมหาวิทยาลัยราชภัฏพระนคร(PNRU)',
                'B105 Ustore Nakhon Sawan Rajabhat University มหาวิทยาลัยราชภัฐนครสวรรค์',
                'B106 iStudio Central Westville ราชพฤกษ์(ศูนย์ iCenter)',
                'B107 iStudio Central Nakhon Sawan เซ็นทรัล นครสวรรค์ (ศูนย์ iCenter)',
                'B109 AIS Telewiz Lotus พะเยา(A-LPY)',
                'B110 Mobi Esplanade',
                'B111 Head Office <AIS Shop Robinson Chalong>',
                'B112 Head Office <AIS Telewiz Lotus Samkong>'
            ];

            // Auditor data
            const auditors = [
                { name: 'นายกันต์กฤช พุ่มเจริญ', position: 'เจ้าหน้าที่การตรวจสอบระดับปฏิบัติการ' },
                { name: 'นายนพรัตน์ แก้วสกุลณี', position: 'เจ้าหน้าที่การตรวจสอบระดับปฏิบัติการ' },
                { name: 'นายรัชภูมิ อาจเอี่ยม', position: 'เจ้าหน้าที่การตรวจสอบระดับปฏิบัติการ' },
                { name: 'นายอนุวัฒน์ จันทร์เลิง', position: 'เจ้าหน้าที่การตรวจสอบระดับปฏิบัติการ' },
                { name: 'นายประเสริฐ สุขสงวน', position: 'เจ้าหน้าที่การตรวจสอบระดับปฏิบัติการ' }
            ];

            // Initialize searchable dropdown for branches
            const branchSearchInput = document.getElementById('branch-search');
            const branchHiddenInput = document.getElementById('branch-name');
            const branchDropdownList = document.getElementById('branch-dropdown-list');
            const searchableDropdown = document.querySelector('.searchable-dropdown');
            
            // Populate dropdown options
            branches.forEach(branch => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.setAttribute('data-value', branch);
                option.textContent = branch;
                branchDropdownList.appendChild(option);
            });

            // Searchable dropdown functionality
            let filteredBranches = [...branches];
            let highlightedIndex = -1;
            let isOpen = false;

            function filterOptions(searchTerm) {
                filteredBranches = branches.filter(branch => 
                    branch.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                // Clear existing options
                branchDropdownList.innerHTML = '<div class="dropdown-option" data-value="">-- เลือกสาขา --</div>';
                
                if (filteredBranches.length === 0 && searchTerm) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.textContent = 'ไม่พบสาขาที่ตรงกับการค้นหา';
                    branchDropdownList.appendChild(noResults);
                } else {
                    filteredBranches.forEach(branch => {
                        const option = document.createElement('div');
                        option.className = 'dropdown-option';
                        option.setAttribute('data-value', branch);
                        option.textContent = branch;
                        branchDropdownList.appendChild(option);
                    });
                }
                
                highlightedIndex = -1;
                updateHighlight();
            }

            function updateHighlight() {
                const options = branchDropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                options.forEach((option, index) => {
                    option.classList.toggle('highlighted', index === highlightedIndex);
                });
            }

            function openDropdown() {
                isOpen = true;
                searchableDropdown.classList.add('open');
                branchDropdownList.classList.remove('hidden');
            }

            function closeDropdown() {
                isOpen = false;
                searchableDropdown.classList.remove('open');
                branchDropdownList.classList.add('hidden');
                highlightedIndex = -1;
                updateHighlight();
            }

            function selectOption(value, text) {
                branchHiddenInput.value = value;
                branchSearchInput.value = text;
                closeDropdown();
                // Trigger save when branch is selected
                saveState();
            }

            // Event listeners for searchable dropdown
            branchSearchInput.addEventListener('focus', () => {
                filterOptions(branchSearchInput.value);
                openDropdown();
            });

            branchSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                filterOptions(searchTerm);
                if (!isOpen) openDropdown();
                
                // If exact match, select it
                const exactMatch = branches.find(branch => 
                    branch.toLowerCase() === searchTerm.toLowerCase()
                );
                if (exactMatch) {
                    branchHiddenInput.value = exactMatch;
                } else {
                    branchHiddenInput.value = '';
                }
                // Trigger save when typing
                saveState();
            });

            branchSearchInput.addEventListener('keydown', (e) => {
                if (!isOpen) return;
                
                const options = branchDropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                        updateHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        highlightedIndex = Math.max(highlightedIndex - 1, -1);
                        updateHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (highlightedIndex >= 0 && options[highlightedIndex]) {
                            const selectedOption = options[highlightedIndex];
                            selectOption(selectedOption.dataset.value, selectedOption.textContent);
                        } else if (filteredBranches.length === 1) {
                            selectOption(filteredBranches[0], filteredBranches[0]);
                        }
                        break;
                    case 'Escape':
                        closeDropdown();
                        branchSearchInput.blur();
                        break;
                }
            });

            // Click on dropdown options
            branchDropdownList.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-option') && e.target.dataset.value !== undefined) {
                    selectOption(e.target.dataset.value, e.target.textContent);
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchableDropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Handle dropdown arrow click
            searchableDropdown.addEventListener('click', (e) => {
                if (e.target.closest('.dropdown-arrow')) {
                    if (isOpen) {
                        closeDropdown();
                    } else {
                        branchSearchInput.focus();
                    }
                }
            });

            const sections = {
                "การควบคุมเงินสด (Cash Control)": [
                    { text: "เงินสดในมือตรงกับรายงานและยอดในระบบ", weight: 1 },
                    { text: "เงินสดย่อย (Petty Cash) มีครบถ้วนและถูกต้อง", weight: 1 },
                    { text: "เงินรับโอน QR Code ถูกต้องตรงกับหน้าบัญชีธนาคาร", weight: 1 },
                    { text: "เงินรับบัตรเครดิต ถูกต้องตรงกับสลิปและหน้าสรุปรับชำระ", weight: 1 },
                ],
                "การควบคุมสต็อกสินค้า (Stock Control)": [
                    { text: "จำนวนสินค้าจากการนับ (Stock Check) ตรงกับข้อมูลในระบบ", weight: 1 },
                    { text: "ไม่มีผลต่างสต็อกที่ผิดปกติและไม่สามารถอธิบายได้", weight: 1 }
                ],
                "การปฏิบัติงาน (Operation)": [
                    { text: "เอกสารโอนย้ายสินค้าระหว่างสาขา (รับเข้า/ส่งออก) ถูกต้องครบถ้วน", weight: 1 },
                    { text: "การควบคุมเอกสารเงินสด (ใบเบิก/รอคืนเงิน) มีความถูกต้อง", weight: 1 },
                    { text: "เอกสารลดหนี้ (Credit Note) และรายการในระบบ Smart Core ถูกต้องตรงกัน", weight: 1 },
                    { text: "รายการขาย (Sales Order) ถูกจัดส่งครบถ้วน ไม่มีรายการค้างผิดปกติ", weight: 1 },
                    { text: "การนำฝากเงินสดไม่มีปัญหา (ไม่มีรายการค้างหรือสถานะ Draft)", weight: 1 }
                ],
                "สภาพแวดล้อมและความเรียบร้อย (Environment and Orderliness)": [
                    { text: "มีการจัดการสต็อกตามหลัก First-In, First-out (FIFO)", weight: 1 },
                    { text: "สต็อกสินค้าถูกจัดเก็บอย่างเป็นระเบียบและจัดการได้ดี", weight: 1 },
                    { text: "ร้านค้ามีความสะอาดและพร้อมให้บริการลูกค้า", weight: 1 },
                    { text: "อุปกรณ์ล็อคสินค้าแขวน กุญแจตู้เก็บสินค้า ถูกปิดล็อคเรียบร้อยดีทุกครั้งหลังหยิบสินค้า", weight: 1 },
                    { text: "สาย Security สินค้าอยู่ในสภาพพร้อมใช้งาน", weight: 1 }
                ]
            };

            const sectionsContainer = document.getElementById('checklist-sections');
            const auditDateInput = document.getElementById('audit-date');
            const auditorListContainer = document.getElementById('auditor-list-container');
            const addAuditorBtn = document.getElementById('add-auditor-btn');

            let appState = {};
            let scoreSummary = {};
            const getStorageKey = () => `auditReport-${auditDateInput.value || new Date().toISOString().substring(0, 10)}`;

            const createItemHTML = (item, sectionKey, itemIndex) => { 
                return `<div id="item-${sectionKey}-${itemIndex}" class="audit-item bg-white p-4 rounded-lg shadow-sm border border-slate-200 transition-all"><p class="text-slate-800 font-medium">${item.text}</p><div class="mt-3 flex flex-wrap gap-x-6 gap-y-2 items-center"><div class="flex items-center"><input type="radio" id="pass-${sectionKey}-${itemIndex}" name="status-${sectionKey}-${itemIndex}" value="pass" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"><label for="pass-${sectionKey}-${itemIndex}" class="ml-2 text-sm text-gray-700">ผ่าน</label></div><div class="flex items-center"><input type="radio" id="fail-${sectionKey}-${itemIndex}" name="status-${sectionKey}-${itemIndex}" value="fail" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300"><label for="fail-${sectionKey}-${itemIndex}" class="ml-2 text-sm text-gray-700">ไม่ผ่าน</label></div><div class="flex items-center"><input type="radio" id="na-${sectionKey}-${itemIndex}" name="status-${sectionKey}-${itemIndex}" value="na" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300"><label for="na-${sectionKey}-${itemIndex}" class="ml-2 text-sm text-gray-700">ไม่เกี่ยวข้อง</label></div></div><div class="mt-3"><textarea id="notes-${sectionKey}-${itemIndex}" placeholder="หมายเหตุและข้อเสนอแนะจากผู้ตรวจสอบ..." class="notes-input w-full p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea></div></div>`; 
            };
            const createSectionHTML = (title, items, sectionKey) => { 
                // Add page break before "การปฏิบัติงาน (Operation)" in print
                const pageBreakClass = title.includes("การปฏิบัติงาน") ? "page-break" : "";
                const itemsHTML = items.map((item, index) => createItemHTML(item, sectionKey, index)).join(''); 
                return `<section class="print-container ${pageBreakClass}"><h2 class="text-2xl font-bold text-slate-700 mb-4">${title}</h2><div class="space-y-4">${itemsHTML}</div></section>`; 
            };

            const addAuditorRow = (auditor = { name: '', position: '' }) => {
                const rowId = 'auditor-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const row = document.createElement('div');
                row.className = 'auditor-row grid grid-cols-12 gap-2 items-center';
                row.id = rowId;
                row.innerHTML = `
                    <div class="col-span-6">
                        <div class="relative">
                            <div class="searchable-dropdown auditor-name-dropdown">
                                <input type="text" value="${auditor.name}" 
                                       class="auditor-name-search mt-1 w-full p-2 pr-8 border border-gray-300 rounded-md shadow-sm bg-white" 
                                       placeholder="ค้นหาหรือกรอกชื่อผู้ตรวจสอบ..." autocomplete="off">
                                <div class="dropdown-arrow">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <div class="auditor-dropdown-list dropdown-list hidden">
                                    <div class="dropdown-option" data-name="" data-position="">-- เลือกผู้ตรวจสอบ --</div>
                                </div>
                            </div>
                            <input type="hidden" class="auditor-name-input" value="${auditor.name}">
                        </div>
                    </div>
                    <div class="col-span-5">
                        <input type="text" value="${auditor.position}" 
                               class="auditor-position-input mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" 
                               placeholder="ตำแหน่ง">
                    </div>
                    <div class="col-span-1">
                        <button class="remove-auditor-btn no-print text-red-500 hover:text-red-700 text-xl">&times;</button>
                    </div>
                `;
                auditorListContainer.appendChild(row);
                
                // Setup searchable dropdown for this row
                setupAuditorDropdown(row);
                
                // Remove button functionality
                row.querySelector('.remove-auditor-btn').addEventListener('click', () => { 
                    row.remove(); 
                    saveState(); 
                });
            };

            // Setup auditor dropdown functionality
            const setupAuditorDropdown = (row) => {
                const searchInput = row.querySelector('.auditor-name-search');
                const hiddenInput = row.querySelector('.auditor-name-input');
                const positionInput = row.querySelector('.auditor-position-input');
                const dropdownList = row.querySelector('.auditor-dropdown-list');
                const searchableDropdown = row.querySelector('.auditor-name-dropdown');
                
                // Populate dropdown options
                auditors.forEach(auditor => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.setAttribute('data-name', auditor.name);
                    option.setAttribute('data-position', auditor.position);
                    option.textContent = auditor.name;
                    dropdownList.appendChild(option);
                });

                let filteredAuditors = [...auditors];
                let highlightedIndex = -1;
                let isOpen = false;

                function filterOptions(searchTerm) {
                    filteredAuditors = auditors.filter(auditor => 
                        auditor.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    // Clear existing options
                    dropdownList.innerHTML = '<div class="dropdown-option" data-name="" data-position="">-- เลือกผู้ตรวจสอบ --</div>';
                    
                    if (filteredAuditors.length === 0 && searchTerm) {
                        const noResults = document.createElement('div');
                        noResults.className = 'no-results';
                        noResults.textContent = 'ไม่พบผู้ตรวจสอบที่ตรงกับการค้นหา';
                        dropdownList.appendChild(noResults);
                    } else {
                        filteredAuditors.forEach(auditor => {
                            const option = document.createElement('div');
                            option.className = 'dropdown-option';
                            option.setAttribute('data-name', auditor.name);
                            option.setAttribute('data-position', auditor.position);
                            option.textContent = auditor.name;
                            dropdownList.appendChild(option);
                        });
                    }
                    
                    highlightedIndex = -1;
                    updateHighlight();
                }

                function updateHighlight() {
                    const options = dropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                    options.forEach((option, index) => {
                        option.classList.toggle('highlighted', index === highlightedIndex);
                    });
                }

                function openDropdown() {
                    isOpen = true;
                    searchableDropdown.classList.add('open');
                    dropdownList.classList.remove('hidden');
                }

                function closeDropdown() {
                    isOpen = false;
                    searchableDropdown.classList.remove('open');
                    dropdownList.classList.add('hidden');
                    highlightedIndex = -1;
                    updateHighlight();
                }

                function selectOption(name, position) {
                    hiddenInput.value = name;
                    searchInput.value = name;
                    positionInput.value = position;
                    closeDropdown();
                    saveState();
                }

                // Event listeners
                searchInput.addEventListener('focus', () => {
                    filterOptions(searchInput.value);
                    openDropdown();
                });

                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    filterOptions(searchTerm);
                    if (!isOpen) openDropdown();
                    
                    // If exact match, select it
                    const exactMatch = auditors.find(auditor => 
                        auditor.name.toLowerCase() === searchTerm.toLowerCase()
                    );
                    if (exactMatch) {
                        hiddenInput.value = exactMatch.name;
                        positionInput.value = exactMatch.position;
                    } else {
                        hiddenInput.value = searchTerm;
                        // Don't auto-fill position if it's not an exact match
                    }
                    saveState();
                });

                searchInput.addEventListener('keydown', (e) => {
                    if (!isOpen) return;
                    
                    const options = dropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                            updateHighlight();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            highlightedIndex = Math.max(highlightedIndex - 1, -1);
                            updateHighlight();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (highlightedIndex >= 0 && options[highlightedIndex]) {
                                const selectedOption = options[highlightedIndex];
                                selectOption(selectedOption.dataset.name, selectedOption.dataset.position);
                            } else if (filteredAuditors.length === 1) {
                                selectOption(filteredAuditors[0].name, filteredAuditors[0].position);
                            }
                            break;
                        case 'Escape':
                            closeDropdown();
                            searchInput.blur();
                            break;
                    }
                });

                // Click on dropdown options
                dropdownList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('dropdown-option') && e.target.dataset.name !== undefined) {
                        selectOption(e.target.dataset.name, e.target.dataset.position);
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!row.contains(e.target)) {
                        closeDropdown();
                    }
                });

                // Handle dropdown arrow click
                searchableDropdown.addEventListener('click', (e) => {
                    if (e.target.closest('.dropdown-arrow')) {
                        if (isOpen) {
                            closeDropdown();
                        } else {
                            searchInput.focus();
                        }
                    }
                });
            };

            const getInitialState = () => {
                const initialState = { details: { branch: '', auditeeName: '', auditeePosition: '', date: auditDateInput.value, auditors: [{ name: '', position: '' }] }, sections: {} };
                Object.keys(sections).forEach(sectionKey => { 
                    initialState.sections[sectionKey] = sections[sectionKey].map(() => ({ status: null, notes: '' })); 
                });
                return initialState;
            };

            const saveState = () => {
                const auditors = Array.from(document.querySelectorAll('.auditor-row')).map(row => ({
                    name: row.querySelector('.auditor-name-input').value,
                    position: row.querySelector('.auditor-position-input').value
                }));
                appState.details = { 
                    branch: document.getElementById('branch-name').value, // Hidden input with selected branch
                    auditeeName: document.getElementById('auditee-name').value, 
                    auditeePosition: document.getElementById('auditee-position').value, 
                    date: auditDateInput.value, 
                    auditors: auditors 
                };
                Object.keys(sections).forEach((sectionKey, s_idx) => { 
                    appState.sections[sectionKey] = sections[sectionKey].map((_, i_idx) => ({ 
                        status: document.querySelector(`input[name="status-${s_idx}-${i_idx}"]:checked`)?.value || null, 
                        notes: document.getElementById(`notes-${s_idx}-${i_idx}`).value 
                    })); 
                });
                localStorage.setItem(getStorageKey(), JSON.stringify(appState));
                calculateAndDisplayScore(); // Recalculate score on every save
            };

            const loadState = () => {
                const savedData = localStorage.getItem(getStorageKey());
                appState = savedData ? JSON.parse(savedData) : getInitialState();
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                
                // Update branch dropdown
                const branchValue = appState.details?.branch || '';
                document.getElementById('branch-name').value = branchValue;
                document.getElementById('branch-search').value = branchValue;
                
                document.getElementById('auditee-name').value = appState.details?.auditeeName || '';
                document.getElementById('auditee-position').value = appState.details?.auditeePosition || '';
                auditorListContainer.innerHTML = '';
                if (appState.details?.auditors && appState.details.auditors.length > 0) { 
                    appState.details.auditors.forEach(addAuditorRow); 
                } else { 
                    addAuditorRow(); 
                }
                Object.entries(appState.sections || {}).forEach(([sectionKey, items]) => {
                    const sectionIndex = Object.keys(sections).indexOf(sectionKey);
                    if (sectionIndex === -1) return;
                    items.forEach(({ status, notes }, itemIndex) => {
                        if (status) { 
                            const radio = document.getElementById(`${status}-${sectionIndex}-${itemIndex}`); 
                            if (radio) radio.checked = true; 
                        }
                        const notesEl = document.getElementById(`notes-${sectionIndex}-${itemIndex}`);
                        if (notesEl) notesEl.value = notes || '';
                    });
                });
                updateUI();
            };
            
            const updateUI = () => {
                let passCount = 0, failCount = 0, naCount = 0;
                document.querySelectorAll('.audit-item').forEach(item => item.classList.remove('status-pass', 'status-fail', 'status-na')); 
                
                if (!appState.sections) return;
                
                Object.values(appState.sections).forEach((items, s_idx) => { 
                    items.forEach(({ status }, i_idx) => { 
                        if (status === 'pass') passCount++; 
                        if (status === 'fail') failCount++; 
                        if (status === 'na') naCount++; 
                        const itemDiv = document.getElementById(`item-${s_idx}-${i_idx}`); 
                        if (itemDiv && status) itemDiv.classList.add(`status-${status}`); 
                    }); 
                }); 
                
                document.getElementById('summary-pass').textContent = `ผ่าน: ${passCount}`; 
                document.getElementById('summary-fail').textContent = `ไม่ผ่าน: ${failCount}`; 
                document.getElementById('summary-na').textContent = `ไม่เกี่ยวข้อง: ${naCount}`;
                
                calculateAndDisplayScore();
            };

            const calculateAndDisplayScore = () => {
                let actualScore = 0;
                let possibleScore = 0;

                Object.entries(appState.sections || {}).forEach(([sectionKey, items]) => {
                    const sectionTemplate = sections[sectionKey];
                    items.forEach(({ status }, itemIndex) => {
                        if (status && status !== 'na') {
                            const itemWeight = sectionTemplate[itemIndex]?.weight || 1;
                            possibleScore += itemWeight;
                            if (status === 'pass') {
                                actualScore += itemWeight;
                            }
                        }
                    });
                });

                const percentage = possibleScore > 0 ? (actualScore / possibleScore) * 100 : 0;
                
                let grade = '-';
                let gradeColorClass = 'text-slate-700';
                let progressColorClass = 'bg-slate-400';

                if (possibleScore > 0) {
                    if (percentage >= 90) { grade = 'A'; gradeColorClass = 'text-green-600'; progressColorClass = 'bg-green-500'; } 
                    else if (percentage >= 80) { grade = 'B'; gradeColorClass = 'text-blue-600'; progressColorClass = 'bg-blue-500'; } 
                    else if (percentage >= 70) { grade = 'C'; gradeColorClass = 'text-yellow-600'; progressColorClass = 'bg-yellow-500'; } 
                    else if (percentage >= 60) { grade = 'D'; gradeColorClass = 'text-orange-600'; progressColorClass = 'bg-orange-500'; } 
                    else { grade = 'F'; gradeColorClass = 'text-red-600'; progressColorClass = 'bg-red-500'; }
                }

                document.getElementById('audit-score-grade').textContent = grade;
                document.getElementById('audit-score-grade').className = `text-5xl font-bold ${gradeColorClass}`;
                document.getElementById('audit-score-text').textContent = `คะแนน: ${actualScore} / ${possibleScore}`;
                document.getElementById('audit-score-percentage').textContent = `${percentage.toFixed(2)}%`;
                
                const progressBar = document.getElementById('audit-progress-bar');
                const progressText = document.getElementById('audit-progress-text');

                progressBar.style.width = `${percentage}%`;
                progressBar.className = `progress-bar-inner h-8 flex items-center justify-center ${progressColorClass}`;
                
                progressText.textContent = possibleScore > 0 ? `${percentage.toFixed(0)}%` : '';

                // Store summary for JSON export
                scoreSummary = {
                    score: percentage,
                    grade: grade,
                    actual: actualScore,
                    possible: possibleScore,
                };
            };
            
            const exportToJSON = () => {
                if (!appState.details || !appState.details.branch) {
                    alert('กรุณากรอกชื่อสาขาก่อนทำการ Export');
                    return;
                }
                
                const exportData = {
                    tool: 'checklist',
                    details: appState.details,
                    summary: scoreSummary,
                    data: appState.sections,
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Checklist_${appState.details.branch}_${appState.details.date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const exportToPDF = async () => {
                if (!appState.details || !appState.details.branch) {
                    alert('กรุณากรอกชื่อสาขาก่อนทำการ Export PDF');
                    return;
                }

                // Get button reference and store original text before try block
                const button = document.getElementById('export-pdf-button');
                const originalText = button.innerHTML;

                try {
                    // Show loading
                    button.innerHTML = '<svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>กำลังสร้าง PDF...';
                    button.disabled = true;

                    // Create temporary div for PDF content
                    const pdfContent = document.createElement('div');
                    pdfContent.style.width = '210mm';
                    pdfContent.style.minHeight = '297mm';
                    pdfContent.style.padding = '20mm';
                    pdfContent.style.backgroundColor = 'white';
                    pdfContent.style.fontFamily = 'Sarabun, sans-serif';
                    pdfContent.style.fontSize = '12pt';
                    pdfContent.style.lineHeight = '1.4';
                    pdfContent.style.position = 'absolute';
                    pdfContent.style.left = '-9999px';
                    pdfContent.style.top = '0';

                    // Add header
                    pdfContent.innerHTML = `
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div style="text-align: left; font-size: 10pt; font-weight: bold;">
                                    Operation Audit Division<br>
                                    (ฝ่ายตรวจสอบปฏิบัติการ)
                                </div>
                                <div style="text-align: right; font-size: 8pt; max-width: 280px;">
                                    บริษัท เอส พี วี ไอ จำกัด (มหาชน)<br>
                                    1550/5 อาคารธนิยะ พลาซ่า ชั้น 12A ถนนเพลินจิต<br>
                                    แขวงลุมพินี เขตปทุมวัน กรุงเทพมหานคร 10330<br>
                                    โทร. 0-2658-8881 แฟกซ์ 0-2658-8870
                                </div>
                            </div>
                            <h1 style="font-size: 18pt; font-weight: bold; margin: 0;">ใบสรุปผลการตรวจสอบสาขา</h1>
                            <p style="font-size: 12pt; color: #666; margin: 5px 0 0 0;">รายงานสรุปผลการดำเนินงานของสาขา</p>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h2 style="font-size: 14pt; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">รายละเอียดการตรวจสอบ</h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div><strong>สาขา:</strong> ${appState.details.branch || '-'}</div>
                                <div><strong>วันที่ตรวจสอบ:</strong> ${appState.details.date || '-'}</div>
                                <div><strong>เวลาที่ตรวจสอบ:</strong> ${appState.details.time || '-'}</div>
                            </div>
                            <div style="margin-top: 15px;">
                                <strong>คะแนนรวม:</strong> 
                                <span style="font-size: 14pt; font-weight: bold; color: ${scoreSummary.score >= 80 ? '#16a34a' : scoreSummary.score >= 60 ? '#f59e0b' : '#dc2626'};">
                                    ${scoreSummary.score.toFixed(2)}%
                                </span>
                                <span style="margin-left: 15px; padding: 3px 8px; border-radius: 4px; font-size: 10pt; background: ${scoreSummary.score >= 80 ? '#dcfce7' : scoreSummary.score >= 60 ? '#fef3c7' : '#fee2e2'}; color: ${scoreSummary.score >= 80 ? '#166534' : scoreSummary.score >= 60 ? '#92400e' : '#991b1b'};">
                                    ${scoreSummary.score >= 80 ? 'ผ่าน' : scoreSummary.score >= 60 ? 'ต้องปรับปรุง' : 'ไม่ผ่าน'}
                                </span>
                            </div>
                        </div>`;

                    // Add auditors section
                    if (appState.auditors && appState.auditors.length > 0) {
                        pdfContent.innerHTML += `
                            <div style="margin-bottom: 25px;">
                                <h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 10px;">ผู้ตรวจสอบ</h3>
                                ${appState.auditors.map((auditor, index) => `
                                    <div style="margin-bottom: 5px;">${index + 1}. ${auditor.name || '-'} (${auditor.position || '-'})</div>
                                `).join('')}
                            </div>`;
                    }

                    // Add checklist sections
                    Object.keys(appState.sections).forEach((sectionKey) => {
                        const sectionState = appState.sections[sectionKey];
                        const sectionTemplate = sections[sectionKey];
                        
                        if (!sectionTemplate) return; // Skip if section doesn't exist in template
                        
                        pdfContent.innerHTML += `
                            <div style="margin-bottom: 25px; page-break-inside: avoid;">
                                <h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 15px; color: #1e40af; border-left: 4px solid #3b82f6; padding-left: 10px;">${sectionKey}</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 11pt;">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: left; width: 60%;">รายการตรวจสอบ</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: center; width: 15%;">สถานะ</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: left; width: 25%;">หมายเหตุ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sectionState.map((stateItem, index) => {
                                            const templateItem = sectionTemplate[index];
                                            if (!templateItem) return ''; // Skip if template item doesn't exist
                                            
                                            return `
                                                <tr>
                                                    <td style="border: 1px solid #e2e8f0; padding: 8px;">${templateItem.text || '-'}</td>
                                                    <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">
                                                        <span style="padding: 2px 6px; border-radius: 3px; font-size: 10pt; font-weight: bold; background: ${
                                                            stateItem.status === 'pass' ? '#dcfce7; color: #166534' :
                                                            stateItem.status === 'fail' ? '#fee2e2; color: #991b1b' :
                                                            '#f3f4f6; color: #374151'
                                                        };">
                                                            ${stateItem.status === 'pass' ? 'ผ่าน' : stateItem.status === 'fail' ? 'ไม่ผ่าน' : 'N/A'}
                                                        </span>
                                                    </td>
                                                    <td style="border: 1px solid #e2e8f0; padding: 8px; font-size: 10pt;">${stateItem.notes || '-'}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    });

                    // Add legal declaration
                    pdfContent.innerHTML += `
                        <div style="margin-top: 40px; page-break-before: always;">
                            <div style="border: 2px solid #222; border-radius: 8px; background: #f7f7f7; padding: 15px; text-align: center; margin-bottom: 30px;">
                                <p style="margin: 0; font-size: 11pt; line-height: 1.4;">
                                    <strong>คำรับรองและคำประกาศความถูกต้อง</strong><br>
                                    ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องและครบถ้วนตามสภาพความเป็นจริง<br>
                                    และได้ปฏิบัติตามมาตรฐานการตรวจสอบของบริษัทอย่างเคร่งครัด
                                </p>
                                <p style="margin: 10px 0 0 0; font-size: 10pt; color: #666;">
                                    I certify that the information in this report is accurate and complete<br>
                                    and conducted in accordance with company audit standards
                                </p>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                                <div style="text-align: center; width: 45%;">
                                    <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                                    <div style="margin-bottom: 5px; font-weight: bold;">ลายเซ็นผู้ตรวจสอบ</div>
                                    <div style="margin-bottom: 20px; font-size: 10pt;">Auditor Signature</div>
                                    <div>วันที่ / Date: _______________</div>
                                </div>
                                <div style="text-align: center; width: 45%;">
                                    <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                                    <div style="margin-bottom: 5px; font-weight: bold;">ลายเซ็นผู้จัดการสาขา</div>
                                    <div style="margin-bottom: 20px; font-size: 10pt;">Branch Manager Signature</div>
                                    <div>วันที่ / Date: _______________</div>
                                </div>
                            </div>
                        </div>`;

                    document.body.appendChild(pdfContent);

                    // Generate PDF
                    const canvas = await html2canvas(pdfContent, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: 'white',
                        width: pdfContent.offsetWidth,
                        height: pdfContent.offsetHeight
                    });

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add first page
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Add additional pages if needed
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Clean up
                    document.body.removeChild(pdfContent);

                    // Download PDF
                    const fileName = `Checklist_${appState.details.branch}_${appState.details.date}.pdf`;
                    pdf.save(fileName);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('เกิดข้อผิดพลาดในการสร้าง PDF กรุณาลองใหม่อีกครั้ง');
                } finally {
                    // Restore button state
                    if (button) {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                }
            };

            const resetForm = (confirmReset = true) => { 
                const doReset = () => { 
                    localStorage.removeItem(getStorageKey()); 
                    auditDateInput.value = new Date().toISOString().substring(0, 10); 
                    loadState(); 
                }; 
                if (confirmReset) { 
                    if (confirm('คุณต้องการเริ่มการตรวจสอบใหม่หรือไม่? ข้อมูลที่กรอกในฟอร์มนี้จะถูกล้างทั้งหมด')) doReset(); 
                } else { 
                    doReset(); 
                } 
            };

            const initialize = () => {
                auditDateInput.value = new Date().toISOString().substring(0, 10);
                let sectionIndex = 0;
                sectionsContainer.innerHTML = Object.entries(sections)
                    .map(([title, items]) => createSectionHTML(title, items, sectionIndex++))
                    .join('');
                
                loadState();

                addAuditorBtn.addEventListener('click', () => addAuditorRow());
                document.getElementById('audit-details-container').addEventListener('input', saveState);
                sectionsContainer.addEventListener('input', (e) => { 
                    if (e.target.matches('input[type="radio"], textarea')) { 
                        saveState(); 
                    } 
                });
                auditDateInput.addEventListener('change', loadState);
                document.getElementById('reset-button').addEventListener('click', () => resetForm(true));
                document.getElementById('export-pdf-button').addEventListener('click', exportToPDF);
                document.getElementById('export-json-button').addEventListener('click', exportToJSON);
            };
            
            initialize();
        });



        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                await SPViAuth.initializeFirebase();
                
                // Check authentication - redirect to login if not authenticated
                const isAuthenticated = await SPViAuth.checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = '../index.html';
                    return;
                }
                
                // User info will be added automatically by firebase-auth.js init()
                // No need to call addUserInfo() manually
                
                // Setup centralized devtools protection
                SPViAuth.setupDevToolsProtection();

                // Check tool access permission after authentication is confirmed
                if (window.SPViSessionManager && window.SPViSessionManager.checkToolAccess) {
                    const hasAccess = await window.SPViSessionManager.checkToolAccess('checklist');
                    if (!hasAccess) {
                        // Access denied - modal will be shown by checkToolAccess function
                        // Optionally hide main content
                        document.querySelector('main')?.style.setProperty('display', 'none');
                    }
                }
            } catch (error) {
                // Authentication error handled silently for production
                // If authentication fails, redirect to login
                window.location.href = '../index.html';
            }
        });
    </script>
</body>
</html>
