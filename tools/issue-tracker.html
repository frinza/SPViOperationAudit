<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามประเด็น (Issue Tracker) - Google Script</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration Manager -->
    <script src="../config.js"></script>
    
    <!-- Session Manager -->
    <script src="../session-manager.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <link rel="stylesheet" href="../styles/print-legal.css">
    <!-- Global Print Header -->
    <link rel="stylesheet" href="../styles/print-header.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 90%; max-width: 500px;
        }
        tr.is-new { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { background-color: #eff6ff; } to { background-color: white; } }

        /* Status-based row colors */
        .status-pending {
            background-color: #fef2f2; /* red-50 */
            border-left: 4px solid #ef4444; /* red-500 */
        }
        .status-pending:hover {
            background-color: #fecaca; /* red-100 */
        }
        
        .status-in-progress {
            background-color: #fefce8; /* yellow-50 */
            border-left: 4px solid #eab308; /* yellow-500 */
        }
        .status-in-progress:hover {
            background-color: #fef3c7; /* yellow-100 */
        }
        
        .status-completed {
            background-color: #f0fdf4; /* green-50 */
            border-left: 4px solid #22c55e; /* green-500 */
        }
        .status-completed:hover {
            background-color: #dcfce7; /* green-100 */
        }

        /* Notification Bell Styling */
        .spvi-notification-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: scale(1.05);
        }
        
        .spvi-notification-btn:active {
            transform: scale(0.95);
        }
        
        /* Modal styling for notifications */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-backdrop.hidden {
            display: none;
        }

        /* Mobile Responsive Table Enhancements */
        @media (max-width: 768px) {
            /* Hide traditional table structure on mobile */
            .mobile-hidden {
                display: none !important;
            }
            
            /* Card-based layout for mobile */
            .mobile-card-view {
                display: block !important;
            }
            
            /* ENHANCED MOBILE CARDS - IMPROVED UI/UX */
            .issue-card {
                background: white !important;
                border-radius: 0.75rem !important;
                border: 1px solid #e2e8f0 !important;
                margin-bottom: 0.75rem !important;
                margin-top: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding: 1rem !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
                transition: all 0.3s ease !important;
                position: relative !important;
                min-height: 44px !important; /* iOS touch target minimum */
            }
            
            .issue-card:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px);
            }
            
            .issue-card.status-pending {
                border-left: 6px solid #ef4444;
                background-color: #fef2f2;
            }
            
            .issue-card.status-in-progress {
                border-left: 6px solid #eab308;
                background-color: #fefce8;
            }
            
            .issue-card.status-completed {
                border-left: 6px solid #22c55e;
                background-color: #f0fdf4;
            }
            
            /* IMPROVED SPACING AND TYPOGRAPHY */
            .issue-card-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                margin-bottom: 0.75rem !important;
                margin-top: 0 !important;
                gap: 0.75rem !important;
                padding: 0 !important;
            }
            
            .issue-card-title {
                font-weight: 700 !important;
                color: #1f2937 !important;
                flex: 1 !important;
                font-size: 1rem !important;
                line-height: 1.3 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .status-indicator-container {
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
                margin: 0 !important;
                padding: 0.25rem 0.75rem !important;
                background: rgba(255, 255, 255, 0.8) !important;
                border-radius: 1rem !important;
                backdrop-filter: blur(4px) !important;
            }
            
            .status-dot {
                width: 10px !important;
                height: 10px !important;
                border-radius: 50% !important;
                display: inline-block !important;
                margin: 0 !important;
                padding: 0 !important;
                flex-shrink: 0 !important;
            }
            
            .status-dot.pending {
                background-color: #ef4444 !important;
                box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
            }
            
            .status-dot.in-progress {
                background-color: #eab308 !important;
                box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2) !important;
            }
            
            .status-dot.completed {
                background-color: #22c55e !important;
                box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2) !important;
            }
            
            .status-text {
                font-size: 0.875rem !important;
                font-weight: 600 !important;
                color: #374151 !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1 !important;
            }
            
            .issue-card-content {
                color: #4b5563 !important;
                margin-bottom: 0.75rem !important;
                margin-top: 0 !important;
                line-height: 1.5 !important;
                font-size: 0.9rem !important;
                background: rgba(0, 0, 0, 0.02) !important;
                padding: 0.75rem !important;
                border-radius: 0.5rem !important;
                border-left: 3px solid #e5e7eb !important;
                border-top: none !important;
                border-right: none !important;
                border-bottom: none !important;
            }
            
            .issue-card-meta {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            /* IMPROVED MOBILE CONTROLS */
            .issue-card-single-row {
                display: flex !important;
                gap: 0.5rem !important;
                align-items: end !important;
                flex-wrap: wrap !important;
                margin-top: 0.75rem !important;
                margin-bottom: 0 !important;
                padding: 0.75rem 0 0 0 !important;
                border-top: 1px solid #e5e7eb !important;
            }
            
            .issue-card-field-inline {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.25rem !important;
                min-width: 100px !important;
                max-width: 100px !important;
                flex: 0 0 100px !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .issue-card-field-inline.flex-grow {
                flex: 1 !important;
                min-width: 120px !important;
                max-width: none !important;
            }
            
            .issue-card-actions-inline {
                display: flex !important;
                gap: 0.5rem !important;
                margin-left: auto !important;
                margin-top: 0.25rem !important;
                margin-bottom: 0 !important;
                margin-right: 0 !important;
                padding: 0 !important;
            }
            
            .issue-card-field {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .issue-card-field.mb-3 {
                margin-bottom: 0.75rem;
            }
            
            .issue-card-field label {
                font-size: 0.7rem;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }
            
            .issue-card-field select,
            .issue-card-field input,
            .issue-card-field-inline select,
            .issue-card-field-inline input {
                width: 100%;
                padding: 0.5rem !important;
                border: 2px solid #d1d5db;
                border-radius: 0.5rem;
                font-size: 0.875rem !important;
                background: white;
                transition: all 0.2s ease;
                min-height: 44px !important;
                height: 44px !important;
                box-sizing: border-box;
                -webkit-appearance: none;
                appearance: none;
            }
            
            .issue-card-field select:focus,
            .issue-card-field input:focus,
            .issue-card-field-inline select:focus,
            .issue-card-field-inline input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: #fafbff;
            }
            
            .issue-card-field-inline label {
                font-size: 0.75rem !important;
                font-weight: 700;
                color: #374151;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-bottom: 0.25rem !important;
                line-height: 1 !important;
            }
            
            .issue-card-actions {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                padding-top: 0.75rem;
                border-top: 1px solid #e5e7eb;
                margin-top: 0.75rem;
            }
            
            /* ENHANCED MOBILE BUTTONS */
            .issue-card-btn {
                padding: 0.75rem 1rem !important;
                border-radius: 0.5rem;
                font-size: 0.875rem !important;
                font-weight: 700;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                min-height: 44px !important;
                min-width: 80px !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .issue-card-btn:active {
                transform: translateY(1px);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .issue-card-btn-edit {
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
            }
            
            .issue-card-btn-edit:hover {
                background: linear-gradient(135deg, #2563eb, #1d4ed8);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            }
            
            .issue-card-btn-delete {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
            }
            
            .issue-card-btn-delete:hover {
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            }
            
            /* Mobile-specific improvements */
            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            /* Ensure mobile card container has proper spacing */
            #issue-cards {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Override any inherited spacing from parent containers */
            .bg-white.p-6 #issue-cards,
            .bg-white #issue-cards {
                padding: 0 !important;
            }
            
            /* Enhanced responsive breakpoints for very small screens */
            @media (max-width: 500px) {
                /* Fix container padding for small screens */
                .container {
                    padding-left: 0.5rem !important;
                    padding-right: 0.5rem !important;
                }
                
                /* Ensure main content container has proper margins */
                .bg-white.p-6 {
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                    padding: 0.75rem !important;
                }
                
                /* Fix input containers alignment */
                .issue-card-single-row {
                    flex-direction: column !important;
                    gap: 0.5rem !important;
                    align-items: stretch !important;
                    padding: 0.5rem 0 0 0 !important;
                    overflow: hidden !important;
                }
                
                .issue-card-field-inline {
                    min-width: unset !important;
                    max-width: 100% !important;
                    flex: 1 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .issue-card-field-inline.flex-grow {
                    min-width: unset !important;
                    max-width: 100% !important;
                    flex: 1 !important;
                    width: 100% !important;
                }
                
                /* Ensure input fields don't overflow */
                .issue-card-field-inline select,
                .issue-card-field-inline input {
                    width: 100% !important;
                    max-width: 100% !important;
                    box-sizing: border-box !important;
                    font-size: 0.875rem !important;
                    padding: 0.625rem !important;
                }
                
                .issue-card-actions-inline {
                    margin-left: 0 !important;
                    justify-content: center !important;
                    margin-top: 0.75rem !important;
                    padding-top: 0.75rem !important;
                    border-top: 1px solid #e5e7eb !important;
                    width: 100% !important;
                    flex-wrap: wrap !important;
                }
                
                .issue-card-btn {
                    flex: 1 !important;
                    min-width: 120px !important;
                    max-width: 100% !important;
                    margin-bottom: 0.25rem !important;
                }
                
                /* Fix header alignment on small screens */
                header h1 {
                    font-size: 1.5rem !important;
                    line-height: 1.2 !important;
                    padding: 0 0.5rem !important;
                }
                
                header p {
                    font-size: 0.875rem !important;
                    padding: 0 0.5rem !important;
                }
                
                /* Ensure issue cards don't overflow */
                .issue-card {
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                    padding: 0.75rem !important;
                    overflow: hidden !important;
                    word-wrap: break-word !important;
                }
                
                /* Fix modal on very small screens */
                .modal-content {
                    margin: 0.5rem !important;
                    padding: 1rem !important;
                    max-width: calc(100vw - 1rem) !important;
                    width: calc(100vw - 1rem) !important;
                }
            }
            
            /* Ultra-small screen support for iPhone SE and similar devices */
            @media (max-width: 375px) {
                /* More aggressive padding reduction */
                .container {
                    padding-left: 0.25rem !important;
                    padding-right: 0.25rem !important;
                }
                
                .bg-white.p-6 {
                    padding: 0.5rem !important;
                }
                
                /* Tighter spacing for issue cards */
                .issue-card {
                    padding: 0.5rem !important;
                    margin-bottom: 0.5rem !important;
                }
                
                /* Smaller font sizes for ultra-small screens */
                .issue-card-title {
                    font-size: 0.8rem !important;
                    line-height: 1.1 !important;
                }
                
                .issue-card-content {
                    font-size: 0.8rem !important;
                    padding: 0.5rem !important;
                }
                
                /* Compact input fields */
                .issue-card-field-inline select,
                .issue-card-field-inline input {
                    font-size: 0.8rem !important;
                    padding: 0.5rem !important;
                    min-height: 40px !important;
                }
                
                /* Smaller buttons */
                .issue-card-btn {
                    font-size: 0.8rem !important;
                    padding: 0.5rem 0.75rem !important;
                    min-height: 40px !important;
                    min-width: 100px !important;
                }
                
                /* Compact header */
                header h1 {
                    font-size: 1.25rem !important;
                    padding: 0 0.25rem !important;
                }
                
                header p {
                    font-size: 0.8rem !important;
                    padding: 0 0.25rem !important;
                }
                
                /* Compact modal for ultra-small screens */
                .modal-content {
                    margin: 0.25rem !important;
                    padding: 0.75rem !important;
                    max-width: calc(100vw - 0.5rem) !important;
                    width: calc(100vw - 0.5rem) !important;
                }
                
                .modal-content input,
                .modal-content textarea,
                .modal-content select {
                    font-size: 0.8rem !important;
                    padding: 0.5rem !important;
                    min-height: 40px !important;
                }
                
                /* Tighter spacing for inline actions */
                .issue-card-single-row {
                    gap: 0.25rem !important;
                    padding: 0.25rem 0 0 0 !important;
                }
                
                .issue-card-actions-inline {
                    margin-top: 0.5rem !important;
                    padding-top: 0.5rem !important;
                    gap: 0.25rem !important;
                }
                
                /* Compact meta grid */
                .issue-card-meta {
                    gap: 0.5rem !important;
                    margin-bottom: 0.5rem !important;
                }
                
                /* Ensure proper text wrapping on ultra-small screens */
                .issue-card-content,
                .issue-card-title {
                    word-break: break-word !important;
                    overflow-wrap: break-word !important;
                    hyphens: auto !important;
                }
            }
            
            header h1 {
                font-size: 2rem !important;
                line-height: 1.2 !important;
            }
            
            header p {
                font-size: 0.875rem !important;
                margin-top: 0.75rem !important;
            }
            
            /* Improve button and input layout on mobile */
            .bg-white.p-6 {
                padding: 1.25rem !important;
                border-radius: 1rem !important;
            }
            
            .flex.flex-col.md\\:flex-row {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            #add-issue-btn {
                width: 100% !important;
                min-height: 52px !important;
                font-size: 1.1rem !important;
                font-weight: 700 !important;
                border-radius: 0.75rem !important;
                background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
                transition: all 0.3s ease !important;
            }
            
            #add-issue-btn:hover {
                background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4) !important;
            }
            
            #add-issue-btn:active {
                transform: translateY(0) !important;
            }
            
            #filter-input {
                min-height: 52px !important;
                font-size: 1rem !important;
                padding: 0.75rem !important;
                border-radius: 0.75rem !important;
                border: 2px solid #d1d5db !important;
                transition: all 0.2s ease !important;
            }
            
            #filter-input:focus {
                border-color: #3b82f6 !important;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            }
            
            /* Enhanced filter controls on mobile */
            #status-filter, #assignee-filter {
                min-height: 52px !important;
                font-size: 1rem !important;
                padding: 0.75rem !important;
                border-radius: 0.75rem !important;
                border: 2px solid #d1d5db !important;
                background: white !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                transition: all 0.2s ease !important;
            }
            
            #status-filter:focus, #assignee-filter:focus {
                border-color: #3b82f6 !important;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            }
            
            #clear-filters-btn {
                min-height: 52px !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                width: 100% !important;
                border-radius: 0.75rem !important;
                transition: all 0.3s ease !important;
            }
            
            /* Make filter row stack on mobile */
            .flex.flex-col.sm\\:flex-row {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            /* Enhanced modal on mobile */
            .modal-content {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
                padding: 2rem !important;
                border-radius: 1rem !important;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
            }
            
            /* Improve modal form on mobile */
            .modal-content input,
            .modal-content textarea,
            .modal-content select {
                min-height: 52px !important;
                font-size: 1rem !important;
                padding: 0.75rem !important;
                border-radius: 0.75rem !important;
                border: 2px solid #d1d5db !important;
                transition: all 0.2s ease !important;
            }
            
            .modal-content input:focus,
            .modal-content textarea:focus,
            .modal-content select:focus {
                border-color: #3b82f6 !important;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            }
            
            .modal-content button {
                min-height: 52px !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                padding: 0.75rem 1.5rem !important;
                border-radius: 0.75rem !important;
                transition: all 0.3s ease !important;
            }
        }
        
        /* Tablet optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            /* Table still visible but optimized for tablet */
            .container {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
            
            /* Further reduce table cell padding for tablet */
            .min-w-full td {
                padding: 0.5rem 0.375rem !important;
            }
            
            .min-w-full th {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.7rem !important;
            }
            
            /* Smaller input fields in table */
            .status-select, .field-input {
                padding: 0.25rem !important;
                font-size: 0.75rem !important;
                min-width: 100px !important;
            }
            
            /* Compact action buttons */
            .text-right.whitespace-nowrap button {
                display: inline-block !important;
                font-size: 0.7rem !important;
                padding: 0.25rem 0.5rem !important;
                margin: 0.125rem !important;
            }
            
            /* Ensure text wraps properly */
            .max-w-xs {
                max-width: 200px !important;
            }
        }
        
        /* Default card view is hidden */
        .mobile-card-view {
            display: none;
        }

        /* Filter active states */
        .filter-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        .clear-filters-visible {
            background-color: #f59e0b !important;
            color: white !important;
        }
        
        .clear-filters-visible:hover {
            background-color: #d97706 !important;
        }

        /* Enhanced collision fix is now in global print-legal.css */
        
        /* ULTRA COMPACT MOBILE CARD OVERRIDES - HIGHEST SPECIFICITY */
        @media (max-width: 768px) {
            /* Override any external CSS that might affect card spacing */
            #issue-cards .issue-card,
            .mobile-card-view .issue-card {
                margin: 0 0 0.5rem 0 !important;
                padding: 0.5rem !important;
            }
            
            /* Preserve status-based background colors and borders */
            #issue-cards .issue-card.status-pending,
            .mobile-card-view .issue-card.status-pending {
                border-left: 4px solid #ef4444 !important;
                background-color: #fef2f2 !important;
            }
            
            #issue-cards .issue-card.status-pending:hover,
            .mobile-card-view .issue-card.status-pending:hover {
                background-color: #fecaca !important;
            }
            
            #issue-cards .issue-card.status-in-progress,
            .mobile-card-view .issue-card.status-in-progress {
                border-left: 4px solid #eab308 !important;
                background-color: #fefce8 !important;
            }
            
            #issue-cards .issue-card.status-in-progress:hover,
            .mobile-card-view .issue-card.status-in-progress:hover {
                background-color: #fef3c7 !important;
            }
            
            #issue-cards .issue-card.status-completed,
            .mobile-card-view .issue-card.status-completed {
                border-left: 4px solid #22c55e !important;
                background-color: #f0fdf4 !important;
            }
            
            #issue-cards .issue-card.status-completed:hover,
            .mobile-card-view .issue-card.status-completed:hover {
                background-color: #dcfce7 !important;
            }
            
            #issue-cards .issue-card .issue-card-header,
            .mobile-card-view .issue-card .issue-card-header {
                margin: 0 0 0.5rem 0 !important;
                padding: 0 !important;
            }
            
            #issue-cards .issue-card .issue-card-content,
            .mobile-card-view .issue-card .issue-card-content {
                margin: 0 0 0.5rem 0 !important;
                padding: 0.375rem !important;
            }
            
            #issue-cards .issue-card .issue-card-single-row,
            .mobile-card-view .issue-card .issue-card-single-row {
                margin: 0.375rem 0 0 0 !important;
                padding: 0 !important;
                gap: 0.375rem !important;
            }
            
            #issue-cards .issue-card .issue-card-field-inline,
            .mobile-card-view .issue-card .issue-card-field-inline {
                margin: 0 !important;
                padding: 0 !important;
                gap: 0.125rem !important;
            }
            
            #issue-cards .issue-card .issue-card-actions-inline,
            .mobile-card-view .issue-card .issue-card-actions-inline {
                margin: 0.125rem 0 0 auto !important;
                padding: 0 !important;
                gap: 0.125rem !important;
            }
            
            /* Override any Tailwind utility classes that might interfere */
            .issue-card [class*="m-"],
            .issue-card [class*="p-"],
            .issue-card [class*="gap-"],
            .issue-card [class*="space-"] {
                margin: inherit !important;
                padding: inherit !important;
                gap: inherit !important;
            }
        }
        
        /* Table improvements */
        .min-w-full {
            table-layout: fixed;
        }
        
        .min-w-full td {
            word-wrap: break-word;
            vertical-align: top;
        }
        
        /* Status column specific styling */
        .status-select {
            min-width: 120px;
        }
        
        /* Text clamping for issue content */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
        }
        
        .dropdown-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }
        
        .dropdown-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dropdown-search {
            width: 100%;
            padding: 0.5rem;
            border: none;
            outline: none;
            font-size: 1rem;
            background: transparent;
        }
        
        /* Mobile improvements for dropdown */
        @media (max-width: 768px) {
            .dropdown-search {
                font-size: 16px; /* Prevent iOS zoom */
                min-height: 52px; /* Enhanced touch-friendly */
                padding: 0.75rem;
                border-radius: 0.75rem;
            }
            
            .dropdown-input {
                min-height: 52px;
                border-radius: 0.75rem;
                border: 2px solid #d1d5db;
                transition: all 0.2s ease;
            }
            
            .dropdown-input:focus-within {
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            .dropdown-item {
                padding: 1rem 0.75rem;
                min-height: 52px;
                display: flex;
                align-items: center;
                font-size: 1rem;
                transition: all 0.2s ease;
            }
            
            .dropdown-item:hover {
                background-color: #f1f5f9;
                transform: translateX(4px);
            }
            
            .dropdown-menu {
                border-radius: 0 0 0.75rem 0.75rem;
                border: 2px solid #d1d5db;
                border-top: none;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            }
        }
        
        .dropdown-arrow {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .dropdown-arrow.open {
            transform: rotate(180deg);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
            line-height: 1.2;
        }
        
        .dropdown-item:hover {
            background-color: #f8fafc;
        }
        
        .dropdown-item.selected {
            background-color: #eff6ff;
            color: #1e40af;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .no-results {
            padding: 0.75rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 logged-in">  
    <!-- Global Print Header Section -->
    <div class="print-header-section"></div>
    
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">ระบบติดตามประเด็น (Issue Tracker)</h1>
            <p class="mt-2 text-slate-500">จัดการและติดตามรายการที่ต้องแก้ไขจากการตรวจสอบทั้งหมด</p>
             <div id="connection-status" class="mt-4 text-sm text-slate-400">Loading...</div>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <!-- Filters Section -->
            <div class="flex flex-col gap-4 mb-6">
                <!-- Top row: Add button and search -->
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="add-issue-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        + เพิ่มประเด็นใหม่
                    </button>
                    <input type="text" id="filter-input" placeholder="ค้นหาประเด็น..." class="w-full md:flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
                
                <!-- Filter controls row -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="status-filter" class="block text-sm font-medium text-slate-700 mb-1">กรองตามสถานะ:</label>
                        <select id="status-filter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="">ทุกสถานะ</option>
                            <option value="รอดำเนินการ">รอดำเนินการ</option>
                            <option value="กำลังแก้ไข">กำลังแก้ไข</option>
                            <option value="เสร็จสิ้น">เสร็จสิ้น</option>
                        </select>
                    </div>
                    
                    <div class="flex-1">
                        <label for="assignee-filter" class="block text-sm font-medium text-slate-700 mb-1">กรองตามผู้รับผิดชอบ:</label>
                        <select id="assignee-filter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="">ทุกคน</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col items-start gap-2">
                        <div id="results-counter" class="text-sm text-slate-600 font-medium"></div>
                        <button id="clear-filters-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                            ล้างตัวกรอง
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Desktop Table View -->
            <div class="overflow-x-auto mobile-hidden">
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-1/6">สาขา</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-2/6">ประเด็น</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-1/6">สถานะ</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-1/6">ผู้รับผิดชอบ</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-1/12">ครบกำหนด</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-slate-500 uppercase tracking-wider w-1/12">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="issue-list" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="6" class="text-center p-8 text-slate-500">กำลังโหลดข้อมูล...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Card View -->
            <div id="issue-cards" class="mobile-card-view">
                <div class="text-center p-8 text-slate-500">กำลังโหลดข้อมูล...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="issue-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">เพิ่มประเด็นใหม่</h2>
            <form id="issue-form">
                <input type="hidden" id="modal-issue-id">
                <div class="mb-4">
                    <label for="modal-branch" class="block text-sm font-medium text-slate-700 mb-1">
                        ชื่อสาขา <span class="text-red-500">*</span>
                    </label>
                    <div class="searchable-dropdown" id="branch-dropdown">
                        <div class="dropdown-input" id="branch-input" tabindex="0">
                            <input type="text" class="dropdown-search" id="branch-search" placeholder="ค้นหาหรือเลือกชื่อสาขา..." autocomplete="off">
                            <span class="dropdown-arrow" id="branch-arrow">▼</span>
                        </div>
                        <div class="dropdown-menu" id="branch-menu">
                            <!-- Branch options will be populated here -->
                        </div>
                    </div>
                    <input type="hidden" id="modal-branch" required>
                </div>
                <div class="mb-6">
                    <label for="modal-issue" class="block text-sm font-medium text-slate-700 mb-1">รายละเอียดประเด็น</label>
                    <textarea id="modal-issue" rows="3" class="w-full p-2 border border-slate-300 rounded-lg" required></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="modal-cancel-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                    <button type="submit" id="modal-save-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">ยืนยันการลบ</h2>
            <p>คุณต้องการลบประเด็นนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="delete-cancel-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">ยกเลิก</button>
                <button type="button" id="delete-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">ยืนยันการลบ</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firestore Configuration ---
        let allIssues = [];
        let issueToDeleteId = null;
        let allUsers = []; // Store all users for assignee dropdown
        let overdueNotifications = []; // Store overdue notifications
        const issueListEl = document.getElementById('issue-list');
        const issueCardsEl = document.getElementById('issue-cards');
        const filterInput = document.getElementById('filter-input');
        const statusFilter = document.getElementById('status-filter');
        const assigneeFilter = document.getElementById('assignee-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const resultsCounter = document.getElementById('results-counter');
        const statusEl = document.getElementById('connection-status');
        const addIssueBtn = document.getElementById('add-issue-btn');
        const issueModal = document.getElementById('issue-modal');
        const deleteModal = document.getElementById('delete-modal');
        const issueForm = document.getElementById('issue-form');
        let firestore = null;
        let issuesCollection = null;

        // --- Branch Data ---
        const branchList = [
            "B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) Iphone",
            "B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) SVOA",
            "B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) อุปกรณ์เสริม",
            "B002 IBeat – IT Mall ไอที มอลล์ ฟอร์จูน (B-IT)",
            "B004 IBeat Esplanade เอสพลานาด ซีนีเพล็กซ์ รัชดาภิเษก(B-ES)",
            "B006 Ustore TU Rungsit มหาวิทยาลัยธรรมศาสตร์ รังสิต (TUR)",
            "B007 Ustore ABAC Bangna มหาวิทยาลัยอัสสัมชัญ สุวรรณภูมิ (ABB)",
            "B008 Ustore TU Thaprajan มหาวิทยาลัยธรรมศาสตร์ ท่าพระจันทร์ (TUT)",
            "B009 iStudio Central Chaengwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (S-CW)",
            "B010 iStudio Seacon Square ซีคอนสแควร์ ศรีนครินทร์ (S-SQ)",
            "B012 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ บางเขน (KU)",
            "B013 Ustore Mahidol University มหาวิทยาลัยมหิดล ศาลายา(MU)",
            "B016 Ustore Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (BUR)",
            "B017 Ustore Dhurakij Pundit University มหาวิทยาลัยธุรกิจบัณฑิตย์(DPU)",
            "B018 iStudio Central Rama 9 เซ็นทรัลพลาซา แกรนด์ พระราม 9 (S-CR)",
            "B019 Ustore Burapha University มหาวิทยาลัยบูรพา (BUU)",
            "B020 iCenter Central Changwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (C-CCW)",
            "B021 IBeat Gateway Ekamai เกตเวย์ เอกมัย (B-GE)",
            "B024 IBeat – Central Chiang Rai เซ็นทรัล เชียงราย (B-CCR)",
            "B031 iStudio Central Rayong เซ็นทรัลพลาซา ระยอง (S-CRY)",
            "B032 iCenter Central Chiang Rai เซ็นทรัลเชียงราย (C-CCR)",
            "B034 AIS Lotus Rayong โลตัสระยอง (A-LR)",
            "B035 AIS Big C Aranyaprathet บิ๊กซี อรัญประเทศ(A-BA)",
            "B036 iCenter Laemtong Rayong แหลมทอง ระยอง (C-LRY)",
            "B037 Mobi Phayao พะเยา (M-PY)",
            "B038 Mobi Lumphun ลำพูน (M-LP)",
            "B039 iCenter Homepro Nakhonpatom ศูนย์การค้าโฮมโปรนครปฐม (I-HNT)",
            "B040 AIS Robinson Lifestyle Chanthaburiโรบินสัน ไลฟ์สไตล์ จันทบุรี (A-RJ)",
            "B044 AIS Telewiz Lotus Rojana โลตัส โรจนะ (A-LRJ)",
            "B046 AIS Lotus Ban Chang โลตัส บ้านฉาง (A-LC)",
            "B047 AIS Telewiz Lotus lom sak โลตัส หล่มสัก(A-LL)",
            "B048 I Beat Robinson kampaeng phet โรบินสัน กำแพงเพชร (B-RK)",
            "B049 Mobi phichit พิจิตร (M-PJ)",
            "B050 AIS Telewiz Big C Wichian Buri บิ๊กซี วิเชียรบุรี(A-BW)",
            "B051 AIS Robinson Kamphaeng Phet โรบินสันกำแพงเพชร(A-RK)",
            "B052 AIS Buddy phayao ศูนย์การค้า ท็อปส์ พลาซ่า พะเยา (A-PY)",
            "B053 AIS Lotus Phetchaboon โลตัส เพชรบูรณ์ (A-LP)",
            "B054 AIS shop Big C sattahip ศูนย์การค้าบิ๊กซีซุปเปอร์เซนเตอร์สาขาสัตหีบ (A-BS)",
            "B055 iCenter G Tower อาคารจี ทาวเวอร์ แกรนด์ พระราม 9 (C-GR)",
            "B056 AIS robinson chonburi โรบินสันชลบุรี2 (อมตะนคร) (A-RC)",
            "B058 AIS Telewiz U-Tapao โลตัส สาขาอู่ตะเภา (A-UT)",
            "B059 AIS Central Rayong เซ็นทรัล พลาซา สาขา ระยอง (A-CR)",
            "B061 Ustore Mae Fah Luang University มหาวิทยาลัยแม่ฟ้าหลวง(MFU)",
            "B062 Ustore KMUTNB พระจอมเกล้าพระนครเหนือ (KMU)",
            "B063 Ustore Naresuan University มหาวิทยาลัยนเรศวร(NU)",
            "B064 AIS Telewiz Si-Thap ศรีเทพ(A-ST)",
            "B065 Ustore Mahasarakham University มหาวิทยาลัยมหาสารคาม",
            "B066 Ustore Rambhai Barni Rajabhat University มรภ.รำไพพรรณี (RBRU)",
            "B067 Ustore Chiang Mai Rajabhat University มรภ.เชียงใหม่ (CMRU)",
            "B068 A-Store มหาวิทยาลัยศรีนครินทรวิโรฒ ประสานมิตร (A-SWU)",
            "B069 Ustore Prince of Songkla University มหาวิทยาลัยสงขลานครินทร์ (PSU)",
            "B070 A-Store มหาวิทยาลัยสงขลานครินทร์ (A-PSU)",
            "B071 Ustore University of Phayao มหาวิทยาลัยพะเยา (UP)",
            "B072 Ustore SUT มหาวิทยาลัยเทคโนโลยีสุรนารี (SUT)",
            "B073 Ustore Maejo University มหาวิทยาลัยแม่โจ้ (MJU)",
            "B074 Ustore RMUTT มหาวิทยาลัยเทคโนโลยีราชมงคลธัญบุรี(RMUTT)",
            "B075 AIS Telewiz Lotus Chonburi โลตัส สาขา ชลบุรี (A-LCB)",
            "B076 A-Store มหาวิทยาลัยมหิดล ศาลายา (A-MU)",
            "B077 iCenter Phuke ศูนย์การค้าเซ็นทรัล ภูเก็ต (I-PNPT)",
            "B078 AIS Robinson Mae Sot โรบินสัน แม่สอด (A-RM)",
            "B079 A-Store มหาวิทยาลัยเทคโนโลยีสุรนารี (A-SUT)",
            "B080 Icenter Robinson Chanthaburi โรบินสันไลฟ์สไตล์ จันทบุรี (I-RJ)",
            "B081 AIS Telewiz Laemtong Chonburi แหลมทองชลบุรี(A-LCH)",
            "B083 A-Store Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (A-BU)",
            "B084 Mobi Suvarnabhumi มาร์เก็ตวิลเลจ สุวรรณภูมิ(M-MS)",
            "B085 Ustore Nakhon Pathom Rajabhat University มรภ.นครปฐม (NPRU)",
            "B087 AIS Robinson Ban Chang โรบินสัน บ้านฉาง(A-RB)",
            "B089 A-Store มหาวิทยาลัยแม่ฟ้าหลวง (A-MFU)",
            "B090 U Store Pibulsongkram Rajabhat University มรภ.พิบูลสงคราม(PSRU)",
            "B091 A-Store มหาวิทยาลัยราชภัฏเชียงใหม่ (A-CMRU)",
            "B092 AIS Shop Robinson Lifestyle Thalang โรบินสัน ไลฟ์สไตล์ ถลาง(A-RT)",
            "B093 Ustore TU Rungsit-MED ม.ธรรมศาสตร์รังสิต คณะแพทย์ฯ (TUMED)",
            "B094 U Store SIAMSCAPE สยามสเคป",
            "B095 A-Store มหาวิทยาลัยมหาสารคาม (A-MSU)",
            "B096 A-Store มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (A-KUSRC)",
            "B097 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (U-KUSRC)",
            "B098 Mobi Lotus Bo Win โลตัส บ่อวิน(M-LBV)",
            "B099 AIS Mini Shop Lotus Pak Kret โลตัสปากเกร็ด (M-LPK)",
            "B100 AIS Telewiz Lotus Sattahip โลตัสสัตหีบ(A-LS)",
            "B101 AIS Buddy Krua Sahapat เครือสหพัฒน์ จ.ชลบุรี (A-KS)",
            "B102 A-Store Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ (KU)",
            "B103 Ustore RMUTK มหาวิทยาลัยเทคโนโลยีราชมงคลกรุงเทพ(RMUTK)",
            "B104 Ustore Phranakhon Rajabhat Universityมหาวิทยาลัยราชภัฏพระนคร(PNRU)",
            "B105 Ustore Nakhon Sawan Rajabhat University มหาวิทยาลัยราชภัฐนครสวรรค์",
            "B106 iStudio Central Westville ราชพฤกษ์(ศูนย์ iCenter)",
            "B107 iStudio Central Nakhon Sawan เซ็นทรัล นครสวรรค์ (ศูนย์ iCenter)",
            "B109 AIS Telewiz Lotus พะเยา(A-LPY)",
            "B110 Mobi Esplanade",
            "ตรวจสอบการตรวจนับสินค้าผ่านระบบ Smart Core",
            "ตรวจสอบ Operation HQ",
            "B111 Head Office <AIS Shop Robinson Chalong>",
            "B112 Head Office <AIS Telewiz Lotus Samkong>"
        ];

        // --- Searchable Dropdown Functions ---
        let selectedBranchValue = '';
        let isDropdownInitialized = false;
        let dropdownElements = null;
        
        function initializeBranchDropdown() {
            // Return early if already initialized
            if (isDropdownInitialized) return;
            
            // Cache elements for better performance and reliability
            dropdownElements = {
                branchInput: document.getElementById('branch-input'),
                branchSearch: document.getElementById('branch-search'),
                branchArrow: document.getElementById('branch-arrow'),
                branchMenu: document.getElementById('branch-menu'),
                modalBranch: document.getElementById('modal-branch'),
                dropdown: document.getElementById('branch-dropdown')
            };
            
            // Check if all elements exist before proceeding
            if (!dropdownElements.branchInput || !dropdownElements.branchSearch || 
                !dropdownElements.branchArrow || !dropdownElements.branchMenu || 
                !dropdownElements.modalBranch || !dropdownElements.dropdown) {
                console.warn('Branch dropdown elements not found, retrying in 100ms');
                setTimeout(initializeBranchDropdown, 100);
                return;
            }
            
            // Populate dropdown options
            function populateDropdown(searchTerm = '') {
                const filteredBranches = branchList.filter(branch => 
                    branch.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                dropdownElements.branchMenu.innerHTML = '';
                
                if (filteredBranches.length === 0) {
                    dropdownElements.branchMenu.innerHTML = '<div class="no-results">ไม่พบสาขาที่ตรงกัน</div>';
                } else {
                    filteredBranches.forEach(branch => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        
                        // Highlight matching text
                        if (searchTerm) {
                            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                            const highlightedText = branch.replace(regex, '<mark style="background-color: #fef3c7; color: #92400e;">$1</mark>');
                            item.innerHTML = highlightedText;
                        } else {
                            item.textContent = branch;
                        }
                        
                        item.addEventListener('click', () => selectBranch(branch));
                        dropdownElements.branchMenu.appendChild(item);
                    });
                }
            }
            
            function selectBranch(branch) {
                selectedBranchValue = branch;
                dropdownElements.branchSearch.value = branch;
                dropdownElements.modalBranch.value = branch;
                closeDropdown();
            }
            
            function openDropdown() {
                if (!dropdownElements.branchMenu || !dropdownElements.branchArrow) return;
                
                dropdownElements.branchMenu.classList.add('show');
                dropdownElements.branchArrow.classList.add('open');
                populateDropdown(dropdownElements.branchSearch.value);
                // Auto-focus search input for better UX
                setTimeout(() => {
                    if (dropdownElements.branchSearch) {
                        dropdownElements.branchSearch.focus();
                    }
                }, 100);
            }
            
            function closeDropdown() {
                if (!dropdownElements.branchMenu || !dropdownElements.branchArrow) return;
                
                dropdownElements.branchMenu.classList.remove('show');
                dropdownElements.branchArrow.classList.remove('open');
            }
            
            // Event listeners with improved error handling
            dropdownElements.branchInput.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    // Ensure dropdown is fully initialized on first click
                    if (!isDropdownInitialized) {
                        console.log('Initializing dropdown on first click...');
                        initializeBranchDropdown();
                        return;
                    }
                    
                    if (dropdownElements.branchMenu.classList.contains('show')) {
                        closeDropdown();
                    } else {
                        openDropdown();
                    }
                } catch (error) {
                    console.warn('Dropdown click error, reinitializing...', error);
                    // Reinitialize if there's an error
                    setTimeout(() => {
                        isDropdownInitialized = false;
                        initializeBranchDropdown();
                    }, 50);
                }
            });
            
            dropdownElements.branchSearch.addEventListener('input', (e) => {
                try {
                    if (!dropdownElements.branchMenu.classList.contains('show')) {
                        openDropdown();
                    }
                    populateDropdown(e.target.value);
                    selectedBranchValue = '';
                    dropdownElements.modalBranch.value = '';
                } catch (error) {
                    console.warn('Search input error:', error);
                }
            });
            
            dropdownElements.branchSearch.addEventListener('focus', () => {
                try {
                    openDropdown();
                } catch (error) {
                    console.warn('Search focus error:', error);
                }
            });
            
            // Close dropdown when clicking outside - with improved targeting
            document.addEventListener('click', (e) => {
                try {
                    if (dropdownElements.dropdown && !dropdownElements.dropdown.contains(e.target)) {
                        closeDropdown();
                    }
                } catch (error) {
                    console.warn('Outside click error:', error);
                }
            });
            
            // Keyboard navigation with improved error handling
            dropdownElements.branchSearch.addEventListener('keydown', (e) => {
                try {
                    const items = dropdownElements.branchMenu.querySelectorAll('.dropdown-item');
                    const currentSelected = dropdownElements.branchMenu.querySelector('.dropdown-item.selected');
                    let selectedIndex = Array.from(items).indexOf(currentSelected);
                    
                    switch(e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            if (!dropdownElements.branchMenu.classList.contains('show')) {
                                openDropdown();
                            } else {
                                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                                updateSelection(items, selectedIndex);
                            }
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            selectedIndex = Math.max(selectedIndex - 1, 0);
                            updateSelection(items, selectedIndex);
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (currentSelected) {
                                // Get the actual text content without HTML markup
                                const branchText = currentSelected.textContent || currentSelected.innerText;
                                selectBranch(branchText);
                            }
                            break;
                        case 'Escape':
                            closeDropdown();
                            break;
                    }
                } catch (error) {
                    console.warn('Keyboard navigation error:', error);
                }
            });
            
            function updateSelection(items, index) {
                try {
                    items.forEach(item => item.classList.remove('selected'));
                    if (items[index]) {
                        items[index].classList.add('selected');
                        items[index].scrollIntoView({ block: 'nearest' });
                    }
                } catch (error) {
                    console.warn('Selection update error:', error);
                }
            }
            
            // Mark as initialized
            isDropdownInitialized = true;
            console.log('Branch dropdown initialized successfully');
        }

        // --- Firestore CRUD ---
        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = `mt-4 text-sm ${isError ? 'text-red-500' : 'text-slate-400'}`;
        }

        // --- Notification System ---
        function checkOverdueIssues() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const currentUser = window.SPViAuth ? window.SPViAuth.getCurrentUser() : null;
            if (!currentUser) return [];

            // Find issues assigned to current user that are overdue
            const userOverdueIssues = allIssues.filter(issue => {
                // Only check issues assigned to current user
                if (issue.assignee !== currentUser.name) return false;
                
                // Only check non-completed issues
                if (issue.status === 'เสร็จสิ้น') return false;
                
                // Check if due date exists and is in the past
                if (!issue.dueDate) return false;
                
                const dueDate = new Date(issue.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                
                return dueDate < today;
            });

            return userOverdueIssues;
        }

        function updateNotificationBell() {
            const overdueIssues = checkOverdueIssues();
            const notificationBell = document.getElementById('spvi-notification-bell');
            const notificationBadge = document.getElementById('spvi-notification-badge');
            
            if (notificationBell && notificationBadge) {
                if (overdueIssues.length > 0) {
                    notificationBadge.textContent = overdueIssues.length;
                    notificationBadge.style.display = 'block';
                    notificationBell.style.color = '#ef4444'; // red-500
                } else {
                    notificationBadge.style.display = 'none';
                    notificationBell.style.color = '#9ca3af'; // gray-400
                }
            }
            
            // Store notifications globally for other pages to access
            window.spviOverdueNotifications = overdueIssues;
        }

        function showNotificationModal() {
            const overdueIssues = checkOverdueIssues();
            
            if (overdueIssues.length === 0) {
                alert('ไม่มีประเด็นที่ค้างครบกำหนดสำหรับคุณ');
                return;
            }

            // Create modal if it doesn't exist
            let modal = document.getElementById('notification-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'notification-modal';
                modal.className = 'modal-backdrop hidden';
                modal.innerHTML = `
                    <div class="modal-content max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-red-600">ประเด็นที่ค้างครบกำหนด</h2>
                            <button id="close-notification-modal" class="text-slate-400 hover:text-slate-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div id="notification-content" class="space-y-4 max-h-96 overflow-y-auto">
                        </div>
                        <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                            <button id="dismiss-notifications" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">ปิด</button>
                            <button id="go-to-issues" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">ไปที่หน้าติดตามประเด็น</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Add event listeners
                document.getElementById('close-notification-modal').addEventListener('click', hideNotificationModal);
                document.getElementById('dismiss-notifications').addEventListener('click', hideNotificationModal);
                document.getElementById('go-to-issues').addEventListener('click', () => {
                    hideNotificationModal();
                    // Check if we're already on the issue tracker page
                    if (!window.location.pathname.includes('issue-tracker.html')) {
                        window.location.href = 'issue-tracker.html';
                    }
                });
            }

            // Populate modal content
            const content = document.getElementById('notification-content');
            content.innerHTML = overdueIssues.map(issue => {
                const daysOverdue = Math.floor((new Date() - new Date(issue.dueDate)) / (1000 * 60 * 60 * 24));
                return `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-red-800">${issue.branch}</h3>
                                <p class="text-sm text-red-700 mt-1">${issue.issue}</p>
                                <div class="flex items-center gap-4 mt-2 text-xs text-red-600">
                                    <span>ครบกำหนด: ${new Date(issue.dueDate).toLocaleDateString('th-TH')}</span>
                                    <span class="font-semibold">เกินกำหนด ${daysOverdue} วัน</span>
                                    <span class="px-2 py-1 bg-red-100 rounded">${issue.status}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.classList.remove('hidden');
        }

        function hideNotificationModal() {
            const modal = document.getElementById('notification-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // --- Load Users ---
        async function loadUsers() {
            try {
                if (window.SPViAuth && typeof window.SPViAuth.getAllUsers === 'function') {
                    const users = await window.SPViAuth.getAllUsers();
                    // Filter only approved users
                    allUsers = users.filter(user => user.status === 'approved');
                    console.log('Loaded users for assignee dropdown:', allUsers.length);
                } else {
                    console.warn('SPViAuth not available, users dropdown will be empty');
                    allUsers = [];
                }
            } catch (error) {
                console.error('Error loading users:', error);
                allUsers = [];
            }
        }

        async function loadData() {
            showStatus('Loading data from Firestore...');
            try {
                const snapshot = await issuesCollection.orderBy('createdAt', 'desc').get();
                allIssues = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAssigneeFilter();
                renderIssues();
                updateNotificationBell(); // Update notification status
                showStatus('Data loaded successfully.', false);
            } catch (error) {
                // Error loading data handled silently for production
                issueListEl.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Failed to load data: ${error.message}</td></tr>`;
                showStatus(`Load failed: ${error.message}`, true);
            }
        }

        // Update assignee filter dropdown with unique assignees
        function updateAssigneeFilter() {
            const currentValue = assigneeFilter.value;
            const uniqueAssignees = [...new Set(allIssues
                .map(issue => issue.assignee)
                .filter(assignee => assignee && assignee.trim())
            )].sort();
            
            // Clear existing options except "ทุกคน"
            assigneeFilter.innerHTML = '<option value="">ทุกคน</option>';
            
            // Add unique assignees
            uniqueAssignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee;
                option.textContent = assignee;
                if (assignee === currentValue) {
                    option.selected = true;
                }
                assigneeFilter.appendChild(option);
            });
        }

        // Update filter visual states
        function updateFilterStates() {
            const hasTextFilter = filterInput.value.trim() !== '';
            const hasStatusFilter = statusFilter.value !== '';
            const hasAssigneeFilter = assigneeFilter.value !== '';
            const hasAnyFilter = hasTextFilter || hasStatusFilter || hasAssigneeFilter;
            
            // Update visual states
            filterInput.classList.toggle('filter-active', hasTextFilter);
            statusFilter.classList.toggle('filter-active', hasStatusFilter);
            assigneeFilter.classList.toggle('filter-active', hasAssigneeFilter);
            clearFiltersBtn.classList.toggle('clear-filters-visible', hasAnyFilter);
        }

        async function saveIssueToFirestore(issue) {
            try {
                if (issue.id && typeof issue.id === 'string') {
                    // Update
                    const { id, ...data } = issue;
                    await issuesCollection.doc(id).set(data, { merge: true });
                } else {
                    // Add new
                    const { id, ...data } = issue;
                    const docRef = await issuesCollection.add({
                        ...data,
                        createdAt: new Date()
                    });
                    issue.id = docRef.id;
                }
            } catch (error) {
                showStatus(`Save failed: ${error.message}`, true);
            }
        }

        async function deleteIssueFromFirestore(id) {
            try {
                await issuesCollection.doc(id).delete();
            } catch (error) {
                showStatus(`Delete failed: ${error.message}`, true);
            }
        }

        // --- Rendering ---
        const renderIssues = () => {
            // Clear both views
            issueListEl.innerHTML = '';
            issueCardsEl.innerHTML = '';
            
            const filterText = filterInput.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            const assigneeFilterValue = assigneeFilter.value;
            
            const filteredIssues = allIssues.filter(issue => {
                // Text search filter
                const textMatch = !filterText || 
                    (issue.branch && issue.branch.toLowerCase().includes(filterText)) ||
                    (issue.issue && issue.issue.toLowerCase().includes(filterText)) ||
                    (issue.assignee && issue.assignee.toLowerCase().includes(filterText));
                
                // Status filter
                const statusMatch = !statusFilterValue || issue.status === statusFilterValue;
                
                // Assignee filter
                const assigneeMatch = !assigneeFilterValue || issue.assignee === assigneeFilterValue;
                
                return textMatch && statusMatch && assigneeMatch;
            });
            
            // Update results counter
            const totalIssues = allIssues.length;
            const filteredCount = filteredIssues.length;
            
            if (totalIssues === 0) {
                resultsCounter.textContent = 'ยังไม่มีข้อมูล';
            } else if (filteredCount === totalIssues) {
                resultsCounter.textContent = `แสดงทั้งหมด ${totalIssues} รายการ`;
            } else {
                resultsCounter.textContent = `แสดง ${filteredCount} จาก ${totalIssues} รายการ`;
            }
            
            // Update filter visual states
            updateFilterStates();
            
            if (filteredIssues.length === 0) {
                issueListEl.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">ไม่พบประเด็นที่ตรงกัน หรือยังไม่มีข้อมูล</td></tr>';
                issueCardsEl.innerHTML = '<div class="text-center p-8 text-slate-500">ไม่พบประเด็นที่ตรงกัน หรือยังไม่มีข้อมูล</div>';
                return;
            }
            
            // Render desktop table view
            filteredIssues.forEach(issue => {
                const row = document.createElement('tr');
                
                // Determine status class for row coloring
                let statusClass = '';
                switch(issue.status) {
                    case 'รอดำเนินการ':
                        statusClass = 'status-pending';
                        break;
                    case 'กำลังแก้ไข':
                        statusClass = 'status-in-progress';
                        break;
                    case 'เสร็จสิ้น':
                        statusClass = 'status-completed';
                        break;
                }
                
                // Apply base classes and status-specific class
                const baseClasses = issue.isNew ? "hover:bg-slate-50 is-new" : "hover:bg-slate-50";
                row.className = `${baseClasses} ${statusClass}`.trim();
                delete issue.isNew;
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap font-medium text-slate-800 text-sm">${issue.branch || ''}</td>
                    <td class="px-3 py-3 text-slate-600 text-sm max-w-xs">
                        <div class="line-clamp-3 leading-relaxed">${issue.issue || ''}</div>
                    </td>
                    <td class="px-3 py-3 w-36">
                        <select class="status-select w-full p-1 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500 text-xs" data-id="${issue.id}">
                            <option value="รอดำเนินการ" ${issue.status === 'รอดำเนินการ' ? 'selected' : ''}>รอดำเนินการ</option>
                            <option value="กำลังแก้ไข" ${issue.status === 'กำลังแก้ไข' ? 'selected' : ''}>กำลังแก้ไข</option>
                            <option value="เสร็จสิ้น" ${issue.status === 'เสร็จสิ้น' ? 'selected' : ''}>เสร็จสิ้น</option>
                        </select>
                    </td>
                    <td class="px-3 py-3">
                        <select class="field-input w-full p-1 border border-slate-300 rounded-md text-xs" data-id="${issue.id}" data-field="assignee">
                            <option value="">เลือกผู้รับผิดชอบ</option>
                            ${allUsers.map(user => `
                                <option value="${user.name}" ${issue.assignee === user.name ? 'selected' : ''}>
                                    ${user.name} (${user.department})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="px-3 py-3">
                        <input type="date" class="field-input w-full p-1 border border-slate-300 rounded-md text-xs" data-id="${issue.id}" data-field="dueDate" value="${issue.dueDate || ''}">
                    </td>
                    <td class="px-3 py-3 text-right whitespace-nowrap">
                        <button class="edit-btn text-blue-600 hover:text-blue-800 mr-2 text-xs" data-id="${issue.id}">แก้ไข</button>
                        <button class="delete-btn text-red-600 hover:text-red-800 text-xs" data-id="${issue.id}">ลบ</button>
                    </td>
                `;
                issueListEl.appendChild(row);
            });
            
            // Render mobile card view
            filteredIssues.forEach(issue => {
                const card = document.createElement('div');
                
                // Determine status class for card styling
                let statusClass = '';
                switch(issue.status) {
                    case 'รอดำเนินการ':
                        statusClass = 'status-pending';
                        break;
                    case 'กำลังแก้ไข':
                        statusClass = 'status-in-progress';
                        break;
                    case 'เสร็จสิ้น':
                        statusClass = 'status-completed';
                        break;
                }
                
                card.className = `issue-card ${statusClass}`;
                
                // Status indicator for better mobile UX
                let statusDotClass = '';
                let statusText = '';
                switch(issue.status) {
                    case 'รอดำเนินการ':
                        statusDotClass = 'pending';
                        statusText = 'รอดำเนินการ';
                        break;
                    case 'กำลังแก้ไข':
                        statusDotClass = 'in-progress';
                        statusText = 'กำลังแก้ไข';
                        break;
                    case 'เสร็จสิ้น':
                        statusDotClass = 'completed';
                        statusText = 'เสร็จสิ้น';
                        break;
                    default:
                        statusDotClass = 'pending';
                        statusText = 'ไม่ระบุ';
                }
                
                card.innerHTML = `
                    <div class="issue-card-header">
                        <div class="issue-card-title">${issue.branch || 'ไม่ระบุสาขา'}</div>
                        <div class="status-indicator-container">
                            <span class="status-dot ${statusDotClass}"></span>
                            <span class="status-text">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="issue-card-content">
                        ${issue.issue || 'ไม่มีรายละเอียด'}
                    </div>
                    
                    <div class="issue-card-single-row">
                        <div class="issue-card-field-inline">
                            <label>สถานะ</label>
                            <select class="status-select" data-id="${issue.id}">
                                <option value="รอดำเนินการ" ${issue.status === 'รอดำเนินการ' ? 'selected' : ''}>รอดำเนินการ</option>
                                <option value="กำลังแก้ไข" ${issue.status === 'กำลังแก้ไข' ? 'selected' : ''}>กำลังแก้ไข</option>
                                <option value="เสร็จสิ้น" ${issue.status === 'เสร็จสิ้น' ? 'selected' : ''}>เสร็จสิ้น</option>
                            </select>
                        </div>
                        
                        <div class="issue-card-field-inline">
                            <label>ครบกำหนด</label>
                            <input type="date" class="field-input" data-id="${issue.id}" data-field="dueDate" value="${issue.dueDate || ''}">
                        </div>
                        
                        <div class="issue-card-field-inline flex-grow">
                            <label>ผู้รับผิดชอบ</label>
                            <select class="field-input" data-id="${issue.id}" data-field="assignee">
                                <option value="">เลือกผู้รับผิดชอบ</option>
                                ${allUsers.map(user => `
                                    <option value="${user.name}" ${issue.assignee === user.name ? 'selected' : ''}>
                                        ${user.name} (${user.department})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="issue-card-actions-inline">
                            <button class="issue-card-btn issue-card-btn-edit edit-btn" data-id="${issue.id}">แก้ไข</button>
                            <button class="issue-card-btn issue-card-btn-delete delete-btn" data-id="${issue.id}">ลบ</button>
                        </div>
                    </div>
                `;
                issueCardsEl.appendChild(card);
            });
        };

        // --- Event Handlers & Modal Logic ---
        function showIssueModal(issue = null) {
            const modalTitle = document.getElementById('modal-title');
            const modalIssueId = document.getElementById('modal-issue-id');
            const modalBranch = document.getElementById('modal-branch');
            const branchSearch = document.getElementById('branch-search');
            const modalIssue = document.getElementById('modal-issue');
            
            // Ensure dropdown is initialized before opening modal
            if (!isDropdownInitialized) {
                console.log('Initializing dropdown before opening modal...');
                initializeBranchDropdown();
            }
            
            if (issue) {
                modalTitle.textContent = 'แก้ไขประเด็น';
                modalIssueId.value = issue.id;
                modalBranch.value = issue.branch;
                branchSearch.value = issue.branch || '';
                selectedBranchValue = issue.branch || '';
                modalIssue.value = issue.issue;
            } else {
                modalTitle.textContent = 'เพิ่มประเด็นใหม่';
                issueForm.reset();
                branchSearch.value = '';
                selectedBranchValue = '';
                modalBranch.value = '';
            }
            
            issueModal.classList.remove('hidden');
            
            // Focus the search input after a brief delay to ensure modal is fully rendered
            setTimeout(() => {
                if (branchSearch) {
                    branchSearch.focus();
                }
            }, 150);
        }
        function hideIssueModal() { 
            issueModal.classList.add('hidden'); 
            // Clear dropdown state when modal closes
            try {
                if (dropdownElements) {
                    if (dropdownElements.branchSearch) dropdownElements.branchSearch.value = '';
                    if (dropdownElements.branchMenu) dropdownElements.branchMenu.classList.remove('show');
                    if (dropdownElements.branchArrow) dropdownElements.branchArrow.classList.remove('open');
                    if (dropdownElements.modalBranch) dropdownElements.modalBranch.value = '';
                } else {
                    // Fallback for when dropdownElements is not available
                    const branchSearch = document.getElementById('branch-search');
                    const branchMenu = document.getElementById('branch-menu');
                    const branchArrow = document.getElementById('branch-arrow');
                    const modalBranch = document.getElementById('modal-branch');
                    
                    if (branchSearch) branchSearch.value = '';
                    if (branchMenu) branchMenu.classList.remove('show');
                    if (branchArrow) branchArrow.classList.remove('open');
                    if (modalBranch) modalBranch.value = '';
                }
                selectedBranchValue = '';
            } catch (error) {
                console.warn('Error clearing dropdown state:', error);
                selectedBranchValue = '';
            }
        }
        function showDeleteModal(id) { issueToDeleteId = id; deleteModal.classList.remove('hidden'); }
        function hideDeleteModal() { issueToDeleteId = null; deleteModal.classList.add('hidden'); }

        addIssueBtn.addEventListener('click', () => {
            // Ensure dropdown is ready before showing modal
            if (!isDropdownInitialized) {
                initializeBranchDropdown();
            }
            showIssueModal();
        });
        issueForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('modal-issue-id').value;
            const branch = document.getElementById('modal-branch').value;
            const issueText = document.getElementById('modal-issue').value;
            
            // Validate that a branch is selected
            if (!branch || branch.trim() === '') {
                alert('กรุณาเลือกชื่อสาขา');
                document.getElementById('branch-search').focus();
                return;
            }
            
            // Validate that the selected branch exists in the list
            if (!branchList.includes(branch)) {
                alert('กรุณาเลือกสาขาจากรายการที่กำหนด');
                document.getElementById('branch-search').focus();
                return;
            }
            
            if (id) {
                const issue = allIssues.find(i => i.id === id);
                if (issue) {
                    issue.branch = branch;
                    issue.issue = issueText;
                    await saveIssueToFirestore(issue);
                }
            } else {
                const newIssue = {
                    branch: branch,
                    issue: issueText,
                    status: 'รอดำเนินการ',
                    assignee: '',
                    dueDate: '',
                    isNew: true,
                    createdAt: new Date()
                };
                await saveIssueToFirestore(newIssue);
                allIssues.unshift(newIssue);
            }
            await loadData();
            hideIssueModal();
        });
        document.getElementById('modal-cancel-btn').addEventListener('click', hideIssueModal);
        document.getElementById('delete-cancel-btn').addEventListener('click', hideDeleteModal);
        document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
            if (issueToDeleteId) {
                await deleteIssueFromFirestore(issueToDeleteId);
                await loadData();
                hideDeleteModal();
            }
        });
        // Event listeners for both desktop and mobile views
        issueListEl.addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('delete-btn')) showDeleteModal(id);
            if (e.target.classList.contains('edit-btn')) {
                const issueToEdit = allIssues.find(i => i.id === id);
                if (issueToEdit) showIssueModal(issueToEdit);
            }
        });
        
        // Event listeners for mobile card view
        issueCardsEl.addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('delete-btn')) showDeleteModal(id);
            if (e.target.classList.contains('edit-btn')) {
                const issueToEdit = allIssues.find(i => i.id === id);
                if (issueToEdit) showIssueModal(issueToEdit);
            }
        });
        // Debounce for live input saving
        let debounceTimer;
        function handleFieldUpdate(e) {
            const target = e.target;
            const id = target.dataset.id;
            const issue = allIssues.find(i => i.id === id);
            if(issue) {
                const field = target.dataset.field || (target.classList.contains('status-select') ? 'status' : null);
                if(field) {
                  issue[field] = target.value;
                  
                  // Update styling immediately when status changes
                  if(field === 'status') {
                      // Update desktop table row styling
                      const row = target.closest('tr');
                      if (row) {
                          // Remove existing status classes
                          row.classList.remove('status-pending', 'status-in-progress', 'status-completed');
                          
                          // Add new status class
                          let statusClass = '';
                          switch(target.value) {
                              case 'รอดำเนินการ':
                                  statusClass = 'status-pending';
                                  break;
                              case 'กำลังแก้ไข':
                                  statusClass = 'status-in-progress';
                                  break;
                              case 'เสร็จสิ้น':
                                  statusClass = 'status-completed';
                                  break;
                          }
                          if(statusClass) {
                              row.classList.add(statusClass);
                          }
                      }
                      
                      // Update mobile card styling
                      const card = target.closest('.issue-card');
                      if (card) {
                          // Remove existing status classes
                          card.classList.remove('status-pending', 'status-in-progress', 'status-completed');
                          
                          // Add new status class
                          let statusClass = '';
                          switch(target.value) {
                              case 'รอดำเนินการ':
                                  statusClass = 'status-pending';
                                  break;
                              case 'กำลังแก้ไข':
                                  statusClass = 'status-in-progress';
                                  break;
                              case 'เสร็จสิ้น':
                                  statusClass = 'status-completed';
                                  break;
                          }
                          if(statusClass) {
                              card.classList.add(statusClass);
                          }
                      }
                  }
                }
            }
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                if (issue) {
                    await saveIssueToFirestore(issue);
                    // Update assignee filter if assignee field was changed
                    if (target.dataset.field === 'assignee') {
                        updateAssigneeFilter();
                    }
                    // Update notifications if assignee or dueDate changed
                    if (target.dataset.field === 'assignee' || target.dataset.field === 'dueDate') {
                        updateNotificationBell();
                        // Also update global notifications
                        if (window.updateGlobalNotifications) {
                            window.updateGlobalNotifications();
                        }
                    }
                }
            }, 750);
        }
        
        // Event listeners for desktop table
        issueListEl.addEventListener('input', e => {
            if (e.target.classList.contains('field-input')) handleFieldUpdate(e);
        });
        issueListEl.addEventListener('change', e => {
            if (e.target.classList.contains('status-select')) handleFieldUpdate(e);
        });
        
        // Event listeners for mobile cards
        issueCardsEl.addEventListener('input', e => {
            if (e.target.classList.contains('field-input')) handleFieldUpdate(e);
        });
        issueCardsEl.addEventListener('change', e => {
            if (e.target.classList.contains('status-select')) handleFieldUpdate(e);
        });
        
        // Filter event listeners
        filterInput.addEventListener('keyup', renderIssues);
        statusFilter.addEventListener('change', renderIssues);
        assigneeFilter.addEventListener('change', renderIssues);
        
        // Clear filters button
        clearFiltersBtn.addEventListener('click', () => {
            filterInput.value = '';
            statusFilter.value = '';
            assigneeFilter.value = '';
            renderIssues();
        });
        // --- Initial Load ---
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait a bit for all DOM elements to be fully rendered
                setTimeout(() => {
                    // Initialize branch dropdown with retry mechanism
                    initializeBranchDropdown();
                    
                    // Double-check initialization after another short delay
                    setTimeout(() => {
                        if (!isDropdownInitialized) {
                            console.log('Retrying dropdown initialization...');
                            initializeBranchDropdown();
                        }
                    }, 200);
                }, 100);
                
                const firebaseInstances = await SPViAuth.initializeFirebase();
                firestore = firebaseInstances.db || window.firebase.app().firestore();
                issuesCollection = firestore.collection('issues');
                
                // Load users first, then load data
                await loadUsers();
                await loadData();
                
                // Set up periodic refresh every 5 minutes to keep data current
                setInterval(async () => {
                    try {
                        await loadData();
                        console.log('Data refreshed automatically');
                    } catch (error) {
                        console.error('Auto-refresh failed:', error);
                    }
                }, 5 * 60 * 1000); // 5 minutes
            } catch (error) {
                showStatus('Firestore connection failed: ' + error.message, true);
            }
        });
    </script>
    <script>


        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                await SPViAuth.initializeFirebase();
                
                // Check authentication - redirect to login if not authenticated
                if (!SPViAuth.checkAuthentication()) {
                    window.location.href = '../index.html';
                    return;
                }
                
                // User info will be added automatically by firebase-auth.js init()
                // No need to call addUserInfo() manually
                
                // Setup centralized devtools protection
                SPViAuth.setupDevToolsProtection();

        // Check tool access permission
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has permission to access issueTracker tool
            if (window.SPViSessionManager && window.SPViSessionManager.checkToolAccess) {
                const hasAccess = window.SPViSessionManager.checkToolAccess('issueTracker');
                if (!hasAccess) {
                    // Access denied - modal will be shown by checkToolAccess function
                    // Optionally hide main content
                    document.querySelector('main')?.style.setProperty('display', 'none');
                }
            }
        });
            } catch (error) {
                // Authentication error handled silently for production
                // If authentication fails, redirect to login
                window.location.href = '../index.html';
            }
        });
    </script>

    <!-- Legal Declaration and Signature Section (print only) -->
    <div class="print-legal-section">
        <div class="legal-certification">
            ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ
            <div class="english-text">
                (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
            </div>
        </div>
        
        <div class="signature-section">
            <div class="signature-container">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-name">ลงชื่อ .................................................</div>
                    <div class="signature-title">(ผู้ตรวจสอบ / Auditor)</div>
                    <div class="signature-date">
                        วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                    </div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-name">ลงชื่อ .................................................</div>
                    <div class="signature-title">(ผู้รับการตรวจสอบ / Auditee)</div>
                    <div class="signature-date">
                        วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
