<!DOCTYPE html>
<html lang="th">
<head>
    <style>
    .comparison-removed { background-color: #fee2e2; }

    /* Enhanced collision fix is now in global print-legal.css */
    </style>
</head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือเปรียบเทียบรายงาน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration Manager -->
    <script src="../config.js"></script>
    
    <!-- Session Manager -->
    <script src="../session-manager.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <link rel="stylesheet" href="../styles/print-legal.css">
    <!-- Global Print Header -->
    <link rel="stylesheet" href="../styles/print-header.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .comparison-added { background-color: #dcfce7; }
        .comparison-removed { background-color: #fee2e2; }
        .comparison-changed { background-color: #fef3c7; }

        /* Fix for top menu collision with user info bar */
        body.logged-in {
            padding-top: 4rem !important;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            body.logged-in {
                padding-top: 5rem !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 logged-in">
    <!-- Global Print Header Section -->
    <div class="print-header-section"></div>
    
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold text-slate-900">เครื่องมือเปรียบเทียบรายงาน</h1>
            <p class="mt-2 text-slate-500">เปรียบเทียบผลการตรวจสอบ 2 ครั้งเพื่อดูการเปลี่ยนแปลงและพัฒนาการ</p>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2">รายงานเก่า (ครั้งก่อน)</h3>
                    <label for="file1" class="w-full bg-white border-2 border-dashed border-gray-300 p-4 rounded-lg cursor-pointer flex flex-col items-center justify-center text-center">
                        <span id="file1-name" class="text-gray-500">คลิกเพื่อเลือกไฟล์ .json</span>
                    </label>
                    <input type="file" id="file1" class="hidden" accept=".json">
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">รายงานใหม่ (ครั้งล่าสุด)</h3>
                    <label for="file2" class="w-full bg-white border-2 border-dashed border-gray-300 p-4 rounded-lg cursor-pointer flex flex-col items-center justify-center text-center">
                         <span id="file2-name" class="text-gray-500">คลิกเพื่อเลือกไฟล์ .json</span>
                    </label>
                    <input type="file" id="file2" class="hidden" accept=".json">
                </div>
            </div>
            <button id="compare-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                เปรียบเทียบผล
            </button>
        </div>

        <div id="results-container" class="mt-8"></div>
    </div>

<script>
    const fileInput1 = document.getElementById('file1');
    const fileInput2 = document.getElementById('file2');
    const fileName1 = document.getElementById('file1-name');
    const fileName2 = document.getElementById('file2-name');
    const compareBtn = document.getElementById('compare-btn');
    const resultsContainer = document.getElementById('results-container');

    let file1Data = null;
    let file2Data = null;

    const handleFileSelect = async (event, fileNumber) => {
        const file = event.target.files[0];
        if (!file) return;

        const fileNameEl = fileNumber === 1 ? fileName1 : fileName2;
        fileNameEl.textContent = file.name;

        const data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(JSON.parse(e.target.result));
            reader.onerror = reject;
            reader.readAsText(file);
        });

        if (fileNumber === 1) file1Data = data;
        else file2Data = data;

        if (file1Data && file2Data) {
            compareBtn.disabled = false;
        }
    };

    fileInput1.addEventListener('change', (e) => handleFileSelect(e, 1));
    fileInput2.addEventListener('change', (e) => handleFileSelect(e, 2));

    compareBtn.addEventListener('click', () => {
        if (!file1Data || !file2Data) return;

        resultsContainer.innerHTML = '';
        
        if (file1Data.tool === 'checklist' && file2Data.tool === 'checklist') {
            compareChecklists(file1Data, file2Data);
        } else if (file1Data.tool === 'stock-count' && file2Data.tool === 'stock-count') {
            compareStockCounts(file1Data, file2Data);
        } else {
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">ไม่สามารถเปรียบเทียบไฟล์จากคนละเครื่องมือได้</p>`;
        }
    });

    function compareChecklists(oldData, newData) {
        let html = `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-2xl font-bold mb-4">ผลการเปรียบเทียบ Checklist</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><strong>สาขา:</strong> ${newData.details.branch}</div>
                    <div><strong>วันที่เปรียบเทียบ:</strong> ${oldData.details.date} vs ${newData.details.date}</div>
                    <div class="p-4 rounded-lg ${oldData.summary.score < newData.summary.score ? 'bg-green-100' : 'bg-red-100'}">
                        <strong>คะแนนรวม:</strong> 
                        <span class="font-bold">${oldData.summary.score.toFixed(2)}%</span> &rarr; <span class="font-bold">${newData.summary.score.toFixed(2)}%</span>
                    </div>
                </div>
                <div class="space-y-2">
        `;

        Object.keys(newData.sections).forEach((sectionKey, s_idx) => {
            html += `<h3 class="font-semibold text-lg mt-4 pt-4 border-t">${sectionKey}</h3>`;
            newData.sections[sectionKey].forEach((newItem, i_idx) => {
                const oldItem = oldData.sections[sectionKey]?.[i_idx];
                if (!oldItem) return;

                const newStatus = newItem.status;
                const oldStatus = oldItem.status;

                let changeClass = '';
                let changeText = '';
                if (newStatus !== oldStatus) {
                    if (oldStatus === 'fail' && newStatus === 'pass') {
                        changeClass = 'comparison-added'; // Improved
                        changeText = `พัฒนาขึ้น (ไม่ผ่าน &rarr; ผ่าน)`;
                    } else if(oldStatus === 'pass' && newStatus === 'fail') {
                        changeClass = 'comparison-removed'; // Worsened
                        changeText = `แย่ลง (ผ่าน &rarr; ไม่ผ่าน)`;
                    } else {
                         changeClass = 'comparison-changed'; // Changed
                         changeText = `เปลี่ยน (${oldStatus || 'N/A'} &rarr; ${newStatus || 'N/A'})`;
                    }
                }
                
                if (changeText) {
                    html += `
                        <div class="p-3 rounded-md ${changeClass}">
                           <p>${oldData.data[s_idx]?.items[i_idx]?.text || 'N/A'}</p>
                           <p class="text-sm font-bold">${changeText}</p>
                        </div>`;
                }
            });
        });
        
        html += `</div></div>`;
        resultsContainer.innerHTML = html;
    }

    function compareStockCounts(oldData, newData) {
         let html = `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-2xl font-bold mb-4">ผลการเปรียบเทียบ Stock Count</h2>
                 <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><strong>สาขา:</strong> ${newData.details.branch}</div>
                    <div><strong>วันที่เปรียบเทียบ:</strong> ${oldData.details.date} vs ${newData.details.date}</div>
                    <div class="p-4 rounded-lg ${Math.abs(oldData.summary.netDiffCost) > Math.abs(newData.summary.netDiffCost) ? 'bg-green-100' : 'bg-red-100'}">
                        <strong>มูลค่าผลต่างสุทธิ:</strong> 
                        <span class="font-bold">${oldData.summary.netDiffCost.toLocaleString()} ฿</span> &rarr; <span class="font-bold">${newData.summary.netDiffCost.toLocaleString()} ฿</span>
                    </div>
                </div>
            </div>
        `;
        resultsContainer.innerHTML = html;
    }

    // Initialize authentication and devtools protection
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // Initialize Firebase
            await SPViAuth.initializeFirebase();
            
            // Check authentication - redirect to login if not authenticated
            const isAuthenticated = await SPViAuth.checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = '../index.html';
                return;
            }
            
            // User info will be added automatically by firebase-auth.js init()
            // No need to call addUserInfo() manually
            
            // Setup centralized devtools protection
            SPViAuth.setupDevToolsProtection();

            // Check tool access permission after authentication is confirmed
            if (window.SPViSessionManager && window.SPViSessionManager.checkToolAccess) {
                const hasAccess = await window.SPViSessionManager.checkToolAccess('reportComparison');
                if (!hasAccess) {
                    // Access denied - modal will be shown by checkToolAccess function
                    // Optionally hide main content
                    document.querySelector('main')?.style.setProperty('display', 'none');
                }
            }
        } catch (error) {
            // Authentication error handled silently for production
            // If authentication fails, redirect to login
            window.location.href = '../index.html';
        }
    });
</script>

<!-- Legal Declaration and Signature Section (print only) -->
<div class="print-legal-section">
    <div class="legal-certification">
        ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ
        <div class="english-text">
            (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
        </div>
    </div>
    
    <div class="signature-section">
        <div class="signature-container">
            <div class="signature-box">
                <div class="signature-line"></div>
                <div class="signature-name">ลงชื่อ .................................................</div>
                <div class="signature-title">(ผู้ตรวจสอบ / Auditor)</div>
                <div class="signature-date">
                    วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                </div>
            </div>
            <div class="signature-box">
                <div class="signature-line"></div>
                <div class="signature-name">ลงชื่อ .................................................</div>
                <div class="signature-title">(ผู้รับการตรวจสอบ / Auditee)</div>
                <div class="signature-date">
                    วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
