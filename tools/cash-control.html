<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานผลการตรวจนับเงินสด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .currency-input { text-align: right; }
        .summary-value { font-weight: 700; font-size: 1.125rem; }
        .result-positive { color: #16a34a; }
        .result-negative { color: #dc2626; }
        .result-zero { color: #374151; }
        .dynamic-row { transition: all 0.3s ease-in-out; overflow: hidden; }
        .dynamic-row.removing { transform: translateX(100%); max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; }
        
        .print-only { display: none; }
        .attachment-thumbnail {
            width: 2.5rem;
            height: 2.5rem;
            object-fit: cover;
            border-radius: 0.375rem;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        #image-modal {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        #modal-img {
            max-height: 80vh;
            max-width: 90vw;
        }

        @media print {
            html, body {
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 0;
                background: #fff;
                font-family: 'TH SarabunPSK', 'TH Sarabun New', 'Sarabun', 'Times New Roman', Times, serif !important;
                color: #222 !important;
            }
            @page {
                size: A4 portrait;
                margin: 18mm 12mm 18mm 12mm;
            }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                font-size: 9pt !important;
                line-height: 1.6 !important;
            }
            .no-print { display: none !important; }
            .print-wrapper {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                border: 2px solid #222 !important;
                box-shadow: none !important;
                background: #fff !important;
            }
            .print-container { 
                max-width: 100% !important; 
                box-shadow: none !important; 
                border: 1px solid #bbb !important; 
                border-radius: 0.5rem !important;
                padding: 0.8rem 1.2rem !important;
                margin-bottom: 1rem !important;
                background: #fff !important;
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
            }
            .main-grid { 
                display: block !important; 
                width: 100% !important;
                gap: 0 !important;
            }
            .lg\:col-span-2, .lg\:col-span-1 { 
                width: 100% !important;
            }
            .sticky { position: static !important; }
            .print-only { display: block; }
            header, footer, #image-modal { display: none; }
            .dynamic-row {
                margin-bottom: 0.2rem !important;
                padding: 0 !important;
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
            }
            .dynamic-row input[type="text"], .dynamic-row input[type="number"] {
                padding: 1px 4px !important;
                font-size: 9pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            h1, h2, h3 {
                font-family: 'TH SarabunPSK', 'TH Sarabun New', 'Sarabun', 'Times New Roman', Times, serif !important;
                color: #111 !important;
                font-weight: bold !important;
            }
            h1 { font-size: 1rem !important; }
            h2 { font-size: 1rem !important; }
            h3 { font-size: 1rem !important; }
            label, .text-gray-700, .text-gray-800, .text-gray-600 {
                color: #222 !important;
            }
            .summary-value, .font-bold {
                font-weight: bold !important;
            }
            .border-t, .border-t-2, .border-b, .border-dashed, .border-gray-400, .border-gray-300, .border-gray-700, .border-gray-800 {
                border-color: #222 !important;
            }
            .certification {
                border: 1.5px solid #222 !important;
                border-radius: 0.5rem !important;
                background: #f7f7f7 !important;
                color: #222 !important;
                font-size: 9pt !important;
                margin: 2rem 0 1.5rem 0 !important;
                padding: 1.2rem 1rem !important;
            }
            .signature-section {
                margin-top: 2.5rem !important;
                padding-top: 2rem !important;
                border-top: 2px dashed #222 !important;
                font-size: 9pt !important;
            }
            #print-appendix {
                page-break-before: auto !important;
                break-before: auto !important;
                margin-top: 1.5rem;
            }
            .appendix-item {
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
                border: 1px solid #bbb !important;
                border-radius: 0.4rem !important;
                padding: 0.7rem 1rem !important;
                margin-bottom: 1.2rem !important;
                background: #fafafa !important;
            }
            .appendix-item img {
                max-width: 30%;
                height: auto;
                border: 1px solid #bbb;
                display: block;
                margin: 0.5rem auto;
            }
            /* Prevent grid headers from being orphaned */
            .print-container h2, .print-container h3, .print-container .grid {
                break-after: avoid-page !important;
                page-break-after: avoid !important;
            }

            /* Print header */
            .print-header {
                display: block !important;
                text-align: center;
                font-size: 1.25rem;
                font-weight: bold;
                margin-bottom: 1.5rem;
                border-bottom: 2px solid #222;
                padding-bottom: 0.5rem;
                letter-spacing: 1px;
            }
 
            .header-info {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
                break-after: avoid !important;
                page-break-after: avoid !important;
            }
            .print-container {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            .mb-6, .my-8, .mt-12, .pt-8, .mt-6, .mb-4, .mt-4, .mb-2, .mt-2 {
                margin-bottom: 0.5rem !important;
                margin-top: 0.5rem !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
            .print-container {
                break-after: avoid !important;
                page-break-after: avoid !important;
            }
            .print-container + .print-container {
                margin-top: 0 !important;
            }
            .print-wrapper {
                padding-bottom: 0 !important;
            }
            .appendix-pagebreak {
                page-break-before: always !important;
                break-before: page !important;
            }
            .align-top { vertical-align: top !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-4xl mx-auto print-wrapper">
        <!-- Print Header  -->
        <div class="print-header print-only" style="display:none;">
            รายงานการตรวจสอบเงินสด (Cash Control Audit Report)<br>
            ฝ่ายตรวจสอบปฏิบัติการ (Operation Audit) / SPVi Public Company Limited
        </div>
 
        <!-- Headers -->
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-gray-800">ระบบตรวจนับเงินสด</h1>
            <p class="text-gray-600 mt-1">(Cash Control)</p>
        </header>
        <div class="print-only text-center mb-4">
            <h1 class="text-xl font-bold">สรุปผลการตรวจนับเงิน (Cash Control)</h1>
        </div>

        <!-- Header Information Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 print-container header-info">
            <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ข้อมูลการตรวจนับ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700">สาขา/แผนก</label>
                    <input type="text" id="department" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="เช่น B000-คลังสินค้าสำนักงานใหญ่">
                </div>
                <div>
                    <label for="custodian" class="block text-sm font-medium text-gray-700">ผู้ดูแลเงิน (ชื่อ-ตำแหน่ง)</label>
                    <input type="text" id="custodian" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="เช่น นายกันต์กฤช พุ่มเจริญ (Operation Audit Officer)">
                </div>
                <div>
                    <label for="count-date" class="block text-sm font-medium text-gray-700">วันที่ตรวจนับ</label>
                    <input type="date" id="count-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 main-grid">
            <!-- Left Column: Details -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Cash Count Sections -->
                <div class="bg-white p-6 rounded-xl shadow-lg print-container">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 1: การนับเงินสดและกองอื่นๆ</h2>
                    
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">เงินสดย่อย (Petty Cash Fund)</h3>
                    <div id="cash-items">
                        <div class="grid grid-cols-3 gap-4 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span>ประเภทเงินสดในมือ</span><span class="text-center">จำนวน</span><span class="text-right">รวมเงิน (บาท)</span>
                        </div>
                    </div>
                     <div class="mt-3">
                        <label for="bank-balance-counted" class="block text-sm font-medium text-gray-700">เงินสดย่อยในบัญชีธนาคาร</label>
                        <input type="number" id="bank-balance-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินสดย่อยทั้งหมด (ในมือ+ในบัญชี)</span>
                        <span id="total-petty-cash" class="font-bold text-blue-600">0.00</span>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-600 mt-6 mb-2">เงินกองอื่นๆ</h3>
                    <div>
                        <label for="change-fund-counted" class="block text-sm font-medium text-gray-700">เงินทอนที่นับได้ (Change Fund)</label>
                        <input type="number" id="change-fund-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                     <div class="mt-3">
                        <label for="prev-sales-counted" class="block text-sm font-medium text-gray-700">เงินสดจากยอดขายวันก่อน (ที่ยังไม่นำส่ง)</label>
                        <input type="number" id="prev-sales-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                    <div class="mt-3">
                        <label for="today-sales-counted" class="block text-sm font-medium text-gray-700">เงินสดจากยอดขายวันนี้</label>
                        <input type="number" id="today-sales-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                </div>

                <!-- Vouchers & Reimbursements -->
                <div class="bg-white p-6 rounded-xl shadow-lg print-container">
                     <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 2: เอกสารประกอบเงินสดย่อย</h2>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">เอกสารจ่ายรอเบิก (Vouchers)</h3>
                    <div id="voucher-list" class="space-y-1">
                         <div class="grid grid-cols-12 gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span class="col-span-6 md:col-span-7">รายละเอียด</span>
                            <span class="text-right col-span-3 md:col-span-3">จำนวนเงิน</span>
                            <span class="text-center col-span-3 md:col-span-2 no-print">หลักฐาน</span>
                        </div>
                    </div>
                    <button id="add-voucher" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 no-print">+ เพิ่มรายการเอกสารจ่าย</button>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินตามเอกสารจ่าย</span>
                        <span id="total-vouchers" class="font-bold text-orange-600">0.00</span>
                    </div>

                     <h3 class="text-lg font-semibold text-gray-600 mt-6 mb-2">รายการรอโอนเงินคืน</h3>
                    <div id="reimbursement-list" class="space-y-1">
                         <div class="grid grid-cols-12 gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span class="col-span-6 md:col-span-7">รายละเอียด</span>
                            <span class="text-right col-span-3 md:col-span-3">จำนวนเงิน</span>
                            <span class="text-center col-span-3 md:col-span-2 no-print">หลักฐาน</span>
                        </div>
                    </div>
                    <button id="add-reimbursement" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 no-print">+ เพิ่มรายการรอโอนคืน</button>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินรอโอนคืน</span>
                        <span id="total-reimbursements" class="font-bold text-green-600">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-8 print-container">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 3: สรุปผลกระทบยอด</h2>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600">ยอดเงินตามระบบ</h3>
                        <div>
                            <label for="approved-petty-cash" class="block text-sm font-medium text-gray-700">วงเงินสดย่อยอนุมัติ</label>
                            <input type="number" id="approved-petty-cash" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                         <div>
                            <label for="approved-change-fund" class="block text-sm font-medium text-gray-700">วงเงินทอนอนุมัติ</label>
                            <input type="number" id="approved-change-fund" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        <div>
                            <label for="prev-sales-system" class="block text-sm font-medium text-gray-700">ยอดขายวันก่อน (ตามรายงาน)</label>
                            <input type="number" id="prev-sales-system" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        <div>
                            <label for="today-sales-system" class="block text-sm font-medium text-gray-700">ยอดขายวันนี้ (ตามรายงาน)</label>
                            <input type="number" id="today-sales-system" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        
                        <div class="border-t pt-3 space-y-4 print:flex print:space-y-0 print:gap-8 print:items-start">
                            <!-- เงินที่นับได้ทั้งหมด (A) -->
                            <div class="print:w-1/3">
                                <h3 class="text-sm font-medium text-gray-700">เงินที่นับได้ทั้งหมด (A)</h3>
                                <p id="total-assets-counted" class="summary-value text-blue-600">0.00</p>
                                <p class="text-xs text-gray-500">(กองเงินสดย่อย+กองอื่นๆ)</p>
                            </div>
                            <!-- ยอดเงินที่ควรมีทั้งหมด (B) -->
                            <div class="print:w-1/3">
                                <h3 class="text-sm font-medium text-gray-700">ยอดเงินที่ควรมีทั้งหมด (B)</h3>
                                <p id="expected-balance" class="summary-value text-gray-800">0.00</p>
                                <p class="text-xs text-gray-500">(ยอดตามระบบ - รอคืน - เอกสารจ่าย)</p>
                            </div>
                        
                            <!-- ยอดเงินที่ต่าง (A-B) -->
                            <div class="border-t-2 border-gray-300 pt-4 print:w-1/3 print:border-0 print:pt-0 print:align-top">
                                <p class="text-lg font-bold text-gray-700">ผลต่างรวม (A-B)</p>
                                <p id="difference" class="text-2xl font-bold result-zero">0.00</p>
                                <p id="difference-label" class="text-sm font-bold result-zero"></p>
                            </div>
                        </div>

                    </div>
                    <div class="mt-6 space-y-2 no-print">
                         <button id="export-csv-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Export to CSV</button>
                         <button id="export-json-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Export to JSON</button>
                         <button id="print-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition">พิมพ์รายงาน</button>
                         <button id="reset-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">เริ่มใหม่</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legal Declaration (before Signature Section) -->
        <div class="print-only certification text-center my-8"
             style="font-size: 11pt; padding: 2rem;">
            ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ<br>
            <span style="font-size:10pt; color:#444;">
                (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
            </span>
        </div>

        <!-- Signature Section -->
        <div class="max-w-5xl mx-auto mt-12 pt-12 border-t-2 border-dashed border-gray-400 print-only signature-section">
            <div class="grid grid-cols-2 gap-8 text-center" style="font-size: 11pt;">
                <div>
                    <div style="height: 2.5rem;"></div> <!-- Add space before signature line -->
                    <p class="mb-1">ลงชื่อ .................................................</p>
                    <p>(ผู้ตรวจสอบ / Auditor)</p>
                    <p class="mt-4">วันที่: ........ / ................ / ............</p>
                </div>
                <div>
                    <div style="height: 2.5rem;"></div> <!-- Add space before signature line -->
                    <p class="mb-1">ลงชื่อ .................................................</p>
                    <p>(ผู้รับการตรวจสอบ / Auditee)</p>
                    <p class="mt-4">วันที่: ........ / ................ / ............</p>
                </div>
            </div>
        </div>

        <!-- Appendix for Printing Attachments -->
        <div id="print-appendix" class="print-only"></div>

        <footer class="text-center mt-12 text-gray-500 text-sm no-print">
            <p>Cash Control Application</p>
        </footer>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden no-print" onclick="this.classList.add('hidden')">
        <div class="relative p-4">
            <img id="modal-img" src="" alt="Full size attachment" class="rounded-lg shadow-2xl">
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State for storing attachments
            let attachments = {};
            let summaryData = {};

            const dateInput = document.getElementById('count-date');
            dateInput.value = new Date().toISOString().substring(0, 10);
            
            const cashItemsContainer = document.getElementById('cash-items');
            const denominations = [
                { value: 1000, label: 'ธนบัตร ฿1,000' }, { value: 500, label: 'ธนบัตร ฿500' },
                { value: 100, label: 'ธนบัตร ฿100' }, { value: 50, label: 'ธนบัตร ฿50' },
                { value: 20, label: 'ธนบัตร ฿20' }, { value: 0, label: 'เหรียญ (รวม)', isCoin: true }
            ];
            denominations.forEach(denom => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-4 items-center';
                row.innerHTML = `<label class="text-gray-700 text-sm">${denom.label}</label>
                    <input type="number" min="0" data-value="${denom.value}" data-type="${denom.isCoin ? 'coin' : 'note'}" class="cash-denom-input w-full p-2 border border-gray-300 rounded-md shadow-sm text-center" placeholder="0">
                    <span class="total-denom-value text-right text-gray-800 text-sm">0.00</span>`;
                cashItemsContainer.appendChild(row);
            });
            
            function setupDynamicSection(addButtonId, listId, inputClassName, placeholder, hasAttachment = false) {
                const addButton = document.getElementById(addButtonId);
                const list = document.getElementById(listId);
                let rowCount = 0;
                
                const addRow = () => {
                    rowCount++;
                    const rowId = `${listId}-row-${rowCount}`;
                    const row = document.createElement('div');
                    row.id = rowId;
                    row.className = 'grid grid-cols-12 gap-2 items-center dynamic-row mb-2';
                    
                    let attachmentHTML = '';
                    if (hasAttachment) {
                        attachmentHTML = `
                        <div class="col-span-3 md:col-span-2 text-center no-print">
                            <label for="attach-${rowId}" class="attachment-label cursor-pointer inline-block" data-row-id="${rowId}">
                                <img src="https://placehold.co/40x40/e0e7ff/4338ca?text=+" class="attachment-thumbnail" id="thumb-${rowId}">
                            </label>
                            <input type="file" id="attach-${rowId}" accept="image/*" class="hidden">
                        </div>`;
                    }
                    
                    row.innerHTML = `
                        <input type="text" class="${hasAttachment ? 'col-span-6 md:col-span-7' : 'col-span-8 md:col-span-9'} p-2 border border-gray-300 rounded-md shadow-sm" placeholder="${placeholder}">
                        <div class="${hasAttachment ? 'col-span-3 md:col-span-3' : 'col-span-4 md:col-span-3'} flex items-center gap-1">
                            <input type="number" min="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input ${inputClassName}" placeholder="0.00">
                        </div>
                        ${attachmentHTML}
                        <div class="col-span-12 flex justify-end">
                             <button class="remove-row text-red-500 hover:text-red-700 p-1 no-print text-xs" title="ลบรายการ">ลบรายการ</button>
                        </div>
                    `;
                    list.appendChild(row);

                    row.querySelector('.remove-row').addEventListener('click', (e) => {
                        e.preventDefault();
                        const rowToRemove = e.target.closest('.dynamic-row');
                        rowToRemove.classList.add('removing');
                        rowToRemove.addEventListener('transitionend', () => { 
                            delete attachments[rowId];
                            rowToRemove.remove(); 
                            calculateAll();
                        });
                    });

                    if (hasAttachment) {
                        const fileInput = row.querySelector(`#attach-${rowId}`);
                        fileInput.addEventListener('change', (e) => handleAttachment(e, rowId));
                        
                        const thumb = row.querySelector(`#thumb-${rowId}`);
                        thumb.addEventListener('click', (e) => {
                            if (attachments[rowId]) {
                                e.preventDefault(); // prevent re-opening file dialog
                                showImageModal(attachments[rowId].data);
                            }
                        });
                    }
                };
                addButton.addEventListener('click', addRow);
                addRow();
            }

            setupDynamicSection('add-voucher', 'voucher-list', 'voucher-amount', 'เช่น ค่าทางด่วน, ค่าอุปกรณ์', true);
            setupDynamicSection('add-reimbursement', 'reimbursement-list', 'reimbursement-amount', 'เช่น รอรับโอนคืนค่าซ่อม', true);

            const handleAttachment = (event, rowId) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const thumbnail = document.getElementById(`thumb-${rowId}`);
                    thumbnail.src = e.target.result;
                    attachments[rowId] = {
                        data: e.target.result,
                        name: file.name
                    };
                };
                reader.readAsDataURL(file);
            };

            const showImageModal = (imageData) => {
                document.getElementById('modal-img').src = imageData;
                document.getElementById('image-modal').classList.remove('hidden');
            };

            const formatCurrency = (num) => isNaN(num) ? '0.00' : num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            const calculateAll = () => {
                let physicalPettyCash = Array.from(document.querySelectorAll('.cash-denom-input')).reduce((sum, input) => {
                    const count = parseFloat(input.value) || 0;
                    const totalForItem = input.dataset.type === 'note' ? count * parseFloat(input.dataset.value) : count;
                    input.nextElementSibling.textContent = formatCurrency(totalForItem);
                    return sum + totalForItem;
                }, 0);
                const bankBalanceCounted = parseFloat(document.getElementById('bank-balance-counted').value) || 0;
                
                const totalPettyCashFund = physicalPettyCash + bankBalanceCounted;
                document.getElementById('total-petty-cash').textContent = formatCurrency(totalPettyCashFund);

                const changeFundCounted = parseFloat(document.getElementById('change-fund-counted').value) || 0;
                const prevSalesCounted = parseFloat(document.getElementById('prev-sales-counted').value) || 0;
                const todaySalesCounted = parseFloat(document.getElementById('today-sales-counted').value) || 0;

                const totalAssetsCounted = totalPettyCashFund + changeFundCounted + prevSalesCounted + todaySalesCounted;
                document.getElementById('total-assets-counted').textContent = formatCurrency(totalAssetsCounted);
                
                const approvedPettyCash = parseFloat(document.getElementById('approved-petty-cash').value) || 0;
                const approvedChangeFund = parseFloat(document.getElementById('approved-change-fund').value) || 0;
                const prevSalesSystem = parseFloat(document.getElementById('prev-sales-system').value) || 0;
                const todaySalesSystem = parseFloat(document.getElementById('today-sales-system').value) || 0;
                
                let totalVouchers = Array.from(document.querySelectorAll('.voucher-amount')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
                document.getElementById('total-vouchers').textContent = formatCurrency(totalVouchers);
                let totalReimbursements = Array.from(document.querySelectorAll('.reimbursement-amount')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
                document.getElementById('total-reimbursements').textContent = formatCurrency(totalReimbursements);

                const expectedSystemTotal = approvedPettyCash + approvedChangeFund + prevSalesSystem + todaySalesSystem;
                const expectedBalance = expectedSystemTotal - totalReimbursements - totalVouchers;
                document.getElementById('expected-balance').textContent = formatCurrency(expectedBalance);

                const difference = totalAssetsCounted - expectedBalance;
                const diffElem = document.getElementById('difference');
                const diffLabelElem = document.getElementById('difference-label');
                
                diffElem.textContent = formatCurrency(Math.abs(difference));
                diffElem.className = 'text-2xl font-bold';
                diffLabelElem.className = 'text-sm font-bold';

                if (difference > 0.005) {
                    diffElem.classList.add('result-positive');
                    diffLabelElem.classList.add('result-positive');
                    diffLabelElem.textContent = 'เงินเกิน (Overage)';
                } else if (difference < -0.005) {
                    diffElem.classList.add('result-negative');
                    diffLabelElem.classList.add('result-negative');
                    diffLabelElem.textContent = 'เงินขาด (Shortage)';
                } else {
                    diffElem.classList.add('result-zero');
                    diffLabelElem.classList.add('result-zero');
                    diffLabelElem.textContent = 'ยอดเงินถูกต้อง';
                }

                // Update summaryData for JSON export
                summaryData = {
                    totalPettyCash: totalPettyCashFund,
                    totalOtherFunds: changeFundCounted + prevSalesCounted + todaySalesCounted,
                    totalAssetsCounted: totalAssetsCounted,
                    totalVouchers: totalVouchers,
                    totalReimbursements: totalReimbursements,
                    expectedBalance: expectedBalance,
                    difference: difference,
                    status: diffLabelElem.textContent
                };
            };

            const preparePrintAppendix = () => {
                const appendixContainer = document.getElementById('print-appendix');
                appendixContainer.innerHTML = '';

                let isFirstHeader = true;
                const processAttachments = (prefix, title) => {
                    const attachedItems = Object.keys(attachments).filter(key => key.startsWith(prefix));
                    if (attachedItems.length > 0) {
                        const header = document.createElement('h2');
                        header.className = 'text-xl font-bold mb-4';
                        if (!isFirstHeader) {
                            header.classList.add('appendix-pagebreak'); // Only add page break before 2nd+ header
                        }
                        header.textContent = title;
                        appendixContainer.appendChild(header);

                        attachedItems.forEach(rowId => {
                            const row = document.getElementById(rowId);
                            const description = row.querySelector('input[type="text"]').value || 'ไม่มีคำอธิบาย';
                            const amount = parseFloat(row.querySelector('input[type="number"]').value || 0);

                            const appendixItem = document.createElement('div');
                            appendixItem.className = 'appendix-item';
                            appendixItem.innerHTML = `
                                <p><strong>รายละเอียด:</strong> ${description}</p>
                                <p><strong>จำนวนเงิน:</strong> ${formatCurrency(amount)}</p>
                                <img src="${attachments[rowId].data}" alt="หลักฐานสำหรับ ${description}">
                            `;
                            appendixContainer.appendChild(appendixItem);
                        });
                        isFirstHeader = false;
                    }
                };

                processAttachments('voucher-list', 'ภาคผนวก: หลักฐานเอกสารจ่ายรอเบิก');
                processAttachments('reimbursement-list', 'ภาคผนวก: หลักฐานรายการรอโอนเงินคืน');
            };

            const exportToJSON = () => {
                const getVal = (id) => document.getElementById(id).value;
                if (!getVal('department')) {
                    alert('กรุณากรอกชื่อสาขา/แผนกก่อนทำการ Export');
                    return;
                }

                calculateAll(); // Ensure summary data is up-to-date

                const getDynamicSectionData = (listId) => {
                    const items = [];
                    document.querySelectorAll(`#${listId} .dynamic-row`).forEach(row => {
                        const description = row.querySelector('input[type="text"]').value;
                        const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                        if (description || amount > 0) {
                            items.push({
                                description: description,
                                amount: amount,
                                hasAttachment: !!attachments[row.id]
                            });
                        }
                    });
                    return items;
                };

                const exportData = {
                    tool: 'cash-control',
                    details: {
                        branch: getVal('department'),
                        custodian: getVal('custodian'),
                        date: getVal('count-date'),
                    },
                    summary: summaryData,
                    data: {
                        vouchers: getDynamicSectionData('voucher-list'),
                        reimbursements: getDynamicSectionData('reimbursement-list')
                    }
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Cash-Control_${getVal('department')}_${getVal('count-date')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            function exportToCSV() {
                // This function remains the same
                const csvRows = [];
                const escapeCsv = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;
                const getVal = (id) => document.getElementById(id).value;
                const getTxt = (id) => document.getElementById(id).textContent;
                
                csvRows.push("ข้อมูลการตรวจนับ");
                csvRows.push(`สาขา/แผนก,${escapeCsv(getVal('department'))}`);
                csvRows.push(`ผู้ดูแลเงิน,${escapeCsv(getVal('custodian'))}`);
                csvRows.push(`วันที่ตรวจนับ,${getVal('count-date')}`);
                csvRows.push("");
                csvRows.push("สรุปผลกระทบยอด");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`เงินที่นับได้ทั้งหมด (A),${escapeCsv(getTxt('total-assets-counted'))}`);
                csvRows.push(`ยอดเงินที่ควรจะมีทั้งหมด (B),${escapeCsv(getTxt('expected-balance'))}`);
                csvRows.push(`ผลต่างรวม (A-B),${escapeCsv(getTxt('difference'))}`);
                csvRows.push(`สถานะ,${escapeCsv(getTxt('difference-label'))}`);
                csvRows.push("");
                csvRows.push("รายละเอียดเงินที่นับได้");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`รวมเงินสดย่อยทั้งหมด (ในมือ+ในบัญชี),${escapeCsv(getTxt('total-petty-cash'))}`);
                csvRows.push(`เงินทอนที่นับได้,${escapeCsv(getVal('change-fund-counted'))}`);
                csvRows.push(`เงินสดจากยอดขายวันก่อน,${escapeCsv(getVal('prev-sales-counted'))}`);
                csvRows.push(`เงินสดจากยอดขายวันนี้,${escapeCsv(getVal('today-sales-counted'))}`);
                csvRows.push("");
                csvRows.push("รายละเอียดเงินตามระบบ");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`วงเงินสดย่อยอนุมัติ,${escapeCsv(getVal('approved-petty-cash'))}`);
                csvRows.push(`วงเงินทอนอนุมัติ,${escapeCsv(getVal('approved-change-fund'))}`);
                csvRows.push(`ยอดขายวันก่อน (ตามรายงาน),${escapeCsv(getVal('prev-sales-system'))}`);
                csvRows.push(`ยอดขายวันนี้ (ตามรายงาน),${escapeCsv(getVal('today-sales-system'))}`);
                csvRows.push("");
                csvRows.push("รายการเอกสารจ่ายรอเบิก");
                csvRows.push("รายละเอียด,จำนวนเงิน,มีรูปแนบ");
                document.querySelectorAll('#voucher-list .dynamic-row').forEach(row => {
                    const desc = row.querySelector('input[type="text"]').value;
                    const amount = row.querySelector('input[type="number"]').value;
                    const hasAttachment = attachments[row.id] ? 'Y' : 'N';
                    if(desc || amount) csvRows.push(`${escapeCsv(desc)},${escapeCsv(amount)},${hasAttachment}`);
                });
                csvRows.push(`รวม,${escapeCsv(getTxt('total-vouchers'))}`);
                csvRows.push("");
                csvRows.push("รายการรอโอนเงินคืน");
                csvRows.push("รายละเอียด,จำนวนเงิน,มีรูปแนบ");
                document.querySelectorAll('#reimbursement-list .dynamic-row').forEach(row => {
                    const desc = row.querySelector('input[type="text"]').value;
                    const amount = row.querySelector('input[type="number"]').value;
                    const hasAttachment = attachments[row.id] ? 'Y' : 'N';
                    if(desc || amount) csvRows.push(`${escapeCsv(desc)},${escapeCsv(amount)},${hasAttachment}`);
                });
                csvRows.push(`รวม,${escapeCsv(getTxt('total-reimbursements'))}`);

                const csvContent = "\uFEFF" + csvRows.join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const dateStr = getVal('count-date');
                    const department = getVal('department');
                    const safeDept = department.replace(/[^a-zA-Z0-9ก-๙ _-]/g, '').replace(/\s+/g, '_');
                    link.setAttribute("href", url);
                    link.setAttribute("download", `cash_count_report_${dateStr}_${safeDept}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // --- EVENT LISTENERS ---
            document.body.addEventListener('input', (e) => { if (e.target.matches('input')) calculateAll(); });
            document.getElementById('reset-btn').addEventListener('click', () => { 
                if (confirm('คุณต้องการล้างข้อมูลทั้งหมด?')) {
                    window.location.reload();
                }
            });
            document.getElementById('print-btn').addEventListener('click', () => {
                preparePrintAppendix();
                window.print();
            });
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('export-json-btn').addEventListener('click', exportToJSON); // New listener
            calculateAll();
        });

        // Custom toast for shortcut blocking
        function showDevtoolsToast(message) {
            let toast = document.getElementById('devtools-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'devtools-toast';
                toast.style.position = 'fixed';
                toast.style.bottom = '2rem';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.background = '#222';
                toast.style.color = '#fff';
                toast.style.padding = '1rem 2rem';
                toast.style.borderRadius = '8px';
                toast.style.fontSize = '1rem';
                toast.style.zIndex = '9999';
                toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                toast.style.fontFamily = "'Sarabun', 'Noto Sans Thai', sans-serif";
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.display = 'block';
            clearTimeout(toast._timeout);
            toast._timeout = setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        // Disable right-click
        document.addEventListener("contextmenu", function(event) {
            event.preventDefault();
            showDevtoolsToast("Right-click is disabled.");
        });

        // Disable specific keyboard shortcuts
        document.addEventListener("keydown", function(event) {
            // F12
            if (event.key === "F12" || event.keyCode === 123) {
                event.preventDefault();
                showDevtoolsToast("Inspect Element is disabled.");
            }
            // Ctrl+Shift+I (Inspect), Ctrl+Shift+J (Console), Ctrl+U (View Source)
            if (
                (event.ctrlKey && event.shiftKey && (event.key.toUpperCase() === "I" || event.key.toUpperCase() === "J" || event.keyCode === 73 || event.keyCode === 74)) ||
                (event.ctrlKey && (event.key.toUpperCase() === "U" || event.keyCode === 85))
            ) {
                event.preventDefault();
                showDevtoolsToast("Developer tools access is disabled.");
            }
        });

        // Navigation functions
        function handleNavLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = '../login.html';
            }
        }

        function updateUserDisplay() {
            const currentUser = localStorage.getItem('currentUser');
            const userRole = localStorage.getItem('userRole');
            const userNameElement = document.getElementById('user-name');
            
            if (userNameElement && currentUser) {
                const displayName = currentUser.includes('@') ? currentUser.split('@')[0] : currentUser;
                const roleText = userRole === 'admin' ? ' (Admin)' : '';
                userNameElement.textContent = `${displayName}${roleText}`;
            }
        }

        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateUserDisplay();
        });

        // Navigation functions
        function handleNavLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                window.location.href = '../login.html';
            }
        }

        function updateUserDisplay() {
            const currentUser = localStorage.getItem('currentUser');
            const userRole = localStorage.getItem('userRole');
            const userNameElement = document.getElementById('user-name');
            
            if (userNameElement && currentUser) {
                const displayName = currentUser.includes('@') ? currentUser.split('@')[0] : currentUser;
                const roleText = userRole === 'admin' ? ' (Admin)' : '';
                userNameElement.textContent = `${displayName}${roleText}`;
            }
        }

        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateUserDisplay();
        });
    </script>
</body>
</html>
