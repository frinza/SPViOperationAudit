<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานผลการตรวจนับเงินสด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration Manager -->
    <script src="../config.js"></script>
    
    <!-- Session Manager -->
    <script src="../session-manager.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="../firebase-auth.js"></script>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="../styles/spvi-main.css">
    <link rel="stylesheet" href="../styles/print-legal.css">
    <!-- Global Print Header -->
    <link rel="stylesheet" href="../styles/print-header.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .currency-input { text-align: right; }
        .summary-value { font-weight: 700; font-size: 1.125rem; }
        .result-positive { color: #16a34a; }
        .result-negative { color: #dc2626; }
        .result-zero { color: #374151; }
        .dynamic-row { transition: all 0.3s ease-in-out; overflow: hidden; }
        .dynamic-row.removing { transform: translateX(100%); max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; }
        
        /* Searchable dropdown styling */
        .searchable-dropdown {
            position: relative;
        }
        
        .dropdown-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: transform 0.2s;
        }
        
        .searchable-dropdown.open .dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-top: none;
            background: white;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        
        .dropdown-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .dropdown-option:hover {
            background-color: #f3f4f6;
        }
        
        .dropdown-option.highlighted {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dropdown-option:last-child {
            border-bottom: none;
        }
        
        .no-results {
            padding: 8px 12px;
            color: #6b7280;
            font-style: italic;
            text-align: center;
        }
        
        /* Remove old dropdown styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        .print-only { display: none; }
        .attachment-thumbnail {
            width: 2.5rem;
            height: 2.5rem;
            object-fit: cover;
            border-radius: 0.375rem;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        #image-modal {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        #modal-img {
            max-height: 80vh;
            max-width: 90vw;
        }

        @media print {
            html, body {
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 0;
                background: #fff !important;
                font-family: 'TH SarabunPSK', 'TH Sarabun New', 'Sarabun', 'Times New Roman', Times, serif !important;
                color: #222 !important;
            }
            /* Global page margins controlled by print-header.css */
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                font-size: 9pt !important;
                line-height: 1.6 !important;
                background: #fff !important;
            }
            .no-print { display: none !important; }
            .print-wrapper {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background: #fff !important;
            }
            .print-container { 
                max-width: 100% !important; 
                box-shadow: none !important; 
                border: none !important; 
                border-radius: 0 !important;
                padding: 0.8rem 1.2rem !important;
                margin-bottom: 1rem !important;
                background: #fff !important;
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
            }
            .main-grid { 
                display: block !important; 
                width: 100% !important;
                gap: 0 !important;
            }
            .lg\:col-span-2, .lg\:col-span-1 { 
                width: 100% !important;
            }
            .sticky { position: static !important; }
            .print-only { display: block; }
            header, footer, #image-modal { display: none; }
            .dynamic-row {
                margin-bottom: 0.2rem !important;
                padding: 0 !important;
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
            }
            .dynamic-row input[type="text"], .dynamic-row input[type="number"] {
                padding: 1px 4px !important;
                font-size: 9pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            /* Print styling for dropdown and search elements */
            select, input[type="text"], input[type="date"] {
                padding: 1px 4px !important;
                font-size: 9pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            .dropdown-list, .dropdown-arrow {
                display: none !important;
            }
            .searchable-dropdown input {
                padding: 1px 4px !important;
                font-size: 9pt !important;
                border: 1px solid #bbb !important;
                background: #fafafa !important;
            }
            h1, h2, h3 {
                font-family: 'TH SarabunPSK', 'TH Sarabun New', 'Sarabun', 'Times New Roman', Times, serif !important;
                color: #111 !important;
                font-weight: bold !important;
            }
            h1 { font-size: 1rem !important; }
            h2 { font-size: 1rem !important; }
            h3 { font-size: 1rem !important; }
            label, .text-gray-700, .text-gray-800, .text-gray-600 {
                color: #222 !important;
            }
            .summary-value, .font-bold {
                font-weight: bold !important;
            }
            .border-t, .border-t-2, .border-b, .border-dashed, .border-gray-400, .border-gray-300, .border-gray-700, .border-gray-800 {
                border-color: #222 !important;
            }
            /* Legal section styling handled by global print-legal.css */
            #print-appendix {
                page-break-before: auto !important;
                break-before: auto !important;
                margin-top: 1rem;
            }
            .appendix-item {
                break-inside: avoid-page !important;
                page-break-inside: avoid !important;
                border: 1px solid #bbb !important;
                border-radius: 0.4rem !important;
                padding: 0.7rem 1rem !important;
                margin-bottom: 1.2rem !important;
                background: #fafafa !important;
            }
            .appendix-item img {
                max-width: 30%;
                height: auto;
                border: 1px solid #bbb;
                display: block;
                margin: 0.5rem auto;
            }
            /* Prevent grid headers from being orphaned */
            .print-container h2, .print-container h3, .print-container .grid {
                break-after: avoid-page !important;
                page-break-after: avoid !important;
            }

            /* Print header */
            .print-header {
                display: block !important;
                text-align: center;
                font-size: 1.25rem;
                font-weight: bold;
                margin-bottom: 1.5rem;
                border-bottom: 2px solid #222;
                padding-bottom: 0.5rem;
                letter-spacing: 1px;
            }
 
            .header-info {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
                break-after: avoid !important;
                page-break-after: avoid !important;
            }
            .print-container {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            .mb-6, .my-8, .mt-12, .pt-8, .mt-6, .mb-4, .mt-4, .mb-2, .mt-2 {
                margin-bottom: 0.5rem !important;
                margin-top: 0.5rem !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
            }
            .print-container {
                break-after: avoid !important;
                page-break-after: avoid !important;
            }
            .print-container + .print-container {
                margin-top: 0 !important;
            }
            .print-wrapper {
                padding-bottom: 0 !important;
            }
            .appendix-pagebreak {
                page-break-before: always !important;
                break-before: page !important;
            }
            .align-top { vertical-align: top !important; }
        }
        
        /* Enhanced collision fix is now in global print-legal.css */
    </style>
</head>
<body class="bg-slate-50 text-slate-800 logged-in">
    <!-- Global Print Header Section -->
    <div class="print-header-section"></div>
    
    <div class="container mx-auto p-4 md:p-8 max-w-7xl print-wrapper">
        <header class="text-center mb-6 no-print">
            <h1 class="text-4xl font-bold text-slate-900">ระบบตรวจนับเงินสด</h1>
            <p class="mt-2 text-slate-500">(Cash Control)</p>
        </header>
        <div class="print-only text-center mb-4">
            <h1 class="text-xl font-bold">สรุปผลการตรวจนับเงิน (Cash Control)</h1>
        </div>

        <!-- Header Information Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 print-container header-info">
            <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ข้อมูลการตรวจนับ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700">สาขา/แผนก</label>
                    <div class="relative">
                        <div class="searchable-dropdown">
                            <input type="text" id="department-search" placeholder="ค้นหาหรือเลือกสาขา..." 
                                   class="mt-1 w-full p-2 pr-8 border border-gray-300 rounded-md shadow-sm bg-white"
                                   autocomplete="off">
                            <div class="dropdown-arrow">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <div id="dropdown-list" class="dropdown-list hidden">
                                <div class="dropdown-option" data-value="">-- เลือกสาขา --</div>
                            </div>
                        </div>
                        <input type="hidden" id="department" name="department">
                    </div>
                </div>
                <div>
                    <label for="custodian" class="block text-sm font-medium text-gray-700">ผู้ดูแลเงิน (ชื่อ-ตำแหน่ง)</label>
                    <input type="text" id="custodian" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="เช่น นายกันต์กฤช พุ่มเจริญ (Operation Audit Officer)">
                </div>
                <div>
                    <label for="count-date" class="block text-sm font-medium text-gray-700">วันที่ตรวจนับ</label>
                    <input type="date" id="count-date" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 main-grid">
            <!-- Left Column: Details -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Cash Count Sections -->
                <div class="bg-white p-6 rounded-xl shadow-lg print-container">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 1: การนับเงินสดและกองอื่นๆ</h2>
                    
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">เงินสดย่อย (Petty Cash Fund)</h3>
                    <div id="cash-items">
                        <div class="grid grid-cols-3 gap-4 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span>ประเภทเงินสดในมือ</span><span class="text-center">จำนวน</span><span class="text-right">รวมเงิน (บาท)</span>
                        </div>
                    </div>
                     <div class="mt-3">
                        <label for="bank-balance-counted" class="block text-sm font-medium text-gray-700">เงินสดย่อยในบัญชีธนาคาร</label>
                        <input type="number" id="bank-balance-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินสดย่อยทั้งหมด (ในมือ+ในบัญชี)</span>
                        <span id="total-petty-cash" class="font-bold text-blue-600">0.00</span>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-600 mt-6 mb-2">เงินกองอื่นๆ</h3>
                    <div>
                        <label for="change-fund-counted" class="block text-sm font-medium text-gray-700">เงินทอนที่นับได้ (Change Fund)</label>
                        <input type="number" id="change-fund-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                     <div class="mt-3">
                        <label for="prev-sales-counted" class="block text-sm font-medium text-gray-700">เงินสดจากยอดขายวันก่อน (ที่ยังไม่นำส่ง)</label>
                        <input type="number" id="prev-sales-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                    <div class="mt-3">
                        <label for="today-sales-counted" class="block text-sm font-medium text-gray-700">เงินสดจากยอดขายวันนี้</label>
                        <input type="number" id="today-sales-counted" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                    </div>
                </div>

                <!-- Vouchers & Reimbursements -->
                <div class="bg-white p-6 rounded-xl shadow-lg print-container">
                     <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 2: เอกสารประกอบเงินสดย่อย</h2>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">เอกสารจ่ายรอเบิก (Vouchers)</h3>
                    <div id="voucher-list" class="space-y-1">
                         <div class="grid grid-cols-12 gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span class="col-span-6 md:col-span-7">รายละเอียด</span>
                            <span class="text-right col-span-3 md:col-span-3">จำนวนเงิน</span>
                            <span class="text-center col-span-3 md:col-span-2 no-print">หลักฐาน</span>
                        </div>
                    </div>
                    <button id="add-voucher" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 no-print">+ เพิ่มรายการเอกสารจ่าย</button>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินตามเอกสารจ่าย</span>
                        <span id="total-vouchers" class="font-bold text-orange-600">0.00</span>
                    </div>

                     <h3 class="text-lg font-semibold text-gray-600 mt-6 mb-2">รายการรอโอนเงินคืน</h3>
                    <div id="reimbursement-list" class="space-y-1">
                         <div class="grid grid-cols-12 gap-2 items-center mb-2 font-medium text-gray-600 text-sm">
                            <span class="col-span-6 md:col-span-7">รายละเอียด</span>
                            <span class="text-right col-span-3 md:col-span-3">จำนวนเงิน</span>
                            <span class="text-center col-span-3 md:col-span-2 no-print">หลักฐาน</span>
                        </div>
                    </div>
                    <button id="add-reimbursement" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 no-print">+ เพิ่มรายการรอโอนคืน</button>
                    <div class="border-t pt-2 mt-2 flex justify-between items-center">
                        <span class="font-bold text-gray-800">รวมเงินรอโอนคืน</span>
                        <span id="total-reimbursements" class="font-bold text-green-600">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-8 print-container">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4">ส่วนที่ 3: สรุปผลกระทบยอด</h2>
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-600">ยอดเงินตามระบบ</h3>
                        <div>
                            <label for="approved-petty-cash" class="block text-sm font-medium text-gray-700">วงเงินสดย่อยอนุมัติ</label>
                            <input type="number" id="approved-petty-cash" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                         <div>
                            <label for="approved-change-fund" class="block text-sm font-medium text-gray-700">วงเงินทอนอนุมัติ</label>
                            <input type="number" id="approved-change-fund" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        <div>
                            <label for="prev-sales-system" class="block text-sm font-medium text-gray-700">ยอดขายวันก่อน (ตามรายงาน)</label>
                            <input type="number" id="prev-sales-system" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        <div>
                            <label for="today-sales-system" class="block text-sm font-medium text-gray-700">ยอดขายวันนี้ (ตามรายงาน)</label>
                            <input type="number" id="today-sales-system" value="" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input" placeholder="0.00">
                        </div>
                        
                        <div class="border-t pt-3 space-y-4 print:flex print:space-y-0 print:gap-8 print:items-start">
                            <!-- เงินที่นับได้ทั้งหมด (A) -->
                            <div class="print:w-1/3">
                                <h3 class="text-sm font-medium text-gray-700">เงินที่นับได้ทั้งหมด (A)</h3>
                                <p id="total-assets-counted" class="summary-value text-blue-600">0.00</p>
                                <p class="text-xs text-gray-500">(กองเงินสดย่อย+กองอื่นๆ)</p>
                            </div>
                            <!-- ยอดเงินที่ควรมีทั้งหมด (B) -->
                            <div class="print:w-1/3">
                                <h3 class="text-sm font-medium text-gray-700">ยอดเงินที่ควรมีทั้งหมด (B)</h3>
                                <p id="expected-balance" class="summary-value text-gray-800">0.00</p>
                                <p class="text-xs text-gray-500">(ยอดตามระบบ - รอคืน - เอกสารจ่าย)</p>
                            </div>
                        
                            <!-- ยอดเงินที่ต่าง (A-B) -->
                            <div class="border-t-2 border-gray-300 pt-4 print:w-1/3 print:border-0 print:pt-0 print:align-top">
                                <p class="text-lg font-bold text-gray-700">ผลต่างรวม (A-B)</p>
                                <p id="difference" class="text-2xl font-bold result-zero">0.00</p>
                                <p id="difference-label" class="text-sm font-bold result-zero"></p>
                            </div>
                        </div>

                    </div>
                    <div class="mt-6 space-y-2 no-print">
                         <button id="export-csv-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Export to CSV</button>
                         <button id="export-json-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Export to JSON</button>
                         <button id="export-pdf-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                             <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                             </svg>
                             Export เป็น PDF
                         </button>
                         <button id="reset-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">เริ่มใหม่</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legal Declaration and Signature Section (print only) -->
        <div class="print-legal-section">
            <div class="legal-certification">
                ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ
                <div class="english-text">
                    (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature-container">
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <div class="signature-name">ลงชื่อ .................................................</div>
                        <div class="signature-title">(ผู้ตรวจสอบ / Auditor)</div>
                        <div class="signature-date">
                            วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                        </div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <div class="signature-name">ลงชื่อ .................................................</div>
                        <div class="signature-title">(ผู้รับการตรวจสอบ / Auditee)</div>
                        <div class="signature-date">
                            วันที่: <span class="signature-date-line"></span> / <span class="signature-date-line"></span> / <span class="signature-date-line"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appendix for Printing Attachments -->
        <div id="print-appendix" class="print-only"></div>

        <footer class="text-center mt-12 text-gray-500 text-sm no-print">
            <p>Cash Control Application</p>
        </footer>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden no-print" onclick="this.classList.add('hidden')">
        <div class="relative p-4">
            <img id="modal-img" src="" alt="Full size attachment" class="rounded-lg shadow-2xl">
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Branch list data
            const branches = [
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) Iphone',
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) SVOA',
                'B000 HO บมจ.เอส พี วี ไอ(สำนักงานใหญ่) อุปกรณ์เสริม',
                'B002 IBeat – IT Mall ไอที มอลล์ ฟอร์จูน (B-IT)',
                'B004 IBeat Esplanade เอสพลานาด ซีนีเพล็กซ์ รัชดาภิเษก(B-ES)',
                'B006 Ustore TU Rungsit มหาวิทยาลัยธรรมศาสตร์ รังสิต (TUR)',
                'B007 Ustore ABAC Bangna มหาวิทยาลัยอัสสัมชัญ สุวรรณภูมิ (ABB)',
                'B008 Ustore TU Thaprajan มหาวิทยาลัยธรรมศาสตร์ ท่าพระจันทร์ (TUT)',
                'B009 iStudio Central Chaengwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (S-CW)',
                'B010 iStudio Seacon Square ซีคอนสแควร์ ศรีนครินทร์ (S-SQ)',
                'B012 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ บางเขน (KU)',
                'B013 Ustore Mahidol University มหาวิทยาลัยมหิดล ศาลายา(MU)',
                'B016 Ustore Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (BUR)',
                'B017 Ustore Dhurakij Pundit University มหาวิทยาลัยธุรกิจบัณฑิตย์(DPU)',
                'B018 iStudio Central Rama 9 เซ็นทรัลพลาซา แกรนด์ พระราม 9 (S-CR)',
                'B019 Ustore Burapha University มหาวิทยาลัยบูรพา (BUU)',
                'B020 iCenter Central Changwattana เซ็นทรัลพลาซ่า แจ้งวัฒนะ (C-CCW)',
                'B021 IBeat Gateway Ekamai เกตเวย์ เอกมัย (B-GE)',
                'B024 IBeat – Central Chiang Rai เซ็นทรัล เชียงราย (B-CCR)',
                'B031 iStudio Central Rayong เซ็นทรัลพลาซา ระยอง (S-CRY)',
                'B032 iCenter Central Chiang Rai เซ็นทรัลเชียงราย (C-CCR)',
                'B034 AIS Lotus Rayong โลตัสระยอง (A-LR)',
                'B035 AIS Big C Aranyaprathet บิ๊กซี อรัญประเทศ(A-BA)',
                'B036 iCenter Laemtong Rayong แหลมทอง ระยอง (C-LRY)',
                'B037 Mobi Phayao พะเยา (M-PY)',
                'B038 Mobi Lumphun ลำพูน (M-LP)',
                'B039 iCenter Homepro Nakhonpatom ศูนย์การค้าโฮมโปรนครปฐม (I-HNT)',
                'B040 AIS Robinson Lifestyle Chanthaburiโรบินสัน ไลฟ์สไตล์ จันทบุรี (A-RJ)',
                'B044 AIS Telewiz Lotus Rojana โลตัส โรจนะ (A-LRJ)',
                'B046 AIS Lotus Ban Chang โลตัส บ้านฉาง (A-LC)',
                'B047 AIS Telewiz Lotus lom sak โลตัส หล่มสัก(A-LL)',
                'B048 I Beat Robinson kampaeng phet โรบินสัน กำแพงเพชร (B-RK)',
                'B049 Mobi phichit พิจิตร (M-PJ)',
                'B050 AIS Telewiz Big C Wichian Buri บิ๊กซี วิเชียรบุรี(A-BW)',
                'B051 AIS Robinson Kamphaeng Phet โรบินสันกำแพงเพชร(A-RK)',
                'B052 AIS Buddy phayao ศูนย์การค้า ท็อปส์ พลาซ่า พะเยา (A-PY)',
                'B053 AIS Lotus Phetchaboon โลตัส เพชรบูรณ์ (A-LP)',
                'B054 AIS shop Big C sattahip ศูนย์การค้าบิ๊กซีซุปเปอร์เซนเตอร์สาขาสัตหีบ (A-BS)',
                'B055 iCenter G Tower อาคารจี ทาวเวอร์ แกรนด์ พระราม 9 (C-GR)',
                'B056 AIS robinson chonburi โรบินสันชลบุรี2 (อมตะนคร) (A-RC)',
                'B058 AIS Telewiz U-Tapao โลตัส สาขาอู่ตะเภา (A-UT)',
                'B059 AIS Central Rayong เซ็นทรัล พลาซา สาขา ระยอง (A-CR)',
                'B061 Ustore Mae Fah Luang University มหาวิทยาลัยแม่ฟ้าหลวง(MFU)',
                'B062 Ustore KMUTNB พระจอมเกล้าพระนครเหนือ (KMU)',
                'B063 Ustore Naresuan University มหาวิทยาลัยนเรศวร(NU)',
                'B064 AIS Telewiz Si-Thap ศรีเทพ(A-ST)',
                'B065 Ustore Mahasarakham University มหาวิทยาลัยมหาสารคาม',
                'B066 Ustore Rambhai Barni Rajabhat University มรภ.รำไพพรรณี (RBRU)',
                'B067 Ustore Chiang Mai Rajabhat University มรภ.เชียงใหม่ (CMRU)',
                'B068 A-Store มหาวิทยาลัยศรีนครินทรวิโรฒ ประสานมิตร (A-SWU)',
                'B069 Ustore Prince of Songkla University มหาวิทยาลัยสงขลานครินทร์ (PSU)',
                'B070 A-Store มหาวิทยาลัยสงขลานครินทร์ (A-PSU)',
                'B071 Ustore University of Phayao มหาวิทยาลัยพะเยา (UP)',
                'B072 Ustore SUT มหาวิทยาลัยเทคโนโลยีสุรนารี (SUT)',
                'B073 Ustore Maejo University มหาวิทยาลัยแม่โจ้ (MJU)',
                'B074 Ustore RMUTT มหาวิทยาลัยเทคโนโลยีราชมงคลธัญบุรี(RMUTT)',
                'B075 AIS Telewiz Lotus Chonburi โลตัส สาขา ชลบุรี (A-LCB)',
                'B076 A-Store มหาวิทยาลัยมหิดล ศาลายา (A-MU)',
                'B077 iCenter Phuke ศูนย์การค้าเซ็นทรัล ภูเก็ต (I-PNPT)',
                'B078 AIS Robinson Mae Sot โรบินสัน แม่สอด (A-RM)',
                'B079 A-Store มหาวิทยาลัยเทคโนโลยีสุรนารี (A-SUT)',
                'B080 Icenter Robinson Chanthaburi โรบินสันไลฟ์สไตล์ จันทบุรี (I-RJ)',
                'B081 AIS Telewiz Laemtong Chonburi แหลมทองชลบุรี(A-LCH)',
                'B083 A-Store Bangkok University Rangsit มหาวิทยาลัยกรุงเทพ รังสิต (A-BU)',
                'B084 Mobi Suvarnabhumi มาร์เก็ตวิลเลจ สุวรรณภูมิ(M-MS)',
                'B085 Ustore Nakhon Pathom Rajabhat University มรภ.นครปฐม (NPRU)',
                'B087 AIS Robinson Ban Chang โรบินสัน บ้านฉาง(A-RB)',
                'B089 A-Store มหาวิทยาลัยแม่ฟ้าหลวง (A-MFU)',
                'B090 U Store Pibulsongkram Rajabhat University มรภ.พิบูลสงคราม(PSRU)',
                'B091 A-Store มหาวิทยาลัยราชภัฏเชียงใหม่ (A-CMRU)',
                'B092 AIS Shop Robinson Lifestyle Thalang โรบินสัน ไลฟ์สไตล์ ถลาง(A-RT)',
                'B093 Ustore TU Rungsit-MED ม.ธรรมศาสตร์รังสิต คณะแพทย์ฯ (TUMED)',
                'B094 U Store SIAMSCAPE สยามสเคป',
                'B095 A-Store มหาวิทยาลัยมหาสารคาม (A-MSU)',
                'B096 A-Store มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (A-KUSRC)',
                'B097 Ustore Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ ศรีราชา (U-KUSRC)',
                'B098 Mobi Lotus Bo Win โลตัส บ่อวิน(M-LBV)',
                'B099 AIS Mini Shop Lotus Pak Kret โลตัสปากเกร็ด (M-LPK)',
                'B100 AIS Telewiz Lotus Sattahip โลตัสสัตหีบ(A-LS)',
                'B101 AIS Buddy Krua Sahapat เครือสหพัฒน์ จ.ชลบุรี (A-KS)',
                'B102 A-Store Kasetsart University มหาวิทยาลัยเกษตรศาสตร์ (KU)',
                'B103 Ustore RMUTK มหาวิทยาลัยเทคโนโลยีราชมงคลกรุงเทพ(RMUTK)',
                'B104 Ustore Phranakhon Rajabhat Universityมหาวิทยาลัยราชภัฏพระนคร(PNRU)',
                'B105 Ustore Nakhon Sawan Rajabhat University มหาวิทยาลัยราชภัฐนครสวรรค์',
                'B106 iStudio Central Westville ราชพฤกษ์(ศูนย์ iCenter)',
                'B107 iStudio Central Nakhon Sawan เซ็นทรัล นครสวรรค์ (ศูนย์ iCenter)',
                'B109 AIS Telewiz Lotus พะเยา(A-LPY)',
                'B110 Mobi Esplanade',
                'B111 Head Office <AIS Shop Robinson Chalong>',
                'B112 Head Office <AIS Telewiz Lotus Samkong>'
            ];

            // Populate branch dropdown with searchable functionality
            const departmentSearch = document.getElementById('department-search');
            const departmentHidden = document.getElementById('department');
            const dropdownList = document.getElementById('dropdown-list');
            const searchableDropdown = document.querySelector('.searchable-dropdown');
            
            // Populate dropdown options
            branches.forEach(branch => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.setAttribute('data-value', branch);
                option.textContent = branch;
                dropdownList.appendChild(option);
            });

            // Searchable dropdown functionality
            let filteredBranches = [...branches];
            let highlightedIndex = -1;
            let isOpen = false;

            function filterOptions(searchTerm) {
                filteredBranches = branches.filter(branch => 
                    branch.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                // Clear existing options
                dropdownList.innerHTML = '<div class="dropdown-option" data-value="">-- เลือกสาขา --</div>';
                
                if (filteredBranches.length === 0 && searchTerm) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.textContent = 'ไม่พบสาขาที่ตรงกับการค้นหา';
                    dropdownList.appendChild(noResults);
                } else {
                    filteredBranches.forEach(branch => {
                        const option = document.createElement('div');
                        option.className = 'dropdown-option';
                        option.setAttribute('data-value', branch);
                        option.textContent = branch;
                        dropdownList.appendChild(option);
                    });
                }
                
                highlightedIndex = -1;
                updateHighlight();
            }

            function updateHighlight() {
                const options = dropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                options.forEach((option, index) => {
                    option.classList.toggle('highlighted', index === highlightedIndex);
                });
            }

            function openDropdown() {
                isOpen = true;
                searchableDropdown.classList.add('open');
                dropdownList.classList.remove('hidden');
            }

            function closeDropdown() {
                isOpen = false;
                searchableDropdown.classList.remove('open');
                dropdownList.classList.add('hidden');
                highlightedIndex = -1;
                updateHighlight();
            }

            function selectOption(value, text) {
                departmentHidden.value = value;
                departmentSearch.value = text;
                closeDropdown();
            }

            // Event listeners
            departmentSearch.addEventListener('focus', () => {
                filterOptions(departmentSearch.value);
                openDropdown();
            });

            departmentSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                filterOptions(searchTerm);
                if (!isOpen) openDropdown();
                
                // If exact match, select it
                const exactMatch = branches.find(branch => 
                    branch.toLowerCase() === searchTerm.toLowerCase()
                );
                if (exactMatch) {
                    departmentHidden.value = exactMatch;
                } else {
                    departmentHidden.value = '';
                }
            });

            departmentSearch.addEventListener('keydown', (e) => {
                if (!isOpen) return;
                
                const options = dropdownList.querySelectorAll('.dropdown-option:not(.no-results)');
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                        updateHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        highlightedIndex = Math.max(highlightedIndex - 1, -1);
                        updateHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (highlightedIndex >= 0 && options[highlightedIndex]) {
                            const selectedOption = options[highlightedIndex];
                            selectOption(selectedOption.dataset.value, selectedOption.textContent);
                        } else if (filteredBranches.length === 1) {
                            selectOption(filteredBranches[0], filteredBranches[0]);
                        }
                        break;
                    case 'Escape':
                        closeDropdown();
                        departmentSearch.blur();
                        break;
                }
            });

            // Click on dropdown options
            dropdownList.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-option') && e.target.dataset.value !== undefined) {
                    selectOption(e.target.dataset.value, e.target.textContent);
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchableDropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Handle dropdown arrow click
            searchableDropdown.addEventListener('click', (e) => {
                if (e.target.closest('.dropdown-arrow')) {
                    if (isOpen) {
                        closeDropdown();
                    } else {
                        departmentSearch.focus();
                    }
                }
            });

            // State for storing attachments
            let attachments = {};
            let summaryData = {};

            const dateInput = document.getElementById('count-date');
            dateInput.value = new Date().toISOString().substring(0, 10);
            
            const cashItemsContainer = document.getElementById('cash-items');
            const denominations = [
                { value: 1000, label: 'ธนบัตร ฿1,000' }, { value: 500, label: 'ธนบัตร ฿500' },
                { value: 100, label: 'ธนบัตร ฿100' }, { value: 50, label: 'ธนบัตร ฿50' },
                { value: 20, label: 'ธนบัตร ฿20' }, { value: 0, label: 'เหรียญ (รวม)', isCoin: true }
            ];
            denominations.forEach(denom => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-4 items-center';
                row.innerHTML = `<label class="text-gray-700 text-sm">${denom.label}</label>
                    <input type="number" min="0" data-value="${denom.value}" data-type="${denom.isCoin ? 'coin' : 'note'}" class="cash-denom-input w-full p-2 border border-gray-300 rounded-md shadow-sm text-center" placeholder="0">
                    <span class="total-denom-value text-right text-gray-800 text-sm">0.00</span>`;
                cashItemsContainer.appendChild(row);
            });
            
            function setupDynamicSection(addButtonId, listId, inputClassName, placeholder, hasAttachment = false) {
                const addButton = document.getElementById(addButtonId);
                const list = document.getElementById(listId);
                let rowCount = 0;
                
                const addRow = () => {
                    rowCount++;
                    const rowId = `${listId}-row-${rowCount}`;
                    const row = document.createElement('div');
                    row.id = rowId;
                    row.className = 'grid grid-cols-12 gap-2 items-center dynamic-row mb-2';
                    
                    let attachmentHTML = '';
                    if (hasAttachment) {
                        attachmentHTML = `
                        <div class="col-span-3 md:col-span-2 text-center no-print">
                            <label for="attach-${rowId}" class="attachment-label cursor-pointer inline-block" data-row-id="${rowId}">
                                <img src="https://placehold.co/40x40/e0e7ff/4338ca?text=+" class="attachment-thumbnail" id="thumb-${rowId}">
                            </label>
                            <input type="file" id="attach-${rowId}" accept="image/*" class="hidden">
                        </div>`;
                    }
                    
                    row.innerHTML = `
                        <input type="text" class="${hasAttachment ? 'col-span-6 md:col-span-7' : 'col-span-8 md:col-span-9'} p-2 border border-gray-300 rounded-md shadow-sm" placeholder="${placeholder}">
                        <div class="${hasAttachment ? 'col-span-3 md:col-span-3' : 'col-span-4 md:col-span-3'} flex items-center gap-1">
                            <input type="number" min="0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm currency-input ${inputClassName}" placeholder="0.00">
                        </div>
                        ${attachmentHTML}
                        <div class="col-span-12 flex justify-end">
                             <button class="remove-row text-red-500 hover:text-red-700 p-1 no-print text-xs" title="ลบรายการ">ลบรายการ</button>
                        </div>
                    `;
                    list.appendChild(row);

                    row.querySelector('.remove-row').addEventListener('click', (e) => {
                        e.preventDefault();
                        const rowToRemove = e.target.closest('.dynamic-row');
                        rowToRemove.classList.add('removing');
                        rowToRemove.addEventListener('transitionend', () => { 
                            delete attachments[rowId];
                            rowToRemove.remove(); 
                            calculateAll();
                        });
                    });

                    if (hasAttachment) {
                        const fileInput = row.querySelector(`#attach-${rowId}`);
                        fileInput.addEventListener('change', (e) => handleAttachment(e, rowId));
                        
                        const thumb = row.querySelector(`#thumb-${rowId}`);
                        thumb.addEventListener('click', (e) => {
                            if (attachments[rowId]) {
                                e.preventDefault(); // prevent re-opening file dialog
                                showImageModal(attachments[rowId].data);
                            }
                        });
                    }
                };
                addButton.addEventListener('click', addRow);
                addRow();
            }

            setupDynamicSection('add-voucher', 'voucher-list', 'voucher-amount', 'เช่น ค่าทางด่วน, ค่าอุปกรณ์', true);
            setupDynamicSection('add-reimbursement', 'reimbursement-list', 'reimbursement-amount', 'เช่น รอรับโอนคืนค่าซ่อม', true);

            const handleAttachment = (event, rowId) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const thumbnail = document.getElementById(`thumb-${rowId}`);
                    thumbnail.src = e.target.result;
                    attachments[rowId] = {
                        data: e.target.result,
                        name: file.name
                    };
                };
                reader.readAsDataURL(file);
            };

            const showImageModal = (imageData) => {
                document.getElementById('modal-img').src = imageData;
                document.getElementById('image-modal').classList.remove('hidden');
            };

            const formatCurrency = (num) => isNaN(num) ? '0.00' : num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            const calculateAll = () => {
                let physicalPettyCash = Array.from(document.querySelectorAll('.cash-denom-input')).reduce((sum, input) => {
                    const count = parseFloat(input.value) || 0;
                    const totalForItem = input.dataset.type === 'note' ? count * parseFloat(input.dataset.value) : count;
                    input.nextElementSibling.textContent = formatCurrency(totalForItem);
                    return sum + totalForItem;
                }, 0);
                const bankBalanceCounted = parseFloat(document.getElementById('bank-balance-counted').value) || 0;
                
                const totalPettyCashFund = physicalPettyCash + bankBalanceCounted;
                document.getElementById('total-petty-cash').textContent = formatCurrency(totalPettyCashFund);

                const changeFundCounted = parseFloat(document.getElementById('change-fund-counted').value) || 0;
                const prevSalesCounted = parseFloat(document.getElementById('prev-sales-counted').value) || 0;
                const todaySalesCounted = parseFloat(document.getElementById('today-sales-counted').value) || 0;

                const totalAssetsCounted = totalPettyCashFund + changeFundCounted + prevSalesCounted + todaySalesCounted;
                document.getElementById('total-assets-counted').textContent = formatCurrency(totalAssetsCounted);
                
                const approvedPettyCash = parseFloat(document.getElementById('approved-petty-cash').value) || 0;
                const approvedChangeFund = parseFloat(document.getElementById('approved-change-fund').value) || 0;
                const prevSalesSystem = parseFloat(document.getElementById('prev-sales-system').value) || 0;
                const todaySalesSystem = parseFloat(document.getElementById('today-sales-system').value) || 0;
                
                let totalVouchers = Array.from(document.querySelectorAll('.voucher-amount')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
                document.getElementById('total-vouchers').textContent = formatCurrency(totalVouchers);
                let totalReimbursements = Array.from(document.querySelectorAll('.reimbursement-amount')).reduce((sum, el) => sum + (parseFloat(el.value) || 0), 0);
                document.getElementById('total-reimbursements').textContent = formatCurrency(totalReimbursements);

                const expectedSystemTotal = approvedPettyCash + approvedChangeFund + prevSalesSystem + todaySalesSystem;
                const expectedBalance = expectedSystemTotal - totalReimbursements - totalVouchers;
                document.getElementById('expected-balance').textContent = formatCurrency(expectedBalance);

                const difference = totalAssetsCounted - expectedBalance;
                const diffElem = document.getElementById('difference');
                const diffLabelElem = document.getElementById('difference-label');
                
                diffElem.textContent = formatCurrency(Math.abs(difference));
                diffElem.className = 'text-2xl font-bold';
                diffLabelElem.className = 'text-sm font-bold';

                if (difference > 0.005) {
                    diffElem.classList.add('result-positive');
                    diffLabelElem.classList.add('result-positive');
                    diffLabelElem.textContent = 'เงินเกิน (Overage)';
                } else if (difference < -0.005) {
                    diffElem.classList.add('result-negative');
                    diffLabelElem.classList.add('result-negative');
                    diffLabelElem.textContent = 'เงินขาด (Shortage)';
                } else {
                    diffElem.classList.add('result-zero');
                    diffLabelElem.classList.add('result-zero');
                    diffLabelElem.textContent = 'ยอดเงินถูกต้อง';
                }

                // Update summaryData for JSON export
                summaryData = {
                    totalPettyCash: totalPettyCashFund,
                    totalOtherFunds: changeFundCounted + prevSalesCounted + todaySalesCounted,
                    totalAssetsCounted: totalAssetsCounted,
                    totalVouchers: totalVouchers,
                    totalReimbursements: totalReimbursements,
                    expectedBalance: expectedBalance,
                    difference: difference,
                    status: diffLabelElem.textContent
                };
            };

            const preparePrintAppendix = () => {
                const appendixContainer = document.getElementById('print-appendix');
                appendixContainer.innerHTML = '';

                let isFirstHeader = true;
                const processAttachments = (prefix, title) => {
                    const attachedItems = Object.keys(attachments).filter(key => key.startsWith(prefix));
                    if (attachedItems.length > 0) {
                        const header = document.createElement('h2');
                        header.className = 'text-xl font-bold mb-4';
                        if (!isFirstHeader) {
                            header.classList.add('appendix-pagebreak'); // Only add page break before 2nd+ header
                        }
                        header.textContent = title;
                        appendixContainer.appendChild(header);

                        attachedItems.forEach(rowId => {
                            const row = document.getElementById(rowId);
                            const description = row.querySelector('input[type="text"]').value || 'ไม่มีคำอธิบาย';
                            const amount = parseFloat(row.querySelector('input[type="number"]').value || 0);

                            const appendixItem = document.createElement('div');
                            appendixItem.className = 'appendix-item';
                            appendixItem.innerHTML = `
                                <p><strong>รายละเอียด:</strong> ${description}</p>
                                <p><strong>จำนวนเงิน:</strong> ${formatCurrency(amount)}</p>
                                <img src="${attachments[rowId].data}" alt="หลักฐานสำหรับ ${description}">
                            `;
                            appendixContainer.appendChild(appendixItem);
                        });
                        isFirstHeader = false;
                    }
                };

                processAttachments('voucher-list', 'ภาคผนวก: หลักฐานเอกสารจ่ายรอเบิก');
                processAttachments('reimbursement-list', 'ภาคผนวก: หลักฐานรายการรอโอนเงินคืน');
            };

            const exportToJSON = () => {
                const getVal = (id) => document.getElementById(id).value;
                if (!getVal('department')) {
                    alert('กรุณากรอกชื่อสาขา/แผนกก่อนทำการ Export');
                    return;
                }

                calculateAll(); // Ensure summary data is up-to-date

                const getDynamicSectionData = (listId) => {
                    const items = [];
                    document.querySelectorAll(`#${listId} .dynamic-row`).forEach(row => {
                        const description = row.querySelector('input[type="text"]').value;
                        const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                        if (description || amount > 0) {
                            items.push({
                                description: description,
                                amount: amount,
                                hasAttachment: !!attachments[row.id]
                            });
                        }
                    });
                    return items;
                };

                const exportData = {
                    tool: 'cash-control',
                    details: {
                        branch: getVal('department'),
                        custodian: getVal('custodian'),
                        date: getVal('count-date'),
                    },
                    summary: summaryData,
                    data: {
                        vouchers: getDynamicSectionData('voucher-list'),
                        reimbursements: getDynamicSectionData('reimbursement-list')
                    }
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Cash-Control_${getVal('department')}_${getVal('count-date')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            const exportToPDF = async () => {
                const getVal = (id) => {
                    const element = document.getElementById(id);
                    return element ? element.value || '' : '';
                };
                const getTxt = (id) => {
                    const element = document.getElementById(id);
                    return element ? element.textContent || '0.00' : '0.00';
                };
                
                if (!getVal('department')) {
                    alert('กรุณากรอกชื่อสาขา/แผนกก่อนทำการ Export PDF');
                    return;
                }

                try {
                    // Show loading
                    const button = document.getElementById('export-pdf-btn');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>กำลังสร้าง PDF...';
                    button.disabled = true;

                    calculateAll(); // Ensure summary data is up-to-date

                    // Validate required libraries
                    if (typeof window.jspdf === 'undefined') {
                        throw new Error('jsPDF library not loaded');
                    }
                    if (typeof html2canvas === 'undefined') {
                        throw new Error('html2canvas library not loaded');
                    }

                    // Create temporary div for PDF content
                    const pdfContent = document.createElement('div');
                    pdfContent.style.width = '210mm';
                    pdfContent.style.minHeight = '297mm';
                    pdfContent.style.padding = '20mm';
                    pdfContent.style.backgroundColor = 'white';
                    pdfContent.style.fontFamily = 'Sarabun, sans-serif';
                    pdfContent.style.fontSize = '12pt';
                    pdfContent.style.lineHeight = '1.4';
                    pdfContent.style.position = 'absolute';
                    pdfContent.style.left = '-9999px';
                    pdfContent.style.top = '0';

                    // Get dynamic section data
                    const getDynamicSectionData = (listId) => {
                        const items = [];
                        document.querySelectorAll(`#${listId} .dynamic-row`).forEach(row => {
                            const description = row.querySelector('input[type="text"]').value;
                            const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                            if (description || amount > 0) {
                                items.push({
                                    description: description || '-',
                                    amount: amount.toLocaleString('th-TH', { minimumFractionDigits: 2 }),
                                    hasAttachment: !!attachments[row.id] ? 'มี' : 'ไม่มี'
                                });
                            }
                        });
                        return items;
                    };

                    const vouchers = getDynamicSectionData('voucher-list');
                    const reimbursements = getDynamicSectionData('reimbursement-list');

                    // Add header and content
                    pdfContent.innerHTML = `
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div style="text-align: left; font-size: 10pt; font-weight: bold;">
                                    Operation Audit Division<br>
                                    (ฝ่ายตรวจสอบปฏิบัติการ)
                                </div>
                                <div style="text-align: right; font-size: 8pt; max-width: 280px;">
                                    บริษัท เอส พี วี ไอ จำกัด (มหาชน)<br>
                                    1550/5 อาคารธนิยะ พลาซ่า ชั้น 12A ถนนเพลินจิต<br>
                                    แขวงลุมพินี เขตปทุมวัน กรุงเทพมหานคร 10330<br>
                                    โทร. 0-2658-8881 แฟกซ์ 0-2658-8870
                                </div>
                            </div>
                            <h1 style="font-size: 18pt; font-weight: bold; margin: 0;">รายงานผลการตรวจนับเงินสด</h1>
                            <p style="font-size: 12pt; color: #666; margin: 5px 0 0 0;">รายงานการตรวจสอบและกระทบยอดเงินสด</p>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h2 style="font-size: 14pt; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">รายละเอียดการตรวจสอบ</h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div><strong>สาขา/แผนก:</strong> ${getVal('department') || '-'}</div>
                                <div><strong>ผู้ดูแลเงินสด:</strong> ${getVal('custodian') || '-'}</div>
                                <div><strong>วันที่ตรวจนับ:</strong> ${getVal('count-date') || '-'}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 15px; color: #1e40af;">สรุปผลการตรวจนับ</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="font-size: 11pt; font-weight: bold; margin-bottom: 10px;">ยอดเงินที่ตรวจนับได้</h4>
                                    <div style="background: #f8fafc; padding: 10px; border-radius: 5px; font-size: 10pt;">
                                        <div>เงินสดย่อยทั้งหมด: ${getTxt('total-petty-cash')} บาท</div>
                                        <div>เงินทอนที่นับได้: ${getVal('change-fund-counted') || '0.00'} บาท</div>
                                        <div>เงินสดจากยอดขายวันก่อน: ${getVal('prev-sales-counted') || '0.00'} บาท</div>
                                        <div>เงินสดจากยอดขายวันนี้: ${getVal('today-sales-counted') || '0.00'} บาท</div>
                                        <div style="border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px; font-weight: bold;">
                                            รวมเงินสดทั้งหมด: ${getTxt('total-assets-counted')} บาท
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="font-size: 11pt; font-weight: bold; margin-bottom: 10px;">ผลการกระทบยอด</h4>
                                    <div style="background: #f8fafc; padding: 10px; border-radius: 5px; font-size: 10pt;">
                                        <div>ยอดที่ควรจะมี: ${getTxt('expected-balance')} บาท</div>
                                        <div>ยอดที่ตรวจนับได้: ${getTxt('total-assets-counted')} บาท</div>
                                        <div>เอกสารจ่ายรอเบิก: ${getTxt('total-vouchers')} บาท</div>
                                        <div>รายการรอโอนคืน: ${getTxt('total-reimbursements')} บาท</div>
                                        <div style="border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px; font-weight: bold;">
                                            ผลต่าง: <span style="color: ${(() => {
                                                const diff = parseFloat(getTxt('difference').replace(/[^0-9.-]/g, '')) || 0;
                                                return diff > 0.005 ? '#16a34a' : diff < -0.005 ? '#dc2626' : '#374151';
                                            })()};">
                                                ${getTxt('difference')} บาท
                                            </span>
                                        </div>
                                        <div style="font-size: 9pt; color: #666; margin-top: 5px;">
                                            สถานะ: ${getTxt('difference-label') || 'ยอดเงินถูกต้อง'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    // Add vouchers section if there are any
                    if (vouchers.length > 0) {
                        pdfContent.innerHTML += `
                            <div style="margin-bottom: 25px; page-break-inside: avoid;">
                                <h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 15px; color: #1e40af;">รายการเอกสารจ่ายรอเบิก</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: left;">รายละเอียด</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">จำนวนเงิน (บาท)</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">หลักฐาน</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${vouchers.map(item => `
                                            <tr>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px;">${item.description}</td>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">${item.amount}</td>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">${item.hasAttachment}</td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f8fafc; font-weight: bold;">
                                            <td style="border: 1px solid #e2e8f0; padding: 8px;">รวม</td>
                                            <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">${getTxt('total-vouchers') || '0.00'}</td>
                                            <td style="border: 1px solid #e2e8f0; padding: 8px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>`;
                    }

                    // Add reimbursements section if there are any
                    if (reimbursements.length > 0) {
                        pdfContent.innerHTML += `
                            <div style="margin-bottom: 25px; page-break-inside: avoid;">
                                <h3 style="font-size: 12pt; font-weight: bold; margin-bottom: 15px; color: #1e40af;">รายการรอโอนเงินคืน</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: left;">รายละเอียด</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">จำนวนเงิน (บาท)</th>
                                            <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">หลักฐาน</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${reimbursements.map(item => `
                                            <tr>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px;">${item.description}</td>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">${item.amount}</td>
                                                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">${item.hasAttachment}</td>
                                            </tr>
                                        `).join('')}
                                        <tr style="background: #f8fafc; font-weight: bold;">
                                            <td style="border: 1px solid #e2e8f0; padding: 8px;">รวม</td>
                                            <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">${getTxt('total-reimbursements') || '0.00'}</td>
                                            <td style="border: 1px solid #e2e8f0; padding: 8px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>`;
                    }

                    // Add legal declaration
                    pdfContent.innerHTML += `
                        <div style="margin-top: 40px; page-break-before: always;">
                            <div style="border: 2px solid #222; border-radius: 8px; background: #f7f7f7; padding: 15px; text-align: center; margin-bottom: 30px;">
                                <p style="margin: 0; font-size: 11pt; line-height: 1.4;">
                                    <strong>คำรับรองและคำประกาศความถูกต้อง</strong><br>
                                    ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องและครบถ้วนตามสภาพความเป็นจริง<br>
                                    และได้ปฏิบัติตามมาตรฐานการตรวจสอบของบริษัทอย่างเคร่งครัด
                                </p>
                                <p style="margin: 10px 0 0 0; font-size: 10pt; color: #666;">
                                    I certify that the information in this report is accurate and complete<br>
                                    and conducted in accordance with company audit standards
                                </p>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                                <div style="text-align: center; width: 45%;">
                                    <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                                    <div style="margin-bottom: 5px; font-weight: bold;">ลายเซ็นผู้ตรวจสอบ</div>
                                    <div style="margin-bottom: 20px; font-size: 10pt;">Auditor Signature</div>
                                    <div>วันที่ / Date: _______________</div>
                                </div>
                                <div style="text-align: center; width: 45%;">
                                    <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                                    <div style="margin-bottom: 5px; font-weight: bold;">ลายเซ็นผู้ดูแลเงินสด</div>
                                    <div style="margin-bottom: 20px; font-size: 10pt;">Cash Custodian Signature</div>
                                    <div>วันที่ / Date: _______________</div>
                                </div>
                            </div>
                        </div>`;

                    document.body.appendChild(pdfContent);

                    // Generate PDF
                    const canvas = await html2canvas(pdfContent, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: 'white',
                        width: pdfContent.offsetWidth,
                        height: pdfContent.offsetHeight
                    });

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add first page
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // Add additional pages if needed
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Clean up
                    document.body.removeChild(pdfContent);

                    // Download PDF
                    const departmentName = getVal('department').replace(/[^a-zA-Z0-9ก-๙\s]/g, '').replace(/\s+/g, '_').substring(0, 50);
                    const dateStr = getVal('count-date') || new Date().toISOString().substring(0, 10);
                    const fileName = `Cash-Control_${departmentName}_${dateStr}.pdf`;
                    pdf.save(fileName);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('เกิดข้อผิดพลาดในการสร้าง PDF: ' + error.message);
                } finally {
                    // Restore button
                    const button = document.getElementById('export-pdf-btn');
                    if (button) {
                        button.innerHTML = `
                            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            Export เป็น PDF
                        `;
                        button.disabled = false;
                    }
                }
            };
            
            function exportToCSV() {
                // This function remains the same
                const csvRows = [];
                const escapeCsv = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;
                const getVal = (id) => document.getElementById(id).value;
                const getTxt = (id) => document.getElementById(id).textContent;
                
                csvRows.push("ข้อมูลการตรวจนับ");
                csvRows.push(`สาขา/แผนก,${escapeCsv(getVal('department'))}`);
                csvRows.push(`ผู้ดูแลเงิน,${escapeCsv(getVal('custodian'))}`);
                csvRows.push(`วันที่ตรวจนับ,${getVal('count-date')}`);
                csvRows.push("");
                csvRows.push("สรุปผลกระทบยอด");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`เงินที่นับได้ทั้งหมด (A),${escapeCsv(getTxt('total-assets-counted'))}`);
                csvRows.push(`ยอดเงินที่ควรจะมีทั้งหมด (B),${escapeCsv(getTxt('expected-balance'))}`);
                csvRows.push(`ผลต่างรวม (A-B),${escapeCsv(getTxt('difference'))}`);
                csvRows.push(`สถานะ,${escapeCsv(getTxt('difference-label'))}`);
                csvRows.push("");
                csvRows.push("รายละเอียดเงินที่นับได้");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`รวมเงินสดย่อยทั้งหมด (ในมือ+ในบัญชี),${escapeCsv(getTxt('total-petty-cash'))}`);
                csvRows.push(`เงินทอนที่นับได้,${escapeCsv(getVal('change-fund-counted'))}`);
                csvRows.push(`เงินสดจากยอดขายวันก่อน,${escapeCsv(getVal('prev-sales-counted'))}`);
                csvRows.push(`เงินสดจากยอดขายวันนี้,${escapeCsv(getVal('today-sales-counted'))}`);
                csvRows.push("");
                csvRows.push("รายละเอียดเงินตามระบบ");
                csvRows.push("รายการ,จำนวนเงิน");
                csvRows.push(`วงเงินสดย่อยอนุมัติ,${escapeCsv(getVal('approved-petty-cash'))}`);
                csvRows.push(`วงเงินทอนอนุมัติ,${escapeCsv(getVal('approved-change-fund'))}`);
                csvRows.push(`ยอดขายวันก่อน (ตามรายงาน),${escapeCsv(getVal('prev-sales-system'))}`);
                csvRows.push(`ยอดขายวันนี้ (ตามรายงาน),${escapeCsv(getVal('today-sales-system'))}`);
                csvRows.push("");
                csvRows.push("รายการเอกสารจ่ายรอเบิก");
                csvRows.push("รายละเอียด,จำนวนเงิน,มีรูปแนบ");
                document.querySelectorAll('#voucher-list .dynamic-row').forEach(row => {
                    const desc = row.querySelector('input[type="text"]').value;
                    const amount = row.querySelector('input[type="number"]').value;
                    const hasAttachment = attachments[row.id] ? 'Y' : 'N';
                    if(desc || amount) csvRows.push(`${escapeCsv(desc)},${escapeCsv(amount)},${hasAttachment}`);
                });
                csvRows.push(`รวม,${escapeCsv(getTxt('total-vouchers'))}`);
                csvRows.push("");
                csvRows.push("รายการรอโอนเงินคืน");
                csvRows.push("รายละเอียด,จำนวนเงิน,มีรูปแนบ");
                document.querySelectorAll('#reimbursement-list .dynamic-row').forEach(row => {
                    const desc = row.querySelector('input[type="text"]').value;
                    const amount = row.querySelector('input[type="number"]').value;
                    const hasAttachment = attachments[row.id] ? 'Y' : 'N';
                    if(desc || amount) csvRows.push(`${escapeCsv(desc)},${escapeCsv(amount)},${hasAttachment}`);
                });
                csvRows.push(`รวม,${escapeCsv(getTxt('total-reimbursements'))}`);

                const csvContent = "\uFEFF" + csvRows.join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    const dateStr = getVal('count-date');
                    const department = getVal('department');
                    const safeDept = department.replace(/[^a-zA-Z0-9ก-๙ _-]/g, '').replace(/\s+/g, '_');
                    link.setAttribute("href", url);
                    link.setAttribute("download", `cash_count_report_${dateStr}_${safeDept}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // --- EVENT LISTENERS ---
            document.body.addEventListener('input', (e) => { if (e.target.matches('input')) calculateAll(); });
            document.getElementById('reset-btn').addEventListener('click', () => { 
                if (confirm('คุณต้องการล้างข้อมูลทั้งหมด?')) {
                    window.location.reload();
                }
            });
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('export-json-btn').addEventListener('click', exportToJSON); // New listener
            calculateAll();
        });

        // Initialize user display when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                await SPViAuth.initializeFirebase();
                
                // Check authentication - redirect to login if not authenticated
                const isAuthenticated = await SPViAuth.checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = '../index.html';
                    return;
                }
                
                // User info will be added automatically by firebase-auth.js init()
                // No need to call addUserInfo() manually
                
                // Setup centralized devtools protection
                SPViAuth.setupDevToolsProtection();

                // Check tool access permission after authentication is confirmed
                if (window.SPViSessionManager && window.SPViSessionManager.checkToolAccess) {
                    const hasAccess = await window.SPViSessionManager.checkToolAccess('cashControl');
                    if (!hasAccess) {
                        // Access denied - modal will be shown by checkToolAccess function
                        // Optionally hide main content
                        document.querySelector('main')?.style.setProperty('display', 'none');
                    }
                }
            } catch (error) {
                // Authentication error handled silently for production
                // If authentication fails, redirect to login
                window.location.href = '../index.html';
            }
        });
    </script>
</body>
</html>
