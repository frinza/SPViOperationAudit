<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจนับสินค้าสาขา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
    <!-- OCR Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        .scanner-tab-button {
             padding: 8px 16px;
             border-radius: 8px;
             cursor: pointer;
             background-color: #e5e7eb;
             color: #374151;
             transition: all 0.2s;
        }
        .scanner-tab-button.active {
             background-color: #3b82f6;
             color: white;
             font-weight: 600;
        }
        .table-container { max-height: 60vh; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #a0aec0 #e2e8f0; }
        .table-container::-webkit-scrollbar { width: 6px; }
        .table-container::-webkit-scrollbar-track { background: #e2e8f0; }
        .table-container::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 6px; border: 3px solid #e2e8f0; }
        th { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; cursor: pointer; user-select: none; }
        th .sort-indicator { display: inline-block; margin-left: 5px; opacity: 0.5; font-size: 0.9em; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 999; display: flex; justify-content: center; align-items: center; }
        #save-status { transition: opacity 0.5s ease-in-out; }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .scanner-viewport {
            position: relative;
            width: 100%; max-width: 350px; aspect-ratio: 16/9; 
            background-color: #000;
            overflow: hidden;
        }
        .scanner-viewport video, .scanner-viewport canvas {
            width: 100%;
            height: 100%;
        }
        .scan-box {
            position: absolute;
            top: 35%;
            left: 5%;
            width: 90%;
            height: 30%;
            border-top: 2px solid rgba(239, 68, 68, 0.9);
            border-bottom: 2px solid rgba(239, 68, 68, 0.9);
            pointer-events: none;
            z-index: 10;
        }
        .barcode-line {
             position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(239, 68, 68, 0.7); /* red-500 */
            transform: translateY(-50%);
            z-index: 10;
            pointer-events: none;
        }
        /* Print Styles */
        @media print {
            body {
                font-size: 10pt;
                background: #fff !important;
                color: #000 !important;
            }
            .container, .max-w-4xl, .mx-auto, .p-4, .md\:p-8 {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
            }
            .table-container {
                max-height: none !important;
                overflow: visible !important;
            }
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            th, td {
                border: 1px solid #888 !important;
                padding: 4px 8px !important;
                background: #fff !important;
                color: #000 !important;
            }
            th {
                background: #f1f5f9 !important;
                font-weight: bold !important;
            }
            .bg-white, .bg-slate-50, .bg-slate-100, .bg-slate-200, .bg-blue-100, .bg-green-100, .bg-red-100, .bg-amber-50 {
                background: #fff !important;
            }
            .rounded-2xl, .rounded-lg, .rounded {
                border-radius: 0 !important;
            }
            .shadow-lg, .shadow-sm, .shadow-xl {
                box-shadow: none !important;
            }
            .border, .border-slate-200, .border-blue-200, .border-amber-200, .border-amber-300 {
                border-color: #888 !important;
            }
            .text-slate-500, .text-slate-600, .text-slate-700, .text-slate-800, .text-slate-900,
            .text-blue-600, .text-green-600, .text-red-600, .text-amber-800 {
                color: #000 !important;
            }
            .font-bold, .font-semibold {
                font-weight: bold !important;
            }
            .no-print, #loader-overlay, #modal-container, #camera-view-box, #file-ops-container, #upload-container, #workspace-container > nav, #main-tab-demo, #main-tab-workflow, #openScannerBtn, #closeScannerBtn, #barcode-scanner-tab, #text-scanner-tab, #scanner-results, #print-final-report-btn, #exportCsvButton, #exportJsonButton, #refreshChartsButton, #exportDemoCsvButton, #newJobButton {
                display: none !important;
            }
            canvas {
                max-width: 100% !important;
                height: auto !important;
                display: block !important;
                page-break-inside: avoid !important;
            }
            h1, h2, h3, h4, h5 {
                page-break-after: avoid;
            }
            .page-break {
                page-break-before: always;
            }
            input, button, select, textarea {
                display: none !important;
            }
            th {
                position: static !important;
                top: auto !important;
                background-color: #f1f5f9 !important;
                z-index: auto !important;
                box-shadow: none !important;
            }
            .print-legal-section { display: block !important; page-break-before: always; }
        }
        @media screen {
            .print-legal-section { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <button 
        onclick="window.location.href='../index.html'"
        class="no-print bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded mb-4 mt-6 mx-8"
    >
        &larr; กลับหน้าหลัก
    </button>
    <div class="max-w-4xl mx-auto">

    <!-- Loading Overlay -->
    <div id="loader-overlay" class="overlay hidden no-print">
        <div class="flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p id="loader-message" class="text-slate-600 font-medium">กำลังประมวลผล...</p>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-[1000] hidden no-print">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-1/2 text-center transform transition-all scale-95 opacity-0" id="modal-box">
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-3">Notice</h3>
            <div id="modal-message" class="text-slate-600 mb-6 text-left"></div>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2.5 px-8 rounded-lg hover:bg-gray-400 transition-colors shadow-sm hidden">Cancel</button>
                <button id="modal-confirm-btn" class="bg-blue-600 text-white font-bold py-2.5 px-8 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">OK</button>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center relative no-print">
            <div class="absolute top-0 left-0">
                 <div id="save-status" class="text-sm text-slate-500 opacity-0 text-left"></div>
            </div>
            <h1 class="text-4xl font-bold text-slate-900">ตรวจนับสินค้าสาขา</h1>
            <div class="flex items-center justify-center mt-2 gap-4">
                <p class="text-slate-500">เครื่องมือช่วยตรวจนับและกระทบยอดสต็อก</p>
                <button id="newJobButton" class="bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 transition-colors shadow-sm text-xs">
                    New Job
                </button>
            </div>
        </header>

        <div id="info-box-container" class="hidden bg-sky-100 border border-sky-300 text-sky-800 px-4 py-3 rounded-lg relative mb-8 text-sm" role="alert">
            <div class="flex justify-between items-center flex-col md:flex-row gap-2">
                <div>
                    <strong class="font-bold">Branch:</strong>
                    <span id="info-branch-name" class="ml-2 font-mono"></span>
                </div>
                <div>
                    <strong class="font-bold">Count Date:</strong>
                    <span id="info-count-date" class="ml-2 font-mono"></span>
                </div>
            </div>
        </div>

        <div id="file-ops-container" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row items-center justify-center gap-4 no-print">
            <label for="load-progress-file" class="flex-1 w-full bg-blue-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm text-center cursor-pointer">Load Progress from File</label>
            <input type="file" id="load-progress-file" class="hidden" accept=".json">
            <button id="save-progress-button" class="flex-1 w-full bg-green-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-700 transition-colors shadow-sm">Save Progress to File</button>
        </div>

        <div id="upload-container" class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200 mb-8 no-print">
             <h2 class="text-2xl font-semibold mb-2 text-slate-800">ขั้นตอนที่ 1: อัปโหลดไฟล์ SOH</h2>
            <p class="mb-6 text-slate-500">อัปโหลดไฟล์ Stock on Hand (.xlsx หรือ .csv).</p>
            <label for="initialSohFile" class="custom-file-input w-full rounded-xl flex flex-col items-center justify-center text-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-slate-400 mb-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
                <span class="font-medium text-slate-600">คลิกเพื่อเลือกไฟล์ SOH</span>
                <span id="initialSohFileName" class="text-sm text-slate-500 mt-1">(.xlsx, .csv)</span>
            </label>
            <input type="file" id="initialSohFile" class="hidden" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
        </div>

        <div id="workspace-container" class="hidden no-print">
            <div class="mb-6 border-b border-slate-200">
                <nav class="-mb-px flex space-x-6">
                    <button id="main-tab-demo" class="tab-button text-lg font-semibold py-4 px-1 active">ตรวจนับสินค้า DEMO</button>
                    <button id="main-tab-workflow" class="tab-button text-lg font-semibold py-4 px-1 text-slate-500 hover:text-slate-700">ตรวจนับสินค้าขาย</button>
                </nav>
            </div>
            <div>
                <div id="main-panel-demo">
                     <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                         <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-4">
                             <h3 class="text-xl font-semibold text-slate-800">รายการตรวจนับสินค้า DEMO</h3>
                             <div id="demo-summary" class="flex flex-col gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200 text-xs"></div>
                         </div>
                         <div class="flex flex-col md:flex-row gap-4 my-4">
                             <div class="relative flex-grow">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                 <input type="text" id="demoSearchInput" placeholder="ค้นหาด้วย SKU หรือ Description..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                             </div>
                             <select id="demoFilterSelect" class="w-full md:w-auto p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <option value="all">แสดงทั้งหมด</option>
                                 <option value="uncounted">แสดงรายการที่ยังไม่ได้นับ</option>
                                 <option value="discrepancy">แสดงรายการที่ผลต่างไม่เท่ากับ 0</option>
                                 <option value="matched">แสดงรายการที่นับตรง</option>
                             </select>
                         </div>
                         <div id="demo-count-container" class="table-container border rounded-lg"></div>
                         <div id="camera-view-box" class="my-4 hidden">
                             <div class="bg-white border border-blue-200 rounded-lg p-4 flex flex-col items-center">
                                <div class="flex gap-4 mb-4">
                                    <button id="barcode-scanner-tab" class="scanner-tab-button active">Barcode Scanner</button>
                                    <button id="text-scanner-tab" class="scanner-tab-button">Text Scanner</button>
                                </div>
                                <div id="barcode-scanner-view" class="scanner-viewport">
                                     <div id="qr-reader"></div>
                                     <div class="barcode-line"></div>
                                </div>
                                <div id="text-scanner-view" class="hidden scanner-viewport">
                                    <video id="text-scanner-video" playsinline></video>
                                    <div class="scan-box"></div>
                                    <button id="capture-btn" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-rose-500 text-white font-bold py-2 px-4 rounded-lg z-20">ถ่ายภาพและสแกน</button>
                                </div>
                                <div id="scanner-results" class="mt-4 p-3 w-full max-w-sm bg-slate-50 border border-slate-200 rounded-lg text-center"></div>
                                <button id="closeScannerBtn" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-4 rounded">ปิดกล้อง</button>
                             </div>
                         </div>
                         <button id="exportDemoCsvButton" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition-colors shadow-sm text-sm mt-2">
                             Export DEMO Table as CSV
                         </button>
                         <button id="openScannerBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm text-sm mt-2">
                             Scan
                         </button>
                     </div>
                </div>
                <div id="main-panel-workflow" class="hidden">
                     <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                         <h2 class="text-2xl font-semibold mb-2 text-slate-800">ตรวจนับสินค้าขาย</h2>
                         <div id="wf-step-tabs" class="mb-4 border-b border-slate-200">
                             <nav class="flex -mb-px space-x-6">
                                 <button id="wf-tab-btn-1" class="tab-button active text-base font-semibold px-1 py-4">ขั้นตอนที่ 1: สร้างไฟล์</button>
                                 <button id="wf-tab-btn-2" class="tab-button text-base font-semibold px-1 py-4 text-slate-500 hover:text-slate-700">ขั้นตอนที่ 2: กระทบยอด</button>
                                 <button id="wf-tab-btn-3" class="tab-button text-base font-semibold px-1 py-4 text-slate-500 hover:text-slate-700">ขั้นตอนที่ 3: สรุปผล</button>
                             </nav>
                         </div>
                         <div id="wf-step1" class="workflow-step">
                             <h3 class="text-lg font-semibold text-slate-700">สร้าง Master File</h3>
                             <p class="text-slate-500 mb-4">ดาวน์โหลดไฟล์สำหรับสแกน (เฉพาะสินค้าขาย)</p>
                             <button id="downloadMasterForScan" class="inline-flex items-center gap-2 bg-blue-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                 ดาวน์โหลด Master.csv
                             </button>
                         </div>
                         <div id="wf-step2" class="workflow-step hidden">
                             <h3 class="text-lg font-semibold text-slate-700">กระทบยอดรอบที่ 1</h3>
                             <p class="text-slate-500 mb-4">อัปโหลด Logfile จากสแกนเนอร์ (ข้อมูล DEMO จะถูกรวมอัตโนมัติ)</p>
                             <div>
                                 <label for="firstScanLogfile" class="block mb-2 font-medium text-slate-700">Logfile (จากสแกนเนอร์)</label>
                                 <input type="file" id="firstScanLogfile" accept=".csv" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100 border border-slate-300 rounded-lg" />
                             </div>
                             <button id="processFirstCount" class="inline-flex items-center gap-2 mt-4 bg-violet-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-violet-700 transition-colors shadow-sm disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                 ประมวลผลต่าง
                             </button>
                             <div id="step2-results" class="hidden mt-6">
                                 <h4 class="font-semibold text-slate-700 mb-4">สรุปผลการนับรอบที่ 1:</h4>
                                 <div id="netdiff-summary-container"></div>
                             </div>
                         </div>
                         <div id="wf-step3" class="workflow-step hidden">
                             <h3 class="text-lg font-semibold text-slate-700">สรุปผลและดำเนินการต่อ</h3>
                             <p class="text-slate-500 mb-4">สรุปผลทันที หรือนับซ้ำรายการที่ไม่ได้ตรวจนับ</p>
                             <button id="finalizeFromFirstCount" class="w-full inline-flex items-center justify-center gap-2 bg-teal-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-teal-700 transition-colors shadow-sm disabled:bg-slate-400 disabled:cursor-not-allowed">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                 </svg>
                                 แสดงรายงานสรุป (จากยอดนับรอบที่ 1)
                             </button>
                             <div class="mt-6 pt-6 border-t border-slate-200">
                                 <h4 class="text-md font-semibold text-slate-600">หรือ (Optional) ทำการนับซ้ำ</h4>
                                 <p class="text-slate-500 mb-4 text-sm">
                                     หากมีการขายสินค้าระหว่างการนับ ให้อัปเดต SOH ล่าสุดก่อนสร้างไฟล์นับซ้ำ เพื่อความแม่นยำ
                                 </p>

                                 <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg mb-4">
                                     <label for="latestSohFile" class="block mb-2 text-sm font-medium text-amber-800">1. อัปเดต SOH ล่าสุด (ถ้ามี)</label>
                                     <input type="file" id="latestSohFile" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-800 hover:file:bg-amber-200 border border-amber-300 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled />
                                     <span id="latestSohFileName" class="text-xs text-slate-500 mt-1"></span>
                                 </div>
                                 
                                 <h5 class="text-sm font-medium text-slate-700 mt-4 mb-2">2. สร้างไฟล์และดำเนินการนับซ้ำ</h5>
                                 <button id="generateRecountMasterFile" class="inline-flex items-center gap-2 mb-4 bg-green-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-green-700 transition-colors shadow-sm text-sm disabled:bg-slate-400 disabled:cursor-not-allowed">
                                     สร้าง Master File สำหรับนับซ้ำ
                                 </button>
                                 <div>
                                     <label for="secondScanLogfile" class="block mb-2 text-sm font-medium text-slate-700">อัปโหลด Logfile จากการนับซ้ำ</label>
                                     <input type="file" id="secondScanLogfile" accept=".csv" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100 border border-slate-300 rounded-lg" />
                                 </div>
                                 <button id="processSecondCount" class="inline-flex items-center gap-2 mt-4 bg-sky-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-sky-700 transition-colors shadow-sm disabled:bg-slate-400 disabled:cursor-not-allowed">
                                     ประมวลผลยอดนับซ้ำ
                                 </button>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- Final Report Container (at root level, hidden initially) -->
        <div id="final-report-container" class="mt-8 hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                <div class="space-y-8">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold text-slate-800">Dashboard สรุปผล</h3>
                            <div class="flex items-center gap-2 no-print">
                                <button id="refreshChartsButton" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors shadow-sm text-sm flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8m0 0V3m0 5h-5" />
                                    </svg>
                                    Refresh Chart
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 flex flex-col">
                                <h4 class="text-sm font-semibold text-center mb-2 text-slate-600 flex-shrink-0">ผลต่าง (มูลค่า)</h4>
                                <div class="relative h-64">
                                    <canvas id="costChart"></canvas>
                                </div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 flex flex-col">
                                <h4 class="text-sm font-semibold text-center mb-2 text-slate-600 flex-shrink-0">ผลต่าง (จำนวน)</h4>
                                <div class="relative h-64">
                                    <canvas id="qtyChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 flex flex-col">
                            <h4 class="text-sm font-semibold text-center mb-2 text-slate-600 flex-shrink-0">ผลต่างแยกตามหมวดหมู่ (จำนวน)</h4>
                            <div class="relative h-80">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        <div id="final-summary" class="flex flex-col gap-2 p-4 bg-slate-100 rounded-lg border border-slate-200 text-sm"></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-slate-800">รายการสรุปผลทั้งหมด</h3>
                        <div class="flex flex-col md:flex-row gap-4 no-print">
                            <div class="relative flex-grow">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                <input type="text" id="finalSearchInput" placeholder="ค้นหารายงาน..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <select id="finalFilterSelect" class="w-full md:w-auto p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">แสดงทั้งหมด</option>
                                <option value="discrepancy">เฉพาะรายการที่ผลต่างไม่เท่ากับ 0</option>
                                <option value="demo">เฉพาะสินค้า DEMO</option>
                                <option value="normal">เฉพาะสินค้าปกติ</option>
                            </select>
                        </div>
                        <div id="final-report-table-container" class="table-container border border-slate-200 rounded-lg"></div>
                        <div class="mt-4 flex flex-col sm:flex-row gap-4 no-print">
                            <button id="print-final-report-btn" class="flex-1 inline-flex items-center justify-center gap-2 bg-gray-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-gray-700 transition-colors shadow-sm">
                                <!-- Printer icon (Heroicons) -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 9V4a1 1 0 011-1h10a1 1 0 011 1v5M6 18v2a1 1 0 001 1h10a1 1 0 001-1v-2M6 14h12a2 2 0 002-2V9a2 2 0 00-2-2H6a2 2 0 00-2 2v3a2 2 0 002 2z" />
                                </svg>
                                พิมพ์รายงาน
                            </button>
                            <button id="exportCsvButton" class="flex-1 inline-flex items-center justify-center gap-2 bg-emerald-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Export CSV
                            </button>
                            <button id="exportJsonButton" class="flex-1 inline-flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-2.5 px-5 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">
                                <!-- Curly braces icon for JSON -->
                                <span class="text-lg font-bold">{ }</span>
                                Export JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legal Declaration and Signature Section (print only) -->
        <div class="print-legal-section" style="display:none;">
            <div style="border: 1.5px solid #222; border-radius: 0.5rem; background: #f7f7f7; color: #222; font-size: 11pt; margin: 2rem 0 1.5rem 0; padding: 1.2rem 1rem; text-align: center;">
                ข้าพเจ้าขอรับรองว่าข้อมูลในรายงานนี้ถูกต้องตามที่ตรวจสอบและเป็นความจริงทุกประการ<br>
                <span style="font-size:10pt; color:#444;">
                    (I hereby certify that the information in this report is accurate and true to the best of my knowledge.)
                </span>
            </div>
            <div style="max-width:600px; margin:2.5rem auto 0 auto; padding-top:2rem; border-top:2px dashed #222; font-size:11pt;">
                <div style="display:flex; justify-content:space-between; gap:3rem;">
                    <div style="text-align:center; flex:1;">
                        <div style="height:2.5rem;"></div>
                        <p style="margin-bottom:0.5rem;">ลงชื่อ .................................................</p>
                        <p>(ผู้ตรวจสอบ / Auditor)</p>
                        <p style="margin-top:1.5rem;">วันที่: ........ / ................ / ............</p>
                    </div>
                    <div style="text-align:center; flex:1;">
                        <div style="height:2.5rem;"></div>
                        <p style="margin-bottom:0.5rem;">ลงชื่อ .................................................</p>
                        <p>(ผู้รับการตรวจสอบ / Auditee)</p>
                        <p style="margin-top:1.5rem;">วันที่: ........ / ................ / ............</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let cvReady = false;
        function onOpenCvReady() {
            cvReady = true;
            const textScannerTab = document.getElementById('text-scanner-tab');
            const cameraViewBox = document.getElementById('camera-view-box');
            const textScannerView = document.getElementById('text-scanner-view');
            const textScannerVideo = document.getElementById('text-scanner-video');
            if (
                textScannerTab && textScannerTab.classList.contains('active') &&
                cameraViewBox && !cameraViewBox.classList.contains('hidden')
            ) {
                // If video is not playing, start it
                if (textScannerView && !textScannerView.classList.contains('hidden')) {
                    if (textScannerVideo && textScannerVideo.srcObject == null) {
                        if (typeof startTextScanner === 'function') startTextScanner();
                    }
                }
                if (typeof stopOcrStreaming === 'function') stopOcrStreaming();
                if (typeof startOcrStreaming === 'function') startOcrStreaming();
                const scannerResultsEl = document.getElementById('scanner-results');
                if (scannerResultsEl) {
                    scannerResultsEl.innerHTML = `<p class="text-green-600">OpenCV is ready. Scanner refreshed.</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);
            
            let hasUnsavedChanges = false;
            let state = getInitialState();
            let finalSummaryData = {};
            let activeStream = null;
            let ocrStreaming = false;
            let ocrStreamInterval = null;

            function getInitialState() {
                return {
                    sohData: [], sohLookup: {}, scannerMaster: [], demoMaster: [],
                    demoCounts: {}, demoSort: { column: 'SKU', direction: 'asc' },
                    netDiffData: [], reconciledData: [], finalReportSort: { column: 'SKU', direction: 'asc' },
                    charts: { cost: null, qty: null, category: null },
                    branchName: null, countDate: null,
                };
            }
            
            const formatNumber = (num) => (num ?? 0).toLocaleString('en-US');

            function showLoader(message = "Processing...") { 
                getEl('loader-message').textContent = message;
                getEl('loader-overlay').classList.remove('hidden'); 
            }
            function hideLoader() { getEl('loader-overlay').classList.add('hidden'); }
            
            function showModal(title, message, options = {}) {
                getEl('modal-title').textContent = title;
                getEl('modal-message').innerHTML = message;
                const confirmBtn = getEl('modal-confirm-btn');
                const cancelBtn = getEl('modal-cancel-btn');
                confirmBtn.textContent = options.confirmText || 'OK';
                confirmBtn.onclick = () => { hideModal(); if (options.onConfirm) options.onConfirm(); };
                cancelBtn.classList.toggle('hidden', !options.onCancel);
                if (options.onCancel) {
                    cancelBtn.textContent = options.cancelText || 'Cancel';
                    cancelBtn.onclick = () => { hideModal(); options.onCancel(); };
                }
                getEl('modal-container').classList.remove('hidden');
                setTimeout(() => getEl('modal-box').classList.add('scale-100', 'opacity-100'), 10);
            }

            function hideModal() {
                getEl('modal-box').classList.add('scale-95', 'opacity-0');
                setTimeout(() => getEl('modal-container').classList.add('hidden'), 200);
            }

            let saveStatusTimeout;
            function showSaveStatus(message, isWarning) {
                const statusEl = getEl('save-status');
                clearTimeout(saveStatusTimeout);
                statusEl.textContent = message;
                statusEl.className = `text-left text-sm font-semibold opacity-100 ${isWarning ? 'text-red-600' : 'text-green-600'}`;
                if (!isWarning) {
                    saveStatusTimeout = setTimeout(() => statusEl.classList.add('opacity-0'), 3000);
                }
            }
            
            function updateInfoBox() {
                if (state.branchName) {
                    getEl('info-branch-name').textContent = state.branchName;
                    getEl('info-count-date').textContent = state.countDate;
                    getEl('info-box-container').classList.remove('hidden');
                } else {
                    getEl('info-box-container').classList.add('hidden');
                }
            }

            function resetAppState() {
                Object.values(state.charts).forEach(chart => chart?.destroy());
                state = getInitialState();
                hasUnsavedChanges = false;
            }

            function resetUI() {
                getEl('workspace-container').classList.add('hidden');
                getEl('final-report-container').classList.add('hidden');
                getEl('upload-container').classList.remove('hidden');
                ['initialSohFile', 'firstScanLogfile', 'secondScanLogfile', 'latestSohFile'].forEach(id => getEl(id).value = '');
                getEl('initialSohFileName').textContent = '(.xlsx, .csv)';
                getEl('latestSohFileName').textContent = '';
                getEl('info-box-container').classList.add('hidden');
            }
            
            function setUnsavedChanges(status){
                hasUnsavedChanges = status;
                if (status) {
                    showSaveStatus("Unsaved changes", true);
                }
            }
            
            function startNewJob() {
                showModal('Start New Job?', 'Are you sure? All unsaved progress will be lost.', {
                    confirmText: 'Yes, Start New Job',
                    onConfirm: () => {
                        resetAppState();
                        resetUI();
                        getEl('save-status').classList.add('opacity-0');
                    },
                    onCancel: ()=> {},
                    cancelText: 'Cancel'
                });
            }

            async function handleSohFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                getEl('initialSohFileName').textContent = file.name;
                showLoader();
                try {
                    resetAppState();
                    const data = await parseExcelFile(file);
                    if (!data?.length) throw new Error("File is empty or invalid.");
                    if (!data[0]?.BRANCH_NAME) throw new Error("'BRANCH_NAME' column is missing.");
                    state.branchName = data[0].BRANCH_NAME;
                    state.countDate = new Date().toLocaleDateString('en-CA');
                    const { forScan, forDemo, lookup } = processAndSeparateSoh(data);
                    if (Object.keys(lookup).length === 0) throw new Error("No valid stock items found. Check SKU/AVAILABLE_QTY columns.");
                    state.sohData = data;
                    state.sohLookup = lookup;
                    state.scannerMaster = forScan;
                    state.demoMaster = forDemo.map(item => ({ ...item, counted: null, reason: 'Manual' }));
                    rebuildUiFromState();
                    setUnsavedChanges(true); 
                } catch (error) {
                    showModal("Error Processing File", error.message);
                    resetAppState();
                    resetUI();
                } finally {
                    hideLoader();
                }
            }

            function handleSaveProgressToFile() {
                if (!state.sohData.length) {
                    return showModal("Info", "There is no progress to save.");
                }
                const stateToSave = { ...state, charts: {} };
                const blob = new Blob([JSON.stringify(stateToSave, null, 2)], { type: 'application/json' });
                const fileName = `stock_count_${state.branchName.replace(/\s+/g, '_')}_${state.countDate}.json`;
                downloadFile(blob, fileName);
                hasUnsavedChanges = false;
                showSaveStatus("Progress saved to file", false);
            }

            function handleLoadProgressFromFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedState = JSON.parse(event.target.result);
                        if (!loadedState?.sohData?.length) throw new Error("Invalid or empty progress file.");
                        restoreState(loadedState);
                        showModal("Success", "Progress has been loaded.");
                    } catch(err) {
                        showModal("Error", "Could not parse the selected file. Please ensure it's a valid progress file.");
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            }
            
            function parseExcelFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]));
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function processAndSeparateSoh(sohData) {
                const forScan = [], forDemo = [], lookup = {};
                const targetWhCode = sohData.find(row => row.WH_CODE)?.WH_CODE;
                if (!targetWhCode) throw new Error("Could not determine warehouse code (WH_CODE).");
                sohData.filter(row => row.WH_CODE === targetWhCode).forEach(row => {
                    const isSerial = !!row.SERIAL_NO;
                    const sku = String(isSerial ? row.SERIAL_NO : row.SKU || '').replace(/\./g, ' ').trim().toUpperCase();
                    if (!sku) return;
                    const isSerialControlled = row.SERIAL_CONTROL === 'Y' || isSerial;
                    const qty = parseInt(String(row.AVAILABLE_QTY ?? 0).replace(/,/g, ''), 10);
                    const srp = parseFloat(String(row.SRP_AMT_INC_VAT ?? 0).replace(/,/g, ''));
                    if (lookup[sku] && !isSerialControlled) {
                        const existing = lookup[sku];
                        const newTotalQty = existing.SOH + qty;
                        const newTotalSrpValue = (existing.SOH * existing.Price) + (qty * srp);
                        existing.SOH = newTotalQty;
                        existing.Price = newTotalQty > 0 ? newTotalSrpValue / newTotalQty : 0;
                    } else if (!lookup[sku]) {
                        lookup[sku] = {
                            SKU: sku, Description: (row.DESCRIPTION || '').replace(/,/g, ' '),
                            SOH: qty, Price: srp, Age: row.AGE,
                            CLASS_NAME: row.CLASS_NAME || 'UNCATEGORIZED',
                            isSerialControlled, isDemo: (row.DESCRIPTION || '').toUpperCase().includes('DEMO'),
                        };
                    }
                });
                Object.values(lookup).forEach(item => {
                    if (item.SOH > 0) (item.isDemo ? forDemo : forScan).push(item);
                });
                return { forScan, forDemo, lookup };
            }

            function restoreState(loadedState) {
                resetAppState();
                state = { ...state, ...loadedState, charts: getInitialState().charts };
                const { forScan, forDemo, lookup } = processAndSeparateSoh(state.sohData);
                state.sohLookup = lookup;
                state.scannerMaster = forScan;
                state.demoMaster = forDemo.map(item => ({ 
                    ...item, 
                    counted: state.demoCounts[item.SKU]?.qty ?? null,
                    reason: state.demoCounts[item.SKU]?.reason ?? 'Manual' 
                }));
                rebuildUiFromState();
            }

            function downloadFile(content, fileName) {
                const blob = (typeof content === 'string') ? new Blob([content], { type: 'text/csv;charset=utf-8;' }) : content;
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function rebuildUiFromState() {
                if (state.sohData.length > 0) {
                    getEl('workspace-container').classList.remove('hidden');
                    getEl('upload-container').classList.add('hidden');
                    getEl('downloadMasterForScan').disabled = false;
                    updateInfoBox();
                    applyDemoView();
                    if (state.netDiffData.length > 0) {
                        renderFirstCountSummary();
                        getEl('step2-results').classList.remove('hidden');
                        getEl('finalizeFromFirstCount').disabled = false;
                        getEl('generateRecountMasterFile').disabled = false;
                        getEl('latestSohFile').disabled = false;
                    }
                    if (state.reconciledData.length > 0) {
                        applyFinalReportView();
                        renderFinalReportCharts();
                        getEl('final-report-container').classList.remove('hidden');
                    }
                    switchMainTab('demo');
                } else {
                    resetUI();
                }
            }
            
            function switchMainTab(tabName) {
                const isDemo = tabName === 'demo';
                getEl('main-panel-demo').classList.toggle('hidden', !isDemo);
                getEl('main-panel-workflow').classList.toggle('hidden', isDemo);
                getEl('main-tab-demo').classList.toggle('active', isDemo);
                getEl('main-tab-workflow').classList.toggle('active', !isDemo);
            }

            function changeWorkflowTab(tabIndex) {
                document.querySelectorAll('.workflow-step').forEach(div => div.classList.add('hidden'));
                getEl(`wf-step${tabIndex}`).classList.remove('hidden');
                document.querySelectorAll('#wf-step-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
                getEl(`wf-tab-btn-${tabIndex}`).classList.add('active');
            }

            function handleSort(sortKey, column, applyViewFn) {
                const sortState = state[sortKey];
                if (sortState.column === column) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = column;
                    sortState.direction = 'asc';
                }
                applyViewFn();
                setUnsavedChanges(true);
            }

            function applyDemoView() {
                if (state.demoMaster.length === 0) {
                    getEl('demo-count-container').innerHTML = '<p class="p-6 text-center text-slate-500">No DEMO items found.</p>';
                    updateDemoSummary();
                    return;
                }
                const searchValue = getEl('demoSearchInput').value.toUpperCase();
                const filterValue = getEl('demoFilterSelect').value;
                let dataView = state.demoMaster.filter(item => {
                    if (!(item.SKU.toUpperCase().includes(searchValue) || item.Description.toUpperCase().includes(searchValue))) return false;
                    const diff = (item.counted === null) ? null : item.counted - item.SOH;
                    if (filterValue === 'uncounted') return item.counted === null;
                    if (filterValue === 'discrepancy') return diff !== null && diff !== 0;
                    if (filterValue === 'matched') return diff !== null && diff === 0;
                    return true;
                });
                const { column, direction } = state.demoSort;
                dataView.sort((a, b) => {
                    let valA = a[column]; let valB = b[column];
                    if (valA === null || valA === undefined) return 1;
                    if (valB === null || valB === undefined) return -1;
                    if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    return direction === 'asc' ? valA - valB : valB - valA;
                });
                renderDemoCountTable(dataView);
                updateDemoSummary();
            }

            function renderDemoCountTable(data) {
                const container = getEl('demo-count-container');
                const headers = `<thead><tr><th class="p-3 text-left w-12">Status</th><th class="p-3 text-left" data-sort-by="SKU">SKU<span class="sort-indicator"></span></th><th class="p-3 text-left" data-sort-by="Description">Description<span class="sort-indicator"></span></th><th class="p-3 text-center" data-sort-by="Age">Age<span class="sort-indicator"></span></th><th class="p-3 text-center" data-sort-by="Price">SRP<span class="sort-indicator"></span></th><th class="p-3 text-center" data-sort-by="SOH">SOH<span class="sort-indicator"></span></th><th class="p-3 text-center w-32">Counted Qty</th><th class="p-3 text-center w-24">Diff</th></tr></thead>`;
                const body = data.length > 0 ? data.map(renderDemoTableRow).join('') : `<tr><td colspan="8" class="text-center p-6 text-slate-500">No items match filter.</td></tr>`;
                container.innerHTML = `<table class="w-full text-sm">${headers}<tbody>${body}</tbody></table>`;
                const sortingTh = container.querySelector(`th[data-sort-by="${state.demoSort.column}"]`);
                if (sortingTh) {
                    sortingTh.querySelector('.sort-indicator').textContent = state.demoSort.direction === 'asc' ? '▲' : '▼';
                }
            }

            function renderDemoTableRow(item) {
                const diff = (item.counted === null) ? null : item.counted - item.SOH;
                const diffText = diff === null ? '-' : (diff > 0 ? `+${diff}` : diff);
                let { rowClass, statusDotColor } = getRowVisuals(diff, true);
                return `<tr class="border-b border-slate-200 transition-colors duration-200 ${rowClass}" data-sku="${item.SKU}"><td class="p-3 text-center"><span class="status-dot ${statusDotColor}"></span></td><td class="p-3 font-medium text-slate-700">${item.SKU}</td><td class="p-3 text-slate-600">${item.Description}</td><td class="p-3 text-center text-slate-600">${item.Age || '-'}</td><td class="p-3 text-right text-slate-600">${formatNumber(item.Price)}</td><td class="p-3 text-center text-slate-600">${item.SOH}</td><td class="p-3"><input type="number" value="${item.counted ?? ''}" class="w-full text-center p-1.5 border border-slate-300 rounded-md bg-white"/></td><td class="p-3 text-center font-bold diff-cell">${diffText}</td></tr>`;
            }

            function updateDemoSummary() {
                const totalSOH = state.demoMaster.reduce((sum, item) => sum + item.SOH, 0);
                const countedSKUs = Object.values(state.demoCounts).filter(c => c.qty !== null).length;
                const diffItems = state.demoMaster.filter(item => { const countInfo = state.demoCounts[item.SKU]; return countInfo && countInfo.qty !== null && countInfo.qty !== item.SOH; }).length;
                getEl('demo-summary').innerHTML = `<div class="flex justify-between gap-4"><span>Total DEMO SOH:</span><span class="font-bold">${formatNumber(totalSOH)}</span></div><div class="flex justify-between gap-4"><span>Total DEMO SKUs:</span><span class="font-bold">${formatNumber(state.demoMaster.length)}</span></div><div class="flex justify-between gap-4"><span>Counted SKUs:</span><span class="font-bold text-green-600">${countedSKUs}</span></div><div class="flex justify-between gap-4"><span>Discrepancies:</span><span class="font-bold text-red-600">${diffItems}</span></div>`;
            }

            function updateDemoCount(sku, value) {
                const item = state.demoMaster.find(i => i.SKU === sku);
                if (!item) return;
                const intValue = value === '' ? null : parseInt(value, 10);
                item.counted = isNaN(intValue) ? null : intValue;
                if (intValue === null) delete state.demoCounts[sku];
                else state.demoCounts[sku] = { qty: intValue, reason: 'Manual' };
                if (state.reconciledData.length > 0) {
                    const reportItem = state.reconciledData.find(i => i.SKU === sku);
                    if (reportItem) {
                        reportItem.Recount = intValue ?? 0;
                        reportItem.FinalDiff = reportItem.Recount - reportItem.SOH;
                        reportItem.ReasonFinal = 'Manual';
                        applyFinalReportView();
                        renderFinalReportCharts();
                    }
                }
                const row = getEl('demo-count-container').querySelector(`tr[data-sku="${sku}"]`);
                if (row) {
                    const diff = item.counted === null ? null : item.counted - item.SOH;
                    row.querySelector('.diff-cell').textContent = diff === null ? '-' : (diff > 0 ? `+${diff}` : diff);
                    updateTableRowVisuals(row, diff, true);
                }
                updateDemoSummary();
                setUnsavedChanges(true);
            }
            
            function exportDemoTable() {
                const dataToExport = state.demoMaster.map(item => ({ SKU: item.SKU, Description: item.Description, Age: item.Age, SRP: item.Price, SOH: item.SOH, Counted: item.counted, Diff: item.counted === null ? '' : item.counted - item.SOH }));
                const csv = Papa.unparse(dataToExport, { header: true });
                downloadFile(csv, `DEMO_Count_${state.branchName.replace(/\s+/g, '_')}_${state.countDate}.csv`);
            }

            function downloadMasterForScan() {
                const rowsForCsv = state.scannerMaster.map(item => [item.SKU, item.Description, item.Price, item.Age, item.SOH]);
                downloadFile(Papa.unparse(rowsForCsv, { header: false }), 'Master_for_Scan.csv');
            }
            
            async function processFirstCount() {
                showLoader('Processing First Count...');
                try {
                    const logFiles = getEl('firstScanLogfile').files;
                    if (!state.sohData.length || !logFiles.length) throw new Error("Please upload SOH and Logfile(s).");
                    const scanCounts = await (async function(files){ const p = Array.from(files).map(f => new Promise((res, rej) => { Papa.parse(f, { skipEmptyLines: true, complete: r => { const d = r.data.map(row => { if(!row || row.length < 3 || !row[2]) return null; const sku = String(row[2]).trim(); const qty = parseInt(String(row[4] ?? 1).replace(/,/g,''), 10); return {sku, qty: isNaN(qty) ? 1: qty};}).filter(Boolean); res(d); }, error: rej}); })); return Promise.all(p).then(r => r.flat()); })(logFiles);
                    const processedCounts = {};
                    for(const item of scanCounts){ const {sku, qty} = item; const isSerial = state.sohLookup[sku] ? state.sohLookup[sku].isSerialControlled : false; if(isSerial){ if(!processedCounts[sku]) processedCounts[sku] = {qty: 1, reason: 'Scanned Serial'};} else { const currentQty = processedCounts[sku] ? processedCounts[sku].qty : 0; processedCounts[sku] = {qty: currentQty + qty, reason: 'Scanned SKU'};}}
                    const combinedCounts = { ...processedCounts, ...state.demoCounts };
                    const netDiffMap = new Map(Object.values(state.sohLookup).filter(item => item.SOH > 0).map(item => [item.SKU, { ...item, Scan1: 0, Reason1: '' }]));
                    for (const [sku, data] of Object.entries(combinedCounts)) {
                        const entry = netDiffMap.get(sku);
                        if (entry) { entry.Scan1 = data.qty; entry.Reason1 = data.reason; }
                    }
                    state.netDiffData = Array.from(netDiffMap.values()).map(item => ({ ...item, Diff1: item.Scan1 - item.SOH, Recount: item.Scan1, FinalDiff: item.Scan1 - item.SOH, ReasonFinal: item.Reason1, Remark: '' }));
                    renderFirstCountSummary();
                    getEl('step2-results').classList.remove('hidden');
                    getEl('finalizeFromFirstCount').disabled = false;
                    getEl('generateRecountMasterFile').disabled = false;
                    getEl('latestSohFile').disabled = false;
                    setUnsavedChanges(true);
                    showModal("Success", "First count processed successfully.");
                } catch (error) {
                    showModal("Error", `Processing failed: ${error.message}`);
                } finally {
                    hideLoader();
                }
            }
            
            function renderFirstCountSummary() {
                const summary = state.netDiffData.reduce((acc, item) => { acc.totalSOH += item.SOH; if (item.Scan1 !== 0 || item.Reason1) acc.countedSOH += item.SOH; return acc; }, { totalSOH: 0, countedSOH: 0 });
                const uncountedSOH = summary.totalSOH - summary.countedSOH;
                getEl('netdiff-summary-container').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"><div class="p-4 bg-blue-100 rounded-lg"><p class="font-medium text-blue-800">Total SOH</p><p class="text-3xl font-bold text-blue-600 mt-1">${formatNumber(summary.totalSOH)}</p></div><div class="p-4 bg-green-100 rounded-lg"><p class="font-medium text-green-800">Counted SOH</p><p class="text-3xl font-bold text-green-600 mt-1">${formatNumber(summary.countedSOH)}</p></div><div class="p-4 bg-red-100 rounded-lg"><p class="font-medium text-red-800">Uncounted SOH</p><p class="text-3xl font-bold text-red-600 mt-1">${formatNumber(uncountedSOH)}</p></div></div>`;
            }

            function finalizeFromFirstCount() {
                if (!state.netDiffData.length) return showModal("Warning", "Please process the first count (Step 2).");
                // --- Patch: Sync latest DEMO counts before finalizing ---
                state.netDiffData.forEach(item => {
                    if (item.isDemo) {
                        const demoCount = state.demoCounts[item.SKU];
                        if (demoCount && typeof demoCount.qty === 'number') {
                            item.Recount = demoCount.qty;
                            item.FinalDiff = demoCount.qty - item.SOH;
                            item.ReasonFinal = demoCount.reason || 'Manual';
                        } else {
                            item.Recount = 0;
                            item.FinalDiff = -item.SOH;
                            item.ReasonFinal = 'Not Counted';
                        }
                    }
                });
                state.reconciledData = state.netDiffData.map(item => ({...item}));
                applyFinalReportView();
                renderFinalReportCharts();
                getEl('final-report-container').classList.remove('hidden');
                getEl('final-report-container').scrollIntoView({ behavior: 'smooth' });
                setUnsavedChanges(true);
            }
            
            function generateRecountMasterFile() {
                const itemsToRecount = state.netDiffData.filter(item => item.Diff1 !== 0 && !item.isDemo);
                if (!itemsToRecount.length) return showModal("Info", "No non-DEMO items require a recount.");
                const rowsForCsv = itemsToRecount.map(item => [item.SKU, item.Description, item.Price, item.Age, item.SOH]);
                downloadFile(Papa.unparse(rowsForCsv, { header: false }), 'Master_Recount.csv');
            }

            async function handleLatestSohUpload(e) {
                const file = e.target.files[0]; if (!file) return;
                getEl('latestSohFileName').textContent = file.name;
                showLoader("Updating SOH...");
                try {
                    const latestSohRaw = await parseExcelFile(file);
                    if (!latestSohRaw?.length) throw new Error("Latest SOH file is empty or invalid.");
                    const { lookup: latestSohProcessedLookup } = processAndSeparateSoh(latestSohRaw);
                    if (Object.keys(latestSohProcessedLookup).length === 0) throw new Error("No valid stock items found in the latest SOH file.");
                    let updatedCount = 0;
                    state.netDiffData.forEach(item => {
                        if (latestSohProcessedLookup[item.SKU] !== undefined) {
                            const oldSoh = item.SOH;
                            const newSoh = latestSohProcessedLookup[item.SKU].SOH;
                            if (oldSoh !== newSoh) { item.SOH = newSoh; item.Diff1 = item.Scan1 - item.SOH; updatedCount++; }
                        }
                    });
                    Object.values(state.sohLookup).forEach(item => {
                        if (latestSohProcessedLookup[item.SKU] !== undefined) item.SOH = latestSohProcessedLookup[item.SKU].SOH;
                    });
                    if (state.reconciledData.length > 0) {
                        state.reconciledData.forEach(item => {
                            if (latestSohProcessedLookup[item.SKU] !== undefined) { item.SOH = latestSohProcessedLookup[item.SKU].SOH; item.FinalDiff = item.Recount - item.SOH; }
                        });
                        applyFinalReportView(); renderFinalReportCharts();
                    }
                    showModal("Success", `SOH updated for ${updatedCount} items. You can now generate a new recount file or finalize the report.`);
                    setUnsavedChanges(true);
                } catch (error) { showModal("Error Updating SOH", error.message);
                } finally { hideLoader(); e.target.value = ''; getEl('latestSohFileName').textContent = ''; }
            }
            
            async function processSecondCount() {
                showLoader('Processing Recount...');
                try {
                    const logFiles = getEl('secondScanLogfile').files; if (!logFiles.length) throw new Error("Please upload Logfile(s) for the recount.");
                    const recountCounts = await (async function(files){ const p = Array.from(files).map(f => new Promise((res, rej) => { Papa.parse(f, { skipEmptyLines: true, complete: r => { const d = r.data.map(row => { if(!row || row.length < 3 || !row[2]) return null; const sku = String(row[2]).trim(); const qty = parseInt(String(row[4] ?? 1).replace(/,/g,''), 10); return {sku, qty: isNaN(qty) ? 1: qty};}).filter(Boolean); res(d); }, error: rej}); })); return Promise.all(p).then(r => r.flat()); })(logFiles);
                    state.reconciledData = state.netDiffData.map(item => {
                        const newItem = {...item};
                        if (!newItem.isDemo && newItem.Diff1 !== 0) {
                            if (recountCounts[newItem.SKU] !== undefined) { newItem.Recount = recountCounts[newItem.SKU].qty; newItem.ReasonFinal = 'Recount'; }
                            else { newItem.Recount = 0; newItem.ReasonFinal = 'Not Found on Recount'; }
                        }
                        newItem.FinalDiff = newItem.Recount - newItem.SOH;
                        return newItem;
                    });
                    applyFinalReportView(); renderFinalReportCharts();
                    getEl('final-report-container').classList.remove('hidden');
                    getEl('final-report-container').scrollIntoView({ behavior: 'smooth' });
                    setUnsavedChanges(true);
                    showModal("Success", "Recount processed. Final report is now available.");
                } catch (error) { showModal("Error", "Recount processing failed: " + error.message);
                } finally { hideLoader(); }
            }

            function applyFinalReportView() {
                if (!state.reconciledData.length) return;
                const searchValue = getEl('finalSearchInput').value.toUpperCase();
                const filterValue = getEl('finalFilterSelect').value;
                let dataView = state.reconciledData.filter(item => {
                    if (!(item.SKU.toUpperCase().includes(searchValue) || item.Description.toUpperCase().includes(searchValue))) return false;
                    if (filterValue === 'discrepancy') return item.FinalDiff !== 0;
                    if (filterValue === 'demo') return item.isDemo;
                    if (filterValue === 'normal') return !item.isDemo;
                    return true;
                });
                const { column, direction } = state.finalReportSort;
                dataView.sort((a, b) => {
                    let valA = column === 'FinalDiff' ? Math.abs(a[column]) : a[column];
                    let valB = column === 'FinalDiff' ? Math.abs(b[column]) : b[column];
                    if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    return direction === 'asc' ? valA - valB : valB - valA;
                });
                renderFinalReportTable(dataView);
                updateFinalReportSummary();
            }

            function renderFinalReportTable(data) {
                const container = getEl('final-report-table-container');
                if (!data.length) { container.innerHTML = '<p class="text-center p-10 text-slate-500">No data matches the current filter.</p>'; return; }
                const headers = `<thead><tr><th class="p-3 text-center w-12">Status</th><th class="p-3 text-left" data-sort-by="SKU">SKU<span class="sort-indicator"></span></th><th class="p-3 text-left" data-sort-by="Description">Description<span class="sort-indicator"></span></th><th class="p-3 text-center" data-sort-by="SOH">SOH<span class="sort-indicator"></span></th><th class="p-3 text-center">Final Count</th><th class="p-3 text-center" data-sort-by="FinalDiff">Final Diff<span class="sort-indicator"></span></th><th class="p-3 text-left">Reason</th><th class="p-3 text-left">Remark</th></tr></thead>`;
                const body = `<tbody>${data.map(renderFinalReportRow).join('')}</tbody>`;
                container.innerHTML = `<table class="w-full text-sm">${headers}${body}</tbody></table>`;
                const sortingTh = container.querySelector(`th[data-sort-by="${state.finalReportSort.column}"]`);
                if (sortingTh) { sortingTh.querySelector('.sort-indicator').textContent = state.finalReportSort.direction === 'asc' ? '▲' : '▼'; }
            }

            function renderFinalReportRow(item) {
                const { rowClass, statusDotColor } = getRowVisuals(item.FinalDiff, item.isDemo);
                return `<tr class="border-b border-slate-200 ${rowClass}" data-sku="${item.SKU}"><td class="p-3 text-center"><span class="status-dot ${statusDotColor}"></span></td><td class="p-3 font-medium text-slate-800">${item.SKU}</td><td class="p-3 text-slate-600">${item.Description}</td><td class="p-3 text-center">${item.SOH}</td><td class="p-3 text-center w-24"><input type="number" value="${item.Recount}" class="w-full text-center p-1.5 border border-slate-300 rounded-md"/></td><td class="p-3 font-bold text-center">${item.FinalDiff > 0 ? '+' : ''}${item.FinalDiff}</td><td class="p-3 text-slate-600">${item.ReasonFinal || 'N/A'}</td><td class="p-3 w-40"><input type="text" value="${item.Remark || ''}" class="w-full p-1.5 border border-slate-300 rounded-md"/></td></tr>`;
            }

            function getRowVisuals(diff, isDemo = false) {
                if (diff === 0) return { rowClass: isDemo ? 'bg-sky-50' : 'bg-green-50', statusDotColor: isDemo ? 'bg-sky-500' : 'bg-green-500' };
                if (diff !== null) return { rowClass: diff > 0 ? 'bg-yellow-50' : 'bg-red-50', statusDotColor: 'bg-red-500' };
                return { rowClass: 'bg-white', statusDotColor: 'bg-gray-400' };
            }

            function updateTableRowVisuals(row, diff, isDemo = false) {
                const { rowClass, statusDotColor } = getRowVisuals(diff, isDemo);
                row.className = `border-b border-slate-200 ${rowClass}`;
                row.querySelector('.status-dot').className = `status-dot ${statusDotColor}`;
            }
            
            function updateFinalCount(sku, value) {
                const item = state.reconciledData.find(i => i.SKU === sku); if (!item) return;
                const newCount = value === '' ? 0 : parseInt(value, 10);
                item.Recount = isNaN(newCount) ? 0 : newCount;
                item.FinalDiff = item.Recount - item.SOH; item.ReasonFinal = 'Manual Edit';
                const row = getEl('final-report-table-container').querySelector(`tr[data-sku="${sku}"]`);
                if(row) {
                    row.cells[5].textContent = item.FinalDiff > 0 ? `+${item.FinalDiff}` : item.FinalDiff;
                    row.cells[6].textContent = item.ReasonFinal;
                    updateTableRowVisuals(row, item.FinalDiff, item.isDemo);
                }
                updateFinalReportSummary(); renderFinalReportCharts(); setUnsavedChanges(true);
            }

            function updateRemark(sku, value) {
                const item = state.reconciledData.find(i => i.SKU === sku); if (item) { item.Remark = value; setUnsavedChanges(true); }
            }

            function updateFinalReportSummary() {
                const summaryEl = getEl('final-summary');
                if (!state.reconciledData.length) { summaryEl.innerHTML = ''; return; }
                const summary = state.reconciledData.reduce((acc, item) => {
                    const diffCost = item.FinalDiff * item.Price;
                    if (item.FinalDiff > 0) { acc.overQty += item.FinalDiff; acc.overCost += diffCost; } 
                    else if (item.FinalDiff < 0) { acc.shortQty += item.FinalDiff; acc.shortCost += diffCost; }
                    acc.totalCountedQty += item.Recount; acc.totalCountedCost += item.Recount * item.Price;
                    return acc;
                }, { overQty: 0, overCost: 0, shortQty: 0, shortCost: 0, totalCountedQty: 0, totalCountedCost: 0 });
                finalSummaryData = summary; // Save for JSON export
                finalSummaryData.netDiffCost = summary.overCost + summary.shortCost;

                summaryEl.innerHTML = `<h4 class="font-semibold text-center mb-1 text-slate-700">Report Summary</h4><div class="grid grid-cols-2 gap-x-4"><div class="text-green-600"><strong>Over Qty:</strong> ${formatNumber(summary.overQty)}</div><div class="text-green-600"><strong>Over Cost:</strong> ${formatNumber(summary.overCost)}</div><div class="text-red-600"><strong>Short Qty:</strong> ${formatNumber(summary.shortQty)}</div><div class="text-red-600"><strong>Short Cost:</strong> ${formatNumber(summary.shortCost)}</div><div class="col-span-2 border-t pt-1 mt-1"></div><div class="text-blue-600"><strong>Total Counted Qty:</strong> ${formatNumber(summary.totalCountedQty)}</div><div class="text-blue-600"><strong>Total Counted Cost:</strong> ${formatNumber(summary.totalCountedCost)}</div><div class="font-bold col-span-2 border-t pt-1 mt-1"></div><div class="font-bold"><strong>Net Diff Qty:</strong> ${formatNumber(summary.overQty + summary.shortQty)}</div><div class="font-bold"><strong>Net Diff Cost:</strong> ${formatNumber(finalSummaryData.netDiffCost)}</div></div>`;
            }

            function renderFinalReportCharts() {
                if (!state.reconciledData.length) return;
                Object.values(state.charts).forEach(chart => chart?.destroy());
                const summary = state.reconciledData.reduce((acc, item) => {
                    if (item.FinalDiff > 0) { acc.overQty += item.FinalDiff; acc.overCost += item.FinalDiff * item.Price; } 
                    else if (item.FinalDiff < 0) { acc.shortQty += Math.abs(item.FinalDiff); acc.shortCost += Math.abs(item.FinalDiff * item.Price); }
                    if (item.FinalDiff !== 0) { const cat = item.CLASS_NAME || 'UNCATEGORIZED'; acc.byCategory[cat] = (acc.byCategory[cat] || 0) + item.FinalDiff; }
                    return acc;
                }, { overCost: 0, shortCost: 0, overQty: 0, shortQty: 0, byCategory: {} });
                const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } };
                state.charts.cost = new Chart(getEl('costChart'), { type: 'doughnut', data: { labels: ['Over', 'Short'], datasets: [{ data: [summary.overCost, summary.shortCost], backgroundColor: ['#22c55e', '#ef4444'] }] }, options: chartOptions });
                state.charts.qty = new Chart(getEl('qtyChart'), { type: 'doughnut', data: { labels: ['Over', 'Short'], datasets: [{ data: [summary.overQty, summary.shortQty], backgroundColor: ['#22c55e', '#ef4444'] }] }, options: chartOptions });
                const categoryData = Object.entries(summary.byCategory).sort(([,a],[,b]) => Math.abs(b) - Math.abs(a)).slice(0, 15);
                state.charts.category = new Chart(getEl('categoryChart'), { type: 'bar', data: { labels: categoryData.map(([name]) => name.substring(0, 15)), datasets: [{ label: 'Net Qty Difference', data: categoryData.map(([, qty]) => qty), backgroundColor: categoryData.map(([, qty]) => qty > 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'), }] }, options: { ...chartOptions, indexAxis: 'y', scales: { y: { beginAtZero: true } } } });
            }
            
            function exportFinalReport() {
                if (!state.reconciledData.length) return showModal("Info", "No data to export.");
                const dataToExport = state.reconciledData.map(item => ({ SKU: item.SKU, Description: item.Description, Age: item.Age, SRP: item.Price, SOH: item.SOH, Scan: item.Scan1, Recount: item.Recount, FinalDiff: item.FinalDiff, Remark: item.Remark || '', Reason: item.ReasonFinal, }));
                downloadFile(Papa.unparse(dataToExport, { header: true }), `${state.countDate}_${state.branchName.replace(/\s+/g, '_')}_Report.csv`);
            }

            function exportStockCountToJSON() {
                if (!state.reconciledData.length) {
                    alert('กรุณาประมวลผลข้อมูลให้ถึงขั้นตอนสุดท้ายก่อนทำการ Export');
                    return;
                }
                 const exportData = {
                    tool: 'stock-count',
                    details: {
                        branch: state.branchName,
                        date: state.countDate,
                    },
                    summary: finalSummaryData,
                    data: state.reconciledData.filter(item => item.FinalDiff !== 0)
                };
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Stock-Count_${state.branchName}_${state.countDate}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            let audioCtx;
            function playSound(type) {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (!audioCtx) return;
                const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
                if (type === 'success') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(600, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.05); } 
                else { oscillator.type = 'square'; oscillator.frequency.setValueAtTime(200, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); }
                oscillator.start(audioCtx.currentTime); oscillator.stop(audioCtx.currentTime + 0.15);
            }

            let currentScanner = 'barcode';
            
            const openScannerBtn = getEl('openScannerBtn');
            const closeScannerBtn = getEl('closeScannerBtn');
            const cameraViewBox = getEl('camera-view-box');
            const barcodeScannerTab = getEl('barcode-scanner-tab');
            const textScannerTab = getEl('text-scanner-tab');
            const barcodeScannerView = getEl('barcode-scanner-view');
            const textScannerView = getEl('text-scanner-view');
            const textScannerVideo = getEl('text-scanner-video');
            const captureBtn = getEl('capture-btn');
            const scannerResultsEl = getEl('scanner-results');
            
            const switchScannerTab = (mode) => {
                currentScanner = mode;
                if (mode === 'barcode') {
                    barcodeScannerTab.classList.add('active');
                    textScannerTab.classList.remove('active');
                    barcodeScannerView.classList.remove('hidden');
                    textScannerView.classList.add('hidden');
                    stopTextScanner();
                    stopOcrStreaming();
                    startBarcodeScanner();
                } else {
                    textScannerTab.classList.add('active');
                    barcodeScannerTab.classList.remove('active');
                    textScannerView.classList.remove('hidden');
                    barcodeScannerView.classList.add('hidden');
                    stopBarcodeScanner();
                    startTextScanner();
                    setTimeout(startOcrStreaming, 800); // Give camera time to start
                }
            };

            const startTextScanner = async () => {
                try {
                    if (activeStream) {
                        activeStream.getTracks().forEach(track => track.stop());
                    }
                    activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    textScannerVideo.srcObject = activeStream;
                    textScannerVideo.play();
                } catch (err) {
                    scannerResultsEl.innerHTML = `<p class="text-red-500">Camera error: ${err.message}</p>`;
                }
            };
            
            function stopTextScanner() {
                // Stop all video tracks from the video element, not just activeStream
                const video = document.getElementById('text-scanner-video');
                if (video && video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    video.srcObject = null;
                }
                activeStream = null;
            }
            
            const captureAndRecognize = async () => {
                if (!activeStream || !cvReady) {
                    scannerResultsEl.innerHTML = `<p class="text-red-500">Camera or OpenCV is not ready.</p>`;
                    return;
                };
                
                scannerResultsEl.innerHTML = `<p class="text-blue-500">กำลังประมวลผลตัวอักษร...</p>`;
                captureBtn.disabled = true;

                const video = textScannerVideo;
                const canvas = document.createElement('canvas');

                const cropHeightPercentage = 0.30;
                const sWidth = video.videoWidth;
                const sHeight = video.videoHeight * cropHeightPercentage;
                const sx = 0;
                const sy = video.videoHeight * ((1 - cropHeightPercentage) / 2);

                canvas.width = sWidth;
                canvas.height = sHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

                let src = cv.imread(canvas);
                let dst = new cv.Mat();
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
                cv.threshold(dst, dst, 0, 255, cv.THRESH_OTSU | cv.THRESH_BINARY_INV);
                cv.imshow(canvas, dst);
                src.delete();
                dst.delete();

                try {
                    const result = await Tesseract.recognize(canvas, 'eng', {
                        logger: m => {
                             if (m.status === 'recognizing text') {
                                scannerResultsEl.innerHTML = `<p class="text-blue-500">${m.status} (${(m.progress * 100).toFixed(0)}%)...</p>`;
                             }
                        },
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-',
                    });
                    
                    const recognizedText = result.data.text.trim().toUpperCase().replace(/\s/g, ''); // Remove all whitespace
                    if(recognizedText){
                         scannerResultsEl.innerHTML = `<p>Found text: ${recognizedText}</p>`;
                         processScannedCode(recognizedText, 'Text Scan');
                    } else {
                         scannerResultsEl.innerHTML = `<p class="text-red-500">ไม่พบตัวอักษรที่ชัดเจน</p>`;
                    }

                } catch (err) {
                     scannerResultsEl.innerHTML = `<p class="text-red-500">OCR Error: ${err.message}</p>`;
                } finally {
                    captureBtn.disabled = false;
                }
            };

            const startOcrStreaming = () => {
                if (ocrStreaming) return;
                ocrStreaming = true;
                scannerResultsEl.innerHTML = '<p class="text-blue-500">กำลังสแกนแบบเรียลไทม์...</p>';
                ocrStreamInterval = setInterval(processOcrFrame, 700); // every 700ms
            };

            const stopOcrStreaming = () => {
                ocrStreaming = false;
                if (ocrStreamInterval) clearInterval(ocrStreamInterval);
                ocrStreamInterval = null;
            };

            const processOcrFrame = async () => {
                if (!ocrStreaming || !activeStream || !cvReady) return;
                const video = textScannerVideo;
                if (video.readyState < 2) return;
                const canvas = document.createElement('canvas');
                // Crop to lower half, adjust as needed
                const cropY = video.videoHeight * 0.55;
                const cropHeight = video.videoHeight * 0.12;
                canvas.width = video.videoWidth;
                canvas.height = cropHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, cropY, video.videoWidth, cropHeight, 0, 0, video.videoWidth, cropHeight);
                let src = cv.imread(canvas);
                let dst = new cv.Mat();
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY, 0);
                cv.equalizeHist(dst, dst);
                cv.threshold(dst, dst, 0, 255, cv.THRESH_OTSU | cv.THRESH_BINARY_INV);
                cv.imshow(canvas, dst);
                src.delete();
                dst.delete();
                try {
                    const result = await Tesseract.recognize(canvas, 'eng', {
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                    });
                    const text = result.data.text.replace(/\s/g, '').toUpperCase();
                    const match = text.match(/[A-Z0-9]{12}/);
                    if (match) {
                        scannerResultsEl.innerHTML = `<p>Serial Number: <b>${match[0]}</b></p>`;
                        processScannedCode(match[0], 'Text Scan');
                        stopOcrStreaming(); // Stop after successful scan
                    } else {
                        scannerResultsEl.innerHTML = `<p class='text-blue-500'>Scanning... (No serial found yet)</p>`;
                    }
                } catch (err) {
                    scannerResultsEl.innerHTML = `<p class='text-red-500'>OCR Error: ${err.message}</p>`;
                }
            };

            const startBarcodeScanner = () => {
                 Quagga.init({ inputStream: { name: "Live", type: "LiveStream", target: getEl('qr-reader'), constraints: { facingMode: "environment" } }, decoder: { readers: [ "code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader", "upc_e_reader" ] }, locate: true }, (err) => { if (err) { scannerResultsEl.innerHTML = `<p class="text-red-500">Camera error: ${err.message}</p>`; return; } Quagga.start(); });
                 Quagga.onDetected(onBarcodeDetected);
            };
            
            function stopBarcodeScanner() {
                if (typeof Quagga !== 'undefined' && Quagga.running) {
                    Quagga.offDetected(onBarcodeDetected);
                    Quagga.stop();
                }
                // Extra cleanup: stop video tracks from Quagga's video element
                const quaggaVideo = document.querySelector('#qr-reader video');
                if (quaggaVideo && quaggaVideo.srcObject) {
                    quaggaVideo.srcObject.getTracks().forEach(track => track.stop());
                    quaggaVideo.srcObject = null;
                }
            }
            
            const openScannerModal = () => {
                cameraViewBox.classList.remove('hidden');
                switchScannerTab('barcode');
            };

            const closeScannerModal = () => {
                stopTextScanner(); // This will stop all video tracks and clear srcObject
                cameraViewBox.classList.add('hidden');
                stopBarcodeScanner();
                stopOcrStreaming();
                const quaggaVideo = document.querySelector('#qr-reader video');
                if (quaggaVideo && quaggaVideo.srcObject) {
                    quaggaVideo.srcObject.getTracks().forEach(track => track.stop());
                    quaggaVideo.srcObject = null;
                }
            };
            
            const processScannedCode = (code, reason) => {
                const sku = code.toUpperCase();
                // Try direct match
                let item = state.demoMaster.find(i => i.SKU === sku);
                // If not found, try with 'S' prefix
                if (!item) item = state.demoMaster.find(i => i.SKU === 'S' + sku);

                if (item) {
                    playSound('success');
                    let currentCount = typeof item.counted === 'number' ? item.counted : 0;
                    item.counted = currentCount + 1;
                    state.demoCounts[item.SKU] = { qty: item.counted, reason: reason };
                    applyDemoView();
                    const row = getEl('demo-count-container').querySelector(`tr[data-sku="${item.SKU}"]`);
                    if (row) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
                        setTimeout(() => row.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500'), 800);
                    }
                    const diff = item.counted - item.SOH;
                    let statusText = (diff === 0) ? 'Matched' : (diff > 0) ? 'Overage' : 'Shortage';
                    let statusColor = (diff === 0) ? 'text-green-600' : (diff > 0) ? 'text-yellow-600' : 'text-blue-600';
                    scannerResultsEl.innerHTML = `<div class="text-left w-full space-y-1"><p class="font-medium text-slate-800">${item.Description}</p><p class="text-sm text-slate-500">SKU: ${item.SKU}</p><div class="flex justify-between items-baseline pt-1"><span class="text-lg font-bold text-slate-700">Count: <span class="text-blue-600">${item.counted}</span> / ${item.SOH}</span><span class="text-lg font-bold ${statusColor}">${statusText}</span></div></div>`;
                } else {
                    playSound('error');
                    scannerResultsEl.innerHTML = `<div class="text-center w-full"><p class="font-bold text-red-600">SKU Not Found</p><p class="text-sm text-slate-500">${sku}</p></div>`;
                }
            };
            
            const scanCooldown = {};
            const onBarcodeDetected = (result) => {
                const code = result.codeResult.code.trim();
                const now = Date.now(); if (scanCooldown[code] && now - scanCooldown[code] < 2000) return;
                scanCooldown[code] = now;
                processScannedCode(code, 'Barcode');
            };
            
            function initializeAppListeners() {
                function addListener(id, event, handler) {
                    const el = getEl(id);
                    if (el) {
                        el.addEventListener(event, handler);
                    }
                }
                
                addListener('newJobButton', 'click', startNewJob);
                addListener('save-progress-button', 'click', handleSaveProgressToFile);
                addListener('main-tab-demo', 'click', () => switchMainTab('demo'));
                addListener('main-tab-workflow', 'click', () => switchMainTab('workflow'));
                addListener('downloadMasterForScan', 'click', downloadMasterForScan);
                addListener('processFirstCount', 'click', processFirstCount);
                addListener('finalizeFromFirstCount', 'click', finalizeFromFirstCount);
                addListener('generateRecountMasterFile', 'click', generateRecountMasterFile);
                addListener('processSecondCount', 'click', processSecondCount);
                addListener('exportCsvButton', 'click', exportFinalReport);
                addListener('exportJsonButton', 'click', exportStockCountToJSON);
                addListener('refreshChartsButton', 'click', renderFinalReportCharts);
                addListener('exportDemoCsvButton', 'click', exportDemoTable);
                addListener('openScannerBtn', 'click', openScannerModal);
                addListener('closeScannerBtn', 'click', closeScannerModal);
                addListener('print-final-report-btn', 'click', () => window.print());
                addListener('barcode-scanner-tab', 'click', () => switchScannerTab('barcode'));
                addListener('text-scanner-tab', 'click', () => switchScannerTab('text'));
                addListener('capture-btn', 'click', captureAndRecognize);

                addListener('demoSearchInput', 'keyup', applyDemoView);
                addListener('demoFilterSelect', 'change', applyDemoView);
                addListener('finalSearchInput', 'keyup', applyFinalReportView);
                addListener('finalFilterSelect', 'change', applyFinalReportView);
                addListener('load-progress-file', 'change', handleLoadProgressFromFile);
                addListener('initialSohFile', 'change', handleSohFileUpload);
                addListener('firstScanLogfile', 'change', () => getEl('processFirstCount').disabled = getEl('firstScanLogfile').files.length === 0);
                addListener('latestSohFile', 'change', handleLatestSohUpload);
                addListener('secondScanLogfile', 'change', () => getEl('secondScanLogfile').files.length === 0);

                addListener('wf-step-tabs', 'click', e => { if (e.target.id.startsWith('wf-tab-btn-')) changeWorkflowTab(e.target.id.slice(-1)); });
                addListener('demo-count-container', 'click', e => { const header = e.target.closest('th[data-sort-by]'); if (header) handleSort('demoSort', header.dataset.sortBy, applyViewFn); });
                addListener('demo-count-container', 'input', e => { if (e.target.matches('input[type="number"]')) updateDemoCount(e.target.closest('tr').dataset.sku, e.target.value); });
                addListener('final-report-table-container', 'click', e => { const header = e.target.closest('th[data-sort-by]'); if (header) handleSort('finalReportSort', header.dataset.sortBy, applyViewFn); });
                addListener('final-report-table-container', 'input', e => { const { target: input } = e; const sku = input.closest('tr').dataset.sku; if (input.matches('input[type="number"]')) updateFinalCount(sku, input.value); else if (input.matches('input[type="text"]')) updateRemark(sku, input.value); });
                
                const handleEnter = (event) => { if (event.key === 'Enter') { const allInputs = Array.from(event.currentTarget.querySelectorAll('input[type="number"], input[type="text"]')); const currentIndex = allInputs.indexOf(event.target); if (currentIndex > -1 && currentIndex < allInputs.length - 1) allInputs[currentIndex + 1].focus(); } };
                addListener('demo-count-container', 'keydown', handleEnter);
                addListener('final-report-table-container', 'keydown', handleEnter);
                window.addEventListener('beforeunload', (e) => { if (hasUnsavedChanges) e.preventDefault(); });
            }
            
            initializeAppListeners();
        });
    </script>
</body>
</html>
